module.exports = (function() {
var __MODS__ = {};
var __DEFINE__ = function(modId, func, req) { var m = { exports: {}, _tempexports: {} }; __MODS__[modId] = { status: 0, func: func, req: req, m: m }; };
var __REQUIRE__ = function(modId, source) { if(!__MODS__[modId]) return require(source); if(!__MODS__[modId].status) { var m = __MODS__[modId].m; m._exports = m._tempexports; var desp = Object.getOwnPropertyDescriptor(m, "exports"); if (desp && desp.configurable) Object.defineProperty(m, "exports", { set: function (val) { if(typeof val === "object" && val !== m._exports) { m._exports.__proto__ = val.__proto__; Object.keys(val).forEach(function (k) { m._exports[k] = val[k]; }); } m._tempexports = val }, get: function () { return m._tempexports; } }); __MODS__[modId].status = 1; __MODS__[modId].func(__MODS__[modId].req, m, m.exports); } return __MODS__[modId].m.exports; };
var __REQUIRE_WILDCARD__ = function(obj) { if(obj && obj.__esModule) { return obj; } else { var newObj = {}; if(obj != null) { for(var k in obj) { if (Object.prototype.hasOwnProperty.call(obj, k)) newObj[k] = obj[k]; } } newObj.default = obj; return newObj; } };
var __REQUIRE_DEFAULT__ = function(obj) { return obj && obj.__esModule ? obj.default : obj; };
__DEFINE__(1666529690826, function(require, module, exports) {
Object.defineProperty(exports,"__esModule",{value:!0}),exports.blueToothHelper=void 0;var tslib_1=require("tslib"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),_a=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils,arrayBufferToHexStringArray=_a.arrayBufferToHexStringArray,hexToArrayBuffer=_a.hexToArrayBuffer,hexToStr=_a.hexToStr;tslib_1.__exportStar(require("./base"),exports),tslib_1.__exportStar(require("./h5"),exports),tslib_1.__exportStar(require("./miniprogram"),exports),exports.blueToothHelper={hexToArrayBuffer:hexToArrayBuffer,arrayBufferToHexStringArray:arrayBufferToHexStringArray,hexToStr:hexToStr};
//# sourceMappingURL=index.js.map
}, function(modId) {var map = {"./base":1666529690827,"./h5":1666529690836,"./miniprogram":1666529690840}; return __REQUIRE__(map[modId], modId); })
__DEFINE__(1666529690827, function(require, module, exports) {
Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib");tslib_1.__exportStar(require("./BlueToothAdapter"),exports),tslib_1.__exportStar(require("./DeviceAdapter"),exports);var nativeBluetoothApi_1=require("./nativeBluetoothApi");Object.defineProperty(exports,"nativeBluetoothApi",{enumerable:!0,get:function(){return nativeBluetoothApi_1.default}}),tslib_1.__exportStar(require("./types"),exports);
//# sourceMappingURL=index.js.map
}, function(modId) { var map = {"./BlueToothAdapter":1666529690828,"./DeviceAdapter":1666529690830,"./nativeBluetoothApi":1666529690832,"./types":1666529690831}; return __REQUIRE__(map[modId], modId); })
__DEFINE__(1666529690828, function(require, module, exports) {
Object.defineProperty(exports,"__esModule",{value:!0}),exports.BlueToothAdapter=void 0;var tslib_1=require("tslib"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),lodash_uniqwith_1=tslib_1.__importDefault(require("lodash.uniqwith")),BlueToothBase_1=require("./BlueToothBase"),DeviceAdapter_1=require("./DeviceAdapter"),nativeBluetoothApi_1=tslib_1.__importDefault(require("./nativeBluetoothApi")),BluetoothDeviceCacheManager_1=require("./BluetoothDeviceCacheManager"),SimpleStore_1=require("../libs/SimpleStore"),qcloud_iotexplorer_common_libs_1=require("qcloud-iotexplorer-common-libs"),throttle_1=require("../libs/throttle"),types_1=require("./types"),_a=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils,isEmpty=_a.isEmpty,noop=_a.noop,delay=_a.delay,DefaultOnDeviceFoundThrottle=300,BlueToothAdapter=function(e){function t(t){var i=t.deviceAdapters,r=void 0===i?[]:i,o=t.actions,n=t.bluetoothApi,c=t.h5Websocket,s=t.devMode,a=t.ignoreAnonymousDevices,d=void 0===a||a,u=t.mpDisableRefreshCache,l=void 0!==u&&u,v=e.call(this)||this;return v._devMode=!1,v._ignoreAnonymousDevices=!0,v._bluetoothApi={},v._actions={},v._deviceAdapterFactoryMap={},v._productIdMap={},v._inited=!1,v._available=!1,v._discovering=!1,v._onBluetoothDeviceFoundHandler=null,v._onDeviceFoundThrottle=DefaultOnDeviceFoundThrottle,v._setOnDeviceFoundThrottle=noop,v._onBluetoothScanAdvertisingHandler=null,v._initPromise=null,v._searchDevicePromise=null,v._deviceAdapterStore=new SimpleStore_1.SimpleStore({filter:function(e){return function(t){return t.deviceId===e.deviceId||t.explorerDeviceId===e.explorerDeviceId}}}),v._deviceConnectStatusStore=new SimpleStore_1.SimpleStore({filter:function(e){return function(t){return t.deviceId===e.deviceId||t.explorerDeviceId===e.explorerDeviceId}}}),v._initPeripheralServerPromise=null,v._mpDisableRefreshCache=!1,v._devMode=s,v.addAdapter(r),isEmpty(v._deviceAdapterFactoryMap)&&console.warn("无合法的deviceAdapter"),v._ignoreAnonymousDevices=d,v._h5Websocket=c,v._bluetoothApi=n||nativeBluetoothApi_1.default,v._actions=o||{},v.deviceCacheManager=new BluetoothDeviceCacheManager_1.BluetoothDeviceCacheManager,v._mpDisableRefreshCache=l,v}return tslib_1.__extends(t,e),Object.defineProperty(t.prototype,"devMode",{get:function(){return"function"==typeof this._devMode?this._devMode():this._devMode},enumerable:!1,configurable:!0}),t.prototype.addAdapter=function(e,t){var i=this;void 0===t&&(t=!1);var r=function(e){t||Object.prototype.isPrototypeOf.call(DeviceAdapter_1.DeviceAdapter,e)?e.serviceId?i._deviceAdapterFactoryMap[e.serviceId]=e:console.error("非法的设备适配器，未配置serviceId",e):console.error("非法的设备适配器",e)};(null==e?void 0:e.splice)?e.forEach(r):r(e)},t.prototype._filterDevices=function(e){var t,i=this,r=e.deviceId,o=e.devices,n=void 0===o?[]:o,c=e.serviceIds,s=e.deviceName,a=void 0===s?"":s,d=e.productId,u=e.ignoreDeviceIds,l=void 0===u?[]:u,v=e.ignoreServiceIds,h=void 0===v?[]:v,p=e.extendInfo,_=void 0===p?{}:p,f=e.DeviceAdapter;if(f)c=[f.serviceId],t=[f.deviceFilter],console.log("specific serviceId: ",c);else{c&&c.length||(c=this._getSupportServiceIds());var D={};(null==h?void 0:h.length)&&(h.forEach((function(e){return D[e]=!0})),c=c.filter((function(e){return!D[e]}))),t=c.map((function(e){return i._deviceAdapterFactoryMap[e].deviceFilter})),console.log("support serviceIds",c)}for(var g=[],I=function(e,i){if(r&&n[e].deviceId!==r)return"continue";if(l.find((function(t){return n[e].deviceId===t})))return"continue";for(var o=void 0,s=0,u=t.length;s<u;s++)if(o=t[s](n[e],{serviceIds:c,deviceName:a,productId:d,ignoreDeviceIds:l,ignoreServiceIds:h,extendInfo:_}),a){if(o&&o.deviceName===a)return{value:[o]}}else if(o){g.push(o);break}},b=0,A=n.length;b<A;b++){var m=I(b);if("object"==typeof m)return m.value}return g},t.prototype._getSupportServiceIds=function(){return Object.keys(this._deviceAdapterFactoryMap)},t.prototype.setOnDeviceFoundThrottle=function(e){this._onDeviceFoundThrottle=e,this._setOnDeviceFoundThrottle(e)},t.prototype.resetOnDeviceFoundThrottle=function(){this._onDeviceFoundThrottle=DefaultOnDeviceFoundThrottle,this._setOnDeviceFoundThrottle(DefaultOnDeviceFoundThrottle)},t.prototype.onDeviceConnectStatusChange=function(e){var t=e.connected,i=e.explorerDeviceId,r=e.deviceId;console.log("onDeviceConnectStatusChange",{connected:t,explorerDeviceId:i,deviceId:r});var o=this._deviceConnectStatusStore.get({connected:t,explorerDeviceId:i});o?o.connected!==t&&(console.log("device connect status did change",{connected:t,explorerDeviceId:i,deviceId:r}),o.connected=t,this.emit("onDeviceConnectStatusChange",{connected:t,explorerDeviceId:i,deviceId:r})):(this._deviceConnectStatusStore.set({connected:t,explorerDeviceId:i,deviceId:r}),console.log("new device connected",this._deviceConnectStatusStore.getAll()),this.emit("onDeviceConnectStatusChange",{connected:t,explorerDeviceId:i,deviceId:r}))},t.prototype.startBluetoothDevicesDiscovery=function(e){if(!this._discovering)return this._bluetoothApi.startBluetoothDevicesDiscovery(tslib_1.__assign(tslib_1.__assign({powerLevel:"high"},e),{allowDuplicatesKey:!0}))},t.prototype.stopBluetoothDevicesDiscovery=function(){return this._bluetoothApi.stopBluetoothDevicesDiscovery()},t.prototype.cleanup=function(t){e.prototype.cleanup.call(this,t),t||(console.log("cleanup bluetooth adapter"),this._discovering&&this.stopBluetoothDevicesDiscovery(),this._bluetoothApi.closeBluetoothAdapter(),console.log("manually disconnect all device",this._deviceAdapterStore.getAll()),this._deviceAdapterStore.getAll().forEach((function(e){e.isConnected&&e.disconnectDevice()})))},t.prototype.init=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var e=this;return tslib_1.__generator(this,(function(t){return[2,this._initPromise||(this._initPromise=new Promise((function(t,i){return tslib_1.__awaiter(e,void 0,void 0,(function(){var e,r,o,n,c,s,a,d=this;return tslib_1.__generator(this,(function(u){switch(u.label){case 0:if(u.trys.push([0,4,,5]),this._inited){if(this._available)return this._initPromise=null,[2,t()];throw{errCode:10001}}return[4,Promise.all([this.deviceCacheManager.init(),this.initProductIds()])];case 1:return u.sent(),e=function(e){var i=e.available,r=e.discovering;return tslib_1.__awaiter(d,void 0,void 0,(function(){var e,o,n=this;return tslib_1.__generator(this,(function(c){switch(c.label){case 0:return console.log("onBluetoothAdapterStateChange",{available:i,discovering:r}),this._available=i,this._discovering=r,this.emit("adapterStateChange",{available:i,discovering:r}),i?(this._inited=!0,t(),this._initPromise=null,[3,5]):[3,1];case 1:return c.trys.push([1,3,,4]),[4,this._bluetoothApi.getSystemInfo()];case 2:return(null==(e=c.sent())?void 0:e.platform)&&e.platform.toLowerCase().indexOf("android")>-1&&this._deviceAdapterStore.getAll().forEach((function(e){e.isConnected&&(console.log("trigger onBleConnectionStateChange manually"),n.onBleConnectionStateChange({deviceId:e.deviceId,connected:!1}))})),[3,4];case 3:return o=c.sent(),console.error("trigger onBleConnectionStateChange manually error",o),[3,4];case 4:this.cleanup(),c.label=5;case 5:return[2]}}))}))},r=function(e){return d.onBleConnectionStateChange(e)},o=function(e){return d.onBLECharacteristicValueChange(e)},n=throttle_1.throttle(this._onDeviceFoundThrottle,(function(e){return d.onBluetoothDeviceFound(e)})),this._setOnDeviceFoundThrottle=function(e){n.updateDelay(e)},c={mode:"central"},this._mpDisableRefreshCache&&Object.assign(c,{refreshCache:!1}),[4,this._bluetoothApi.openBluetoothAdapter(c)];case 2:return u.sent(),this._bluetoothApi.onBluetoothAdapterStateChange(e),this._bluetoothApi.onBLEConnectionStateChange(r),this._bluetoothApi.onBLECharacteristicValueChange(o),this._bluetoothApi.onBluetoothDeviceFound(n),this.addCleanupTask("init",(function(){d._available=d._discovering=d._inited=!1,d._initPromise=null,d._bluetoothApi.offBluetoothAdapterStateChange(e),d._bluetoothApi.offBLEConnectionStateChange(r),d._bluetoothApi.offBLECharacteristicValueChange(o),d._bluetoothApi.offBluetoothDeviceFound(n),d._bluetoothApi.closeBluetoothAdapter()})),s=e,[4,this._bluetoothApi.getBluetoothAdapterState()];case 3:return s.apply(void 0,[u.sent()]),[3,5];case 4:return a=u.sent(),this._available=!1,this._inited=!1,this._initPromise=null,i(this._normalizeError(a)),[3,5];case 5:return[2]}}))}))})))]}))}))},t.prototype.initProductIds=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var e;return tslib_1.__generator(this,(function(t){switch(t.label){case 0:return"function"!=typeof this._actions.initProductIds?[3,2]:(e=this,[4,this._actions.initProductIds()]);case 1:e._productIdMap=t.sent(),t.label=2;case 2:return[2]}}))}))},t.prototype.onBleConnectionStateChange=function(e){var t=e.deviceId,i=e.connected;console.log("onBLEConnectionStateChange",t,i);var r=this.getDeviceAdapter(t);r?r.onBleConnectionStateChange({connected:i}):console.warn("on bLEConnectionStateChange, but no adapter")},t.prototype.onBLECharacteristicValueChange=function(e){var t=e.deviceId,i=e.serviceId,r=e.characteristicId,o=e.value;console.log("onBLECharacteristicValueChange",t,i,r,o);var n=this.getDeviceAdapter({deviceId:t});if(n)return n.onBLECharacteristicValueChange({serviceId:i,characteristicId:r,value:o});console.warn("on onBLECharacteristicValueChange, but no adapter")},t.prototype.getBluetoothDevices=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var e;return tslib_1.__generator(this,(function(t){switch(t.label){case 0:return[4,this._bluetoothApi.getBluetoothDevices()];case 1:return e=t.sent().devices,[2,this._ignoreAnonymousDevices?e.filter((function(e){return"未知设备"!==e.name})):e]}}))}))},t.prototype.onBluetoothDeviceFound=function(e){return tslib_1.__awaiter(this,void 0,void 0,(function(){var t,i;return tslib_1.__generator(this,(function(r){switch(r.label){case 0:t=(null==e?void 0:e.devices)||[];try{"function"==typeof this._onBluetoothScanAdvertisingHandler&&this._onBluetoothScanAdvertisingHandler(t)}catch(e){console.error("_onBluetoothScanAdvertisingHandler error",e)}return[4,this.getBluetoothDevices()];case 1:i=r.sent();try{console.log("onBluetoothDeviceFound",t,i),"function"==typeof this._onBluetoothDeviceFoundHandler&&this._onBluetoothDeviceFoundHandler(i,t)}catch(e){console.error("_onBluetoothDeviceFoundHandler error",e)}return[2,i]}}))}))},t.prototype.startSearch=function(e){var t=e.serviceId,i=e.serviceIds,r=e.ignoreDeviceIds,o=void 0===r?[]:r,n=e.ignoreServiceIds,c=void 0===n?[]:n,s=e.onSearch,a=void 0===s?noop:s,d=e.onError,u=void 0===d?noop:d,l=e.timeout,v=void 0===l?2e4:l,h=e.extendInfo,p=void 0===h?{}:h,_=e.DeviceAdapter,f=e.startBluetoothDevicesDiscoveryParams;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,r,n,s,d,l,h=this;return tslib_1.__generator(this,(function(D){switch(D.label){case 0:return[4,this.init()];case 1:D.sent(),t&&!i&&(i=[t]),e=0,r=[],n=function(e){var t={};return e.forEach((function(e){return t[e.deviceId]=e})),r.forEach((function(e){e.isFromCacheBroadcast=!t[e.deviceId]})),r=lodash_uniqwith_1.default(tslib_1.__spread(r,e),(function(e,t){return e.deviceId===t.deviceId}))},s=function(e){h.stopSearch(),u(e)},D.label=2;case 2:return D.trys.push([2,4,,5]),[4,this.startBluetoothDevicesDiscovery(f)];case 3:return D.sent(),this._onBluetoothDeviceFoundHandler=function(t){try{var r=n(h._filterDevices({devices:t,serviceIds:i,ignoreDeviceIds:o,ignoreServiceIds:c,extendInfo:p,DeviceAdapter:_}));e=r.length,a(r)}catch(e){console.log("onSearch error",e),s(h._normalizeError(e))}},this.onBluetoothDeviceFound(),d=function(e){e.available||s(h._normalizeError({errCode:10001}))},this.on("adapterStateChange",d),this.addCleanupTask("startSearch",(function(){h._onBluetoothDeviceFoundHandler=null,h.off("adapterStateChange",d)})),setTimeout((function(){e||s("未发现设备，请确认设备已开启")}),v),[3,5];case 4:throw l=D.sent(),this.cleanup("startSearch"),this._normalizeError(l);case 5:return[2]}}))}))},t.prototype.stopSearch=function(){this.cleanup("startSearch"),this.stopBluetoothDevicesDiscovery()},t.prototype.searchDevice=function(e){var t=e.deviceId,i=e.serviceId,r=e.serviceIds,o=e.deviceName,n=e.productId,c=e.ignoreDeviceIds,s=void 0===c?[]:c,a=e.timeout,d=void 0===a?5e3:a,u=e.extendInfo,l=void 0===u?{}:u,v=e.ignoreWarning,h=void 0!==v&&v,p=e.ignoreCache,_=e.disableCache,f=e.DeviceAdapter,D=e.startBluetoothDevicesDiscoveryParams,g=e.useCacheFoundDevices,I=void 0===g||g;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,c=this;return tslib_1.__generator(this,(function(a){switch(a.label){case 0:return h||console.warn("[DEPRECATED] searchDevice + connectDevice 的方式连接设备已废弃，请直接使用 searchAndConnectDevice 方法，会自动处理连接缓存已经失效重搜等逻辑。"),void 0===_&&void 0!==p&&(_=p),[4,this.init()];case 1:return a.sent(),i&&!r&&(r=[i]),console.log("searching for explorerDeviceId => ",o),!_&&(e=this.deviceCacheManager.getDeviceCache(o))?(console.log("find ble deviceInfo from cache for "+o,tslib_1.__assign({deviceName:o,productId:n},e)),[2,Promise.resolve(tslib_1.__assign({deviceName:o,productId:n},e))]):[2,this._searchDevicePromise||(this._searchDevicePromise=new Promise((function(e,i){return tslib_1.__awaiter(c,void 0,void 0,(function(){var c,a,u,v=this;return tslib_1.__generator(this,(function(h){switch(h.label){case 0:c=function(e){v.stopBluetoothDevicesDiscovery(),i(v._normalizeError(e)),v._searchDevicePromise=null,v._onBluetoothDeviceFoundHandler=null},a=function(t){v.stopBluetoothDevicesDiscovery(),e(t),v._searchDevicePromise=null,v._onBluetoothDeviceFoundHandler=null},this._onBluetoothDeviceFoundHandler=function(e,i){try{var d=v._filterDevices({deviceId:t,devices:I?e:i,serviceIds:r,deviceName:o,productId:n,ignoreDeviceIds:s,extendInfo:l,DeviceAdapter:f});console.log("matchedDevices: ",d),d.length>0&&(console.log("doFindDevice",d[0]),a(d[0]))}catch(e){c(e)}},this.addCleanupTask("startSearchDevice",(function(){a(null),v.removeCleanupTask("startSearchDevice")})),h.label=1;case 1:return h.trys.push([1,3,,4]),[4,this.startBluetoothDevicesDiscovery(D)];case 2:return h.sent(),console.log("startBluetoothDevicesDiscovery succ"),this.onBluetoothDeviceFound(),setTimeout((function(){a(null)}),d),[3,4];case 3:return u=h.sent(),c(u),[3,4];case 4:return[2]}}))}))})))]}}))}))},t.prototype.stopSearchDevice=function(){this.stopBluetoothDevicesDiscovery(),this.cleanup("startSearchDevice")},t.prototype.getDeviceAdapter=function(e){var t,i;if(!e)throw"非法的参数，请传入 { deviceId?: string; explorerDeviceId?: string }";return"string"==typeof e?t=e:(t=e.deviceId,i=e.explorerDeviceId),this._deviceAdapterStore.get({deviceId:t,explorerDeviceId:i})},t.prototype.instantiateDeviceAdapter=function(e,t){var i,r,o=this,n=e.deviceId,c=e.serviceId,s=e.deviceName,a=e.name,d=e.productId,u=e.extendInfo,l=void 0===t?{}:t,v=l.DeviceAdapter,h=l.reuseAdapterInstance;if(v){if(v.serviceId!==c)throw"指定的DeviceAdapter serviceId 不匹配，"+v.serviceId+" !== "+c;i=v}else if(!(i=this._deviceAdapterFactoryMap[c]))throw"无匹配serviceId为"+c+"的 deviceAdapter";return h&&(n||d&&s)&&(r=this.getDeviceAdapter({deviceId:n,explorerDeviceId:d+"/"+s})),r||(r=new i({deviceId:n,deviceName:s,productId:d,name:a,actions:this._actions,bluetoothApi:this._bluetoothApi,h5Websocket:this._h5Websocket,extendInfo:u,bluetoothAdapter:this}),this._deviceAdapterStore.set(r),r.on("connect",(function(){r._deviceConnected=!0,o.onDeviceConnectStatusChange({explorerDeviceId:r.explorerDeviceId,connected:!0,deviceId:n})})).on("disconnect",(function(){r._deviceConnected=!1,o.onDeviceConnectStatusChange({explorerDeviceId:r.explorerDeviceId,connected:!1,deviceId:n})})).on("destroy",(function(){console.log("destroy adapter",r),o._deviceAdapterStore.remove({deviceId:n})})),this.emit("deviceAdapterInstantiate",r)),r},t.prototype.connectDevice=function(e,t){var i=e.deviceId,r=e.serviceId,o=e.mac,n=e.deviceName,c=e.name,s=e.productId,a=e.extendInfo,d=void 0===t?{}:t,u=d.DeviceAdapter,l=d.autoNotify,v=d.enableDeviceCache,h=void 0===v||v,p=d.destroyAdapterAfterDisconnect,_=d.disableCache,f=d.reuseAdapterInstance,D=void 0===f||f;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,t;return tslib_1.__generator(this,(function(d){switch(d.label){case 0:return d.trys.push([0,3,,4]),void 0===_&&void 0!==h&&(_=!h),[4,this.init()];case 1:return d.sent(),o&&console.warn("[DEPRECATED] mac is deprecated, please use deviceName instead."),void 0!==p&&console.warn("[DEPRECATED] destroyAdapterAfterDisconnect 参数已废弃，默认 deviceAdapter 创建后不会被销毁，如需手动销毁请调用 deviceAdapter.destroy()"),n=n||o,s=s||this._productIdMap[r],(null==(e=this.instantiateDeviceAdapter({deviceId:i,serviceId:r,deviceName:n,name:c,productId:s,extendInfo:a},{DeviceAdapter:u,reuseAdapterInstance:D}))?void 0:e.isConnected)?(console.log("device already connected, returning adapter",e),[2,e]):[4,e.connectDevice({autoNotify:l})];case 2:return d.sent(),!_&&n&&this.deviceCacheManager.setDeviceCache(n,{deviceId:i,serviceId:r,name:c,deviceName:n,productId:s,extendInfo:a}),console.log("deviceConnected"),[2,e];case 3:return t=d.sent(),[2,Promise.reject(t)];case 4:return[2]}}))}))},t.prototype.connectAdvertisingDevice=function(e,t){void 0===t&&(t={});var i=e.deviceId,r=e.deviceName,o=e.productId,n=tslib_1.__rest(e,["deviceId","deviceName","productId"]);return i||(i=o+"/"+r),this.connectDevice(tslib_1.__assign({deviceId:i,deviceName:r,productId:o},n),tslib_1.__assign(tslib_1.__assign({},t),{autoNotify:!1}))},t.prototype.searchAndConnectDevice=function(e,t){var i=e.deviceId,r=e.serviceId,o=e.serviceIds,n=e.deviceName,c=e.productId,s=e.ignoreDeviceIds,a=void 0===s?[]:s,d=e.timeout,u=void 0===d?5e3:d,l=e.extendInfo,v=void 0===l?{}:l,h=void 0===t?{}:t,p=h.autoNotify,_=h.disableCache,f=void 0!==_&&_,D=h.DeviceAdapter;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,t,s;return tslib_1.__generator(this,(function(d){switch(d.label){case 0:return d.trys.push([0,7,,8]),e=void 0,!f&&c&&n&&(e=this._deviceAdapterStore.get({explorerDeviceId:c+"/"+n})),e?(console.log("find deviceAdapter in cache, explorerDeviceId: ",c+"/"+n,e),e.isConnected?[3,2]:[4,e.connectDevice({autoNotify:p})]):[3,3];case 1:d.sent(),d.label=2;case 2:return[2,e];case 3:return[4,this.searchDevice({deviceId:i,serviceId:r,serviceIds:o,deviceName:n,productId:c,ignoreDeviceIds:a,timeout:u,extendInfo:v,ignoreWarning:!0,disableCache:f,DeviceAdapter:D})];case 4:return(t=d.sent())?(!t.productId&&c&&(t.productId=c),console.log("deviceInfo",t,c),[4,this.connectDevice(t,{autoNotify:p,disableCache:f,DeviceAdapter:D})]):[2,Promise.reject({code:"DeviceNotFound"})];case 5:return[2,e=d.sent()];case 6:return[3,8];case 7:return s=d.sent(),console.error("searchAndConnectDevice error",s),[2,Promise.reject(s)];case 8:return[2]}}))}))},t.prototype.startScanAdvert=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var e=this;return tslib_1.__generator(this,(function(t){switch(t.label){case 0:return[4,this.init()];case 1:return t.sent(),this._onBluetoothScanAdvertisingHandler||(this._onBluetoothScanAdvertisingHandler=function(t){void 0===t&&(t=[]);var i=e._deviceAdapterStore.getAll().filter((function(e){return e.isConnected&&e.communicationMode===types_1.CommunicationMode.ADVERT}));i.length<=0||t.forEach((function(e){var t,r=i.find((function(t){return t.deviceId===e.deviceId}));if(r){console.log("get matchAdapter on deviceId");try{"function"==typeof r.advertFilter&&(t=r.advertFilter(e))}catch(e){return void console.error("deviceAdapters advertFilter error",e)}}else for(var o=0;o<i.length;o++)try{if("function"==typeof i[o].advertFilter&&(t=i[o].advertFilter(e)),t){r=i[o];break}}catch(e){console.error("deviceAdapters advertFilter error",e)}if(t&&r)try{"function"==typeof r.onScanAdvert&&r.onScanAdvert(t)}catch(e){console.error("deviceAdapters onScanAdvert error",e)}}))},this.addCleanupTask("startScanAdvert",(function(){console.log("startScanAdvert clean up"),e._onBluetoothScanAdvertisingHandler=null}))),[4,this.startBluetoothDevicesDiscovery()];case 2:return t.sent(),[2]}}))}))},t.prototype.stopScanAdvert=function(){this.cleanup("startScanAdvert"),this.stopBluetoothDevicesDiscovery()},t.prototype._initPeripheralServer=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var e=this;return tslib_1.__generator(this,(function(t){switch(t.label){case 0:return[4,this.init()];case 1:return t.sent(),[2,this._initPeripheralServerPromise||(this._initPeripheralServerPromise=new Promise((function(t,i){return tslib_1.__awaiter(e,void 0,void 0,(function(){var e,r,o=this;return tslib_1.__generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),this._advertisingQueue=new qcloud_iotexplorer_common_libs_1.SimpleQueue({autoStart:!0,handler:function(e){var t=e.businessData;return tslib_1.__awaiter(o,void 0,void 0,(function(){var e,i,r,o,n,c;return tslib_1.__generator(this,(function(s){switch(s.label){case 0:if(e=t.deviceId,i=t.explorerDeviceId,r=t.duration,o=t.advertiseRequest,n=t.powerLevel,!(c=this.getDeviceAdapter({deviceId:e,explorerDeviceId:i})))throw"deviceAdapter not existed in advertising";if(!c.isConnected)throw'status "isConnected" in deviceAdapter is false, reject advertising; wx deviceId: '+e;return[4,this._blePeripheralServer.startAdvertising({powerLevel:n,advertiseRequest:tslib_1.__assign(tslib_1.__assign({},o),{connectable:!1})})];case 1:return s.sent(),[4,delay(r)];case 2:return s.sent(),[4,this._blePeripheralServer.stopAdvertising()];case 3:return s.sent(),[2]}}))}))},onTaskSuccess:function(e){var t=e.businessData;return"function"==typeof t.onSuccess&&t.onSuccess()},onTaskError:function(e,t){var i=t.businessData;return"function"==typeof i.onError&&i.onError(e)}}),[4,this._bluetoothApi.openBluetoothAdapter({mode:"peripheral"})];case 1:return n.sent(),e=this,[4,this._bluetoothApi.createBLEPeripheralServer()];case 2:return e._blePeripheralServer=n.sent(),this.addCleanupTask("initPeripheralServer",(function(){return tslib_1.__awaiter(o,void 0,void 0,(function(){var e;return tslib_1.__generator(this,(function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),console.log("initPeripheralServer clean up"),this._initPeripheralServerPromise=null,this._advertisingQueue&&(this._advertisingQueue.stop(),this._advertisingQueue=null),this._blePeripheralServer?[4,this._blePeripheralServer.close()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[3,4];case 3:return e=t.sent(),console.error("clean up initPeripheralServer error",e),[3,4];case 4:return this._blePeripheralServer=null,[2]}}))}))})),console.log("init blePeripheralServer success"),t(),[3,4];case 3:return r=n.sent(),this._initPeripheralServerPromise=null,i(this._normalizeError(r)),console.error("initPeripheralServer error",r),[3,4];case 4:return[2]}}))}))})))]}}))}))},t.prototype.advertising=function(e){var t=e.deviceId,i=e.explorerDeviceId,r=e.powerLevel,o=void 0===r?"medium":r,n=e.advertiseRequest,c=e.duration,s=void 0===c?100:c,a=e.onSuccess,d=e.onError;return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return[4,this._initPeripheralServer()];case 1:return e.sent(),s=Math.min(s,3e3),this._advertisingQueue.start(),[2,this._advertisingQueue.push({deviceId:t,explorerDeviceId:i,powerLevel:o,advertiseRequest:n,duration:s,onSuccess:a,onError:d})]}}))}))},t.prototype.stopAdvertising=function(){if(this._advertisingQueue)return this._advertisingQueue.stop()},t}(BlueToothBase_1.BlueToothBase);exports.BlueToothAdapter=BlueToothAdapter;
//# sourceMappingURL=BlueToothAdapter.js.map
}, function(modId) { var map = {"./BlueToothBase":1666529690829,"./DeviceAdapter":1666529690830,"./nativeBluetoothApi":1666529690832,"./BluetoothDeviceCacheManager":1666529690833,"../libs/SimpleStore":1666529690834,"../libs/throttle":1666529690835,"./types":1666529690831}; return __REQUIRE__(map[modId], modId); })
__DEFINE__(1666529690829, function(require, module, exports) {
Object.defineProperty(exports,"__esModule",{value:!0}),exports.BlueToothBase=void 0;var tslib_1=require("tslib"),event_emitter_for_miniprogram_1=tslib_1.__importDefault(require("event-emitter-for-miniprogram")),errorMap={1e4:"未初始化蓝牙适配器",10001:"当前蓝牙适配器不可用",10002:"没有找到指定设备",10003:"无法连接，请将手机尽量靠近设备",10004:"没有找到指定服务",10005:"没有找到指定特征值",10006:"当前连接已断开",10007:"当前特征值不支持此操作",10008:"其余所有系统上报的异常",10009:"安卓版本过低，不支持低功耗蓝牙",10012:"连接超时，请将手机尽量靠近设备",10013:"连接 deviceId 为空或者是格式不正确"},BlueToothBase=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._cleanupMap={},t}return tslib_1.__extends(t,e),t.prototype._normalizeError=function(e){return(null==e?void 0:e.errCode)&&Object.assign(e,{code:e.errCode,msg:errorMap[e.errCode]}),e},t.prototype.cleanup=function(e){if(e)this._cleanupMap[e]&&"function"==typeof this._cleanupMap[e]?(console.log("clean up for action: ",e),this._cleanupMap[e]()):console.warn("clean up invalid action",e,this._cleanupMap);else for(var t in this._cleanupMap)"function"==typeof this._cleanupMap[t]&&this._cleanupMap[t]()},t.prototype.addCleanupTask=function(e,t){this._cleanupMap[e]=t},t.prototype.removeCleanupTask=function(e){this._cleanupMap[e]=null},t}(event_emitter_for_miniprogram_1.default);exports.BlueToothBase=BlueToothBase;
//# sourceMappingURL=BlueToothBase.js.map
}, function(modId) { var map = {}; return __REQUIRE__(map[modId], modId); })
__DEFINE__(1666529690830, function(require, module, exports) {
Object.defineProperty(exports,"__esModule",{value:!0}),exports.DeviceAdapter=void 0;var tslib_1=require("tslib"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),BlueToothBase_1=require("./BlueToothBase"),types_1=require("./types"),_a=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils,arrayBufferToHexStringArray=_a.arrayBufferToHexStringArray,hexToArrayBuffer=_a.hexToArrayBuffer,DeviceAdapter=function(e){function t(t){var i=t.deviceId,r=t.productId,c=t.deviceName,o=t.name,s=t.actions,n=t.bluetoothApi,a=t.h5Websocket,d=t.extendInfo,u=void 0===d?{}:d,h=t.bluetoothAdapter,v=e.call(this)||this;if(v.extendInfo={},v._name="",v._deviceId="",v._deviceName="",v._deviceConnected=!1,v._productId="",v._deviceRegistered=!1,v._characteristicsAutoNotified=!1,v._services=[],v.characteristicsMap={},v._actions={},v._bluetoothApi={},!i)throw"无deviceId";if(!r)throw"productId为空";return v._h5Websocket=a,v._bluetoothApi=n,v._actions=s,v._name=o,v._deviceName=c,v._deviceId=i,v._productId=r,v.extendInfo=u||{},v.bluetoothAdapter=h,v.communicationMode=types_1.CommunicationMode.GATT,v.on("disconnect",(function(){v._characteristicsAutoNotified=!1})),v}return tslib_1.__extends(t,e),t.prototype._getNotifyId=function(e){var t=(void 0===e?{}:e).serviceId,i=void 0===t?"":t;i=i||this.serviceId;var r=this.characteristicsMap[i]||{writeIds:[],notifyIds:[],readIds:[],indicateIds:[]};return r.notifyIds[0]||r.indicateIds[0]},Object.defineProperty(t.prototype,"_writeId",{get:function(){return((this.characteristicsMap[this.serviceId]||{}).writeIds||[])[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_notifyId",{get:function(){return((this.characteristicsMap[this.serviceId]||{}).notifyIds||[])[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_readId",{get:function(){return((this.characteristicsMap[this.serviceId]||{}).readIds||[])[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_indicateId",{get:function(){return((this.characteristicsMap[this.serviceId]||{}).indicateIds||[])[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"deviceId",{get:function(){return this._deviceId},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"productId",{get:function(){return this._productId},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"deviceName",{get:function(){return this._deviceName},set:function(e){this._deviceName=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isConnected",{get:function(){return this._deviceConnected},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"originName",{get:function(){return this._name},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"explorerDeviceId",{get:function(){return[this._productId||"",this._deviceName||""].join("/")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"serviceId",{get:function(){return this.constructor.serviceId},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"deviceInfo",{get:function(){return{productId:this.productId,deviceName:this.deviceName,deviceId:this.deviceId,explorerDeviceId:this.explorerDeviceId,name:this.originName}},enumerable:!1,configurable:!0}),t.prototype.init=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return this.bluetoothAdapter?[4,this.bluetoothAdapter.init()]:[3,2];case 1:return e.sent(),[3,3];case 2:console.warn("DeviceAdapter未注入bluetoothAdapter实例，可能使用的不是最新版本的qcloud-iotexplorer-bluetooth-adapter模块"),e.label=3;case 3:return[2]}}))}))},t.prototype.handleBLEMessage=function(e,t){t.serviceId,t.characteristicId;return{}},t.prototype.registerDevice=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return this._deviceRegistered?[3,2]:[4,this._actions.registerDevice({deviceId:this.explorerDeviceId,deviceName:this._deviceName,productId:this._productId})];case 1:e.sent(),this._deviceRegistered=!0,e.label=2;case 2:return[2]}}))}))},t.prototype.bindDevice=function(e){var t=void 0===e?{}:e,i=t.familyId,r=void 0===i?"":i,c=t.roomId,o=void 0===c?"":c;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,t;return tslib_1.__generator(this,(function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),[4,this.registerDevice()];case 1:return i.sent(),e={deviceId:this.explorerDeviceId,deviceName:this._deviceName,productId:this._productId,familyId:r,roomId:o},[4,this._actions.bindDevice(e)];case 2:return i.sent(),this.emit("bind",e),[2,this.explorerDeviceId];case 3:return t=i.sent(),[2,Promise.reject(this._normalizeError(t))];case 4:return[2]}}))}))},t.prototype.onBleConnectionStateChange=function(e){var t=e.connected;console.log("onBleConnectionStateChange => ",t);var i=this._deviceConnected!==t;this._deviceConnected=t,i&&(t?this.emit("connect",tslib_1.__assign({},this.deviceInfo)):this.emit("disconnect",tslib_1.__assign({},this.deviceInfo)),this.emit("bLEConnectionStateChange",{connected:t}))},t.prototype.onBLECharacteristicValueChange=function(e){var t=e.serviceId,i=e.characteristicId,r=e.value;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,c,o,s,n,a,d,u;return tslib_1.__generator(this,(function(h){switch(h.label){case 0:return h.trys.push([0,4,,5]),e=r,r instanceof ArrayBuffer&&(e=arrayBufferToHexStringArray(r)),c=this.handleBLEMessage(e,{serviceId:t,characteristicId:i})||{},o=c.shouldIgnore,s=c.reportData,n=tslib_1.__rest(c,["shouldIgnore","reportData"]),o?[2]:(console.log("[DeviceAdapter] receive data:",e,n),a=Date.now(),d=!1,this._deviceName&&s?(d=!0,"function"!=typeof this._actions.reportDeviceData?[3,2]:[4,this._actions.reportDeviceData({deviceId:this.explorerDeviceId,deviceName:this._deviceName,productId:this._productId,data:s,timestamp:a})]):[3,3]);case 1:return h.sent(),[3,3];case 2:console.warn("handleBLEMessage return should report but actions.reportDeviceData is not implement."),h.label=3;case 3:return this.emit("message",tslib_1.__assign(tslib_1.__assign({},n),{timestamp:a,dataReported:d})),[3,5];case 4:return u=h.sent(),console.error("onBLECharacteristicValueChange onError,",u),[3,5];case 5:return[2]}}))}))},t.prototype.disconnectDevice=function(){this._bluetoothApi.closeBLEConnection({deviceId:this._deviceId}),this._deviceConnected=!1,this.emit("disconnect",tslib_1.__assign({},this.deviceInfo))},t.prototype.connectDevice=function(e){var t=(void 0===e?{}:e).autoNotify,i=void 0===t||t;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,t,r,c;return tslib_1.__generator(this,(function(o){switch(o.label){case 0:e=Date.now(),o.label=1;case 1:return o.trys.push([1,8,,9]),[4,this.init()];case 2:return o.sent(),console.log("start connect device",this.deviceInfo),this.isConnected?(console.log("device is already connected",this.deviceInfo),[2]):(t=Date.now(),[4,this._bluetoothApi.createBLEConnection({deviceId:this._deviceId})]);case 3:if(o.sent(),this._deviceConnected=!0,console.log("createBLEConnection succ",Date.now()-t),!i)return[3,7];o.label=4;case 4:return o.trys.push([4,6,,7]),[4,this.autoNotifyCharacteristics(!0)];case 5:return o.sent(),[3,7];case 6:throw r=o.sent(),this.isConnected&&this.disconnectDevice(),r;case 7:return console.log("connectDevice succeed, time cost: ",Date.now()-e),[3,9];case 8:return c=o.sent(),(c=this._normalizeError(c)).errMsg&&c.errMsg.indexOf("already connect")>-1?(console.log("device is already connected, resolve directly, time cost: ",Date.now()-e),[2,Promise.resolve()]):(console.error("connectDevice error",c),[2,Promise.reject(c)]);case 9:return[2]}}))}))},t.prototype.autoNotifyCharacteristics=function(e){return void 0===e&&(e=!1),tslib_1.__awaiter(this,void 0,void 0,(function(){var t,i,r;return tslib_1.__generator(this,(function(c){switch(c.label){case 0:return this._characteristicsAutoNotified&&!e?(console.log("[DeviceAdapter.autoNotifyCharacteristics] characteristics already notified, no operation performed"),[2]):(t=Date.now(),[4,this.getBLEDeviceServices()]);case 1:return i=c.sent(),console.log("getBLEDeviceServices succ",i,Date.now()-t),this.emit("onGetBLEDeviceServices",i),t=Date.now(),[4,this.getBLEDeviceCharacteristics()];case 2:return r=c.sent(),console.log("getBLEDeviceCharacteristics succ",r,Date.now()-t),this.emit("onGetBLEDeviceCharacteristics",r),t=Date.now(),[4,this.notifyBLECharacteristicValueChange()];case 3:return c.sent(),console.log("notifyBLECharacteristicValueChange succ",Date.now()-t),this._characteristicsAutoNotified=!0,[2]}}))}))},t.prototype.write=function(e,t){var i=void 0===t?{}:t,r=i.writeId,c=void 0===r?"":r,o=i.serviceId,s=void 0===o?"":o;return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(t){if("string"==typeof e)console.log("writeBLECharacteristicValue",e),e=hexToArrayBuffer(e);else if(e instanceof ArrayBuffer)try{console.log("writeBLECharacteristicValue",arrayBufferToHexStringArray(e).join(""))}catch(e){}return[2,this._write(e,{writeId:c,serviceId:s})]}))}))},t.prototype._write=function(e,t){var i=void 0===t?{}:t,r=i.writeId,c=void 0===r?"":r,o=i.serviceId,s=void 0===o?"":o;return tslib_1.__awaiter(this,void 0,void 0,(function(){var t;return tslib_1.__generator(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,this._bluetoothApi.writeBLECharacteristicValue({deviceId:this._deviceId,characteristicId:c||this._writeId,serviceId:s||this.serviceId,value:e})];case 1:return i.sent(),[3,3];case 2:return t=i.sent(),[2,Promise.reject(this._normalizeError(t))];case 3:return[2]}}))}))},t.prototype.getBLEDeviceServices=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var e;return tslib_1.__generator(this,(function(t){switch(t.label){case 0:return[4,this._bluetoothApi.getBLEDeviceServices({deviceId:this._deviceId})];case 1:return e=t.sent().services,this._services=e,[2,e]}}))}))},t.prototype.setCharacteristicsIds=function(e,t){var i={notifyIds:[],writeIds:[],indicateIds:[],readIds:[]},r=function(e,t){-1===e.indexOf(t)&&e.push(t)};t.forEach((function(e){var t=e.uuid,c=e.properties,o=c.notify,s=c.write,n=c.indicate,a=c.read;o?r(i.notifyIds,t):s?r(i.writeIds,t):n?r(i.indicateIds,t):a&&r(i.readIds,t)})),this.characteristicsMap[e]=i},t.prototype.getBLEDeviceCharacteristics=function(e){var t=(void 0===e?{}:e).serviceId,i=void 0===t?"":t;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e;return tslib_1.__generator(this,(function(t){switch(t.label){case 0:return i=i||this.serviceId,[4,this._bluetoothApi.getBLEDeviceCharacteristics({deviceId:this._deviceId,serviceId:i})];case 1:return e=t.sent().characteristics,this.setCharacteristicsIds(i,e),[2,e]}}))}))},t.prototype.notifyBLECharacteristicValueChange=function(e){var t=void 0===e?{}:e,i=t.characteristicId,r=void 0===i?"":i,c=t.serviceId,o=void 0===c?"":c,s=t.state,n=void 0===s||s;return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return r=r||this._getNotifyId(),o=o||this.serviceId,r?[3,1]:(console.warn("未找到指定service下的notifyId，该设备可能不支持notify"),[3,3]);case 1:return[4,this._bluetoothApi.notifyBLECharacteristicValueChange({deviceId:this._deviceId,characteristicId:r,serviceId:o,state:n})];case 2:e.sent(),e.label=3;case 3:return[2]}}))}))},t.prototype.readBLECharacteristicValue=function(e){var t=void 0===e?{}:e,i=t.serviceId,r=void 0===i?"":i,c=t.characteristicId,o=void 0===c?"":c;return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return r=r||this.serviceId,o||(o=((this.characteristicsMap[this.serviceId]||{}).readIds||[])[0]),o?[3,1]:(console.warn("未找到指定service下的readId，该设备可能不支持read"),[3,3]);case 1:return[4,this._bluetoothApi.readBLECharacteristicValue({deviceId:this._deviceId,characteristicId:o,serviceId:r})];case 2:e.sent(),e.label=3;case 3:return[2]}}))}))},t.prototype.setBLEMTU=function(e){return this._bluetoothApi.setBLEMTU(tslib_1.__assign({deviceId:this._deviceId},e))},t.prototype.getBLEDeviceRSSI=function(){return this._bluetoothApi.getBLEDeviceRSSI({deviceId:this._deviceId})},t.prototype.destroy=function(){this.emit("destroy")},t.prototype.advertFilter=function(e){return null},t.prototype.onScanAdvert=function(e){},t.serviceId="",t.deviceFilter=function(e,t){},t}(BlueToothBase_1.BlueToothBase);exports.DeviceAdapter=DeviceAdapter;
//# sourceMappingURL=DeviceAdapter.js.map
}, function(modId) { var map = {"./BlueToothBase":1666529690829,"./types":1666529690831}; return __REQUIRE__(map[modId], modId); })
__DEFINE__(1666529690831, function(require, module, exports) {
var CommunicationMode;Object.defineProperty(exports,"__esModule",{value:!0}),exports.CommunicationMode=void 0,function(o){o.GATT="GATT",o.ADVERT="ADVERT"}(CommunicationMode=exports.CommunicationMode||(exports.CommunicationMode={}));
//# sourceMappingURL=types.js.map
}, function(modId) { var map = {}; return __REQUIRE__(map[modId], modId); })
__DEFINE__(1666529690832, function(require, module, exports) {
Object.defineProperty(exports,"__esModule",{value:!0});var _systemInfoCache,tslib_1=require("tslib"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),pify=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.pify,pifyApiArr=["closeBluetoothAdapter","stopBluetoothDevicesDiscovery","readBLECharacteristicValue","getBluetoothAdapterState","getBluetoothDevices","startBluetoothDevicesDiscovery","closeBLEConnection","getBLEDeviceServices","getBLEDeviceCharacteristics","notifyBLECharacteristicValueChange","writeBLECharacteristicValue","setBLEMTU"],callbackApiArr=["onBluetoothAdapterStateChange","onBLEConnectionStateChange","onBLECharacteristicValueChange","onBluetoothDeviceFound","onBLEPeripheralConnectionStateChanged","offBluetoothAdapterStateChange","offBLEConnectionStateChange","offBLECharacteristicValueChange","offBluetoothDeviceFound","offBLEPeripheralConnectionStateChanged"],pifyPeripheralApiArr=["addService","close","removeService","startAdvertising","stopAdvertising","writeCharacteristicValue"],callbackPeripheralApiArr=["onCharacteristicReadRequest","onCharacteristicSubscribed","onCharacteristicUnsubscribed","onCharacteristicWriteRequest","offCharacteristicReadRequest","offCharacteristicSubscribed","offCharacteristicUnsubscribed","offCharacteristicWriteRequest"],apis={};pifyApiArr.forEach((function(e){apis[e]=function(t){return pify(wx[e])(t)}})),callbackApiArr.forEach((function(e){apis[e]=function(t){return wx[e](t)}})),apis.createBLEConnection=function(e,t){var r=(void 0===t?{}:t).isRetry,i=void 0!==r&&r;return tslib_1.__awaiter(void 0,void 0,void 0,(function(){var t;return tslib_1.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,pify(wx.createBLEConnection)(e)];case 1:return r.sent(),[3,3];case 2:return t=r.sent(),!i&&t&&t.errMsg&&t.errMsg.indexOf("already connect")>-1?(console.log("device is already connected, resolve directly"),[2,Promise.resolve()]):[2,Promise.reject(t)];case 3:return[2]}}))}))},apis.createBLEPeripheralServer=function(e){return tslib_1.__awaiter(void 0,void 0,void 0,(function(){var t,r;return tslib_1.__generator(this,(function(i){switch(i.label){case 0:return[4,pify(wx.createBLEPeripheralServer)(e)];case 1:return t=i.sent().server,r={},pifyPeripheralApiArr.forEach((function(e){r[e]=function(r){return pify(t[e],t)(r)}})),callbackPeripheralApiArr.forEach((function(e){r[e]=function(r){return t[e](r)}})),[2,r]}}))}))},apis.openBluetoothAdapter=function(e){return tslib_1.__awaiter(void 0,void 0,void 0,(function(){var t,r;return tslib_1.__generator(this,(function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),[4,apis.getSystemInfo({useCache:!1})];case 1:if((null==(t=i.sent())?void 0:t.platform)&&t.platform.toLowerCase().indexOf("android")>-1){if(!(null==t?void 0:t.locationEnabled))throw{code:"Location:Disable",msg:"请打开系统地理位置开关"};if(!(null==t?void 0:t.locationAuthorized))throw{code:"Location:UnAuthorized",msg:"请到系统设置授予微信使用地理位置权限"}}return[4,pify(wx.openBluetoothAdapter)(e)];case 2:return i.sent(),[3,4];case 3:if(3===(null==(r=i.sent())?void 0:r.state))throw{code:null==r?void 0:r.errCode,msg:"请到系统设置授权微信使用蓝牙权限"};throw r;case 4:return[2]}}))}))},apis.getSystemInfo=function(e){var t=(void 0===e?{}:e).useCache,r=void 0===t||t;return tslib_1.__awaiter(void 0,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return _systemInfoCache&&r?[2,_systemInfoCache]:[4,pify(wx.getSystemInfo)()];case 1:return[2,_systemInfoCache=e.sent()]}}))}))},exports.default=apis;
//# sourceMappingURL=nativeBluetoothApi.js.map
}, function(modId) { var map = {}; return __REQUIRE__(map[modId], modId); })
__DEFINE__(1666529690833, function(require, module, exports) {
Object.defineProperty(exports,"__esModule",{value:!0}),exports.BluetoothDeviceCacheManager=void 0;var tslib_1=require("tslib"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),storage=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.storage,BluetoothDeviceCacheManager=function(){function e(){this.deviceCacheMap={},this._storageKey="__explorer-bluetooth-deviceCacheMap"}return e.prototype.init=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var e;return tslib_1.__generator(this,(function(t){switch(t.label){case 0:return e=this,[4,storage.getItem(this._storageKey)];case 1:return e.deviceCacheMap=t.sent()||{},[2]}}))}))},e.prototype.setDeviceCache=function(e,t){console.log("cache ble deviceInfo: ",e,t),this.deviceCacheMap[e]=t,storage.setItem(this._storageKey,this.deviceCacheMap)},e.prototype.getDeviceCache=function(e){return this.deviceCacheMap[e]},e.prototype.removeDeviceCache=function(e){this.deviceCacheMap[e]&&(this.deviceCacheMap[e]=null,storage.setItem(this._storageKey,this.deviceCacheMap))},e}();exports.BluetoothDeviceCacheManager=BluetoothDeviceCacheManager;
//# sourceMappingURL=BluetoothDeviceCacheManager.js.map
}, function(modId) { var map = {}; return __REQUIRE__(map[modId], modId); })
__DEFINE__(1666529690834, function(require, module, exports) {
Object.defineProperty(exports,"__esModule",{value:!0}),exports.SimpleStore=void 0;var SimpleStore=function(){function t(t){var e=t.filter;this._store=[],this.filter=e}return t.prototype.getAll=function(){return this._store},t.prototype.get=function(t){return this._store.find(this.filter(t))},t.prototype.set=function(t){var e=this._store.findIndex(this.filter(t));return e>-1?this._store[e]=t:(this._store.push(t),e=this._store.length-1),e},t.prototype.remove=function(t){var e=this._store.findIndex(this.filter(t));e>-1&&this._store.splice(e,1)},t.prototype.clear=function(){this._store=[]},t}();exports.SimpleStore=SimpleStore;
//# sourceMappingURL=SimpleStore.js.map
}, function(modId) { var map = {}; return __REQUIRE__(map[modId], modId); })
__DEFINE__(1666529690835, function(require, module, exports) {
function throttle(t,o,e,n){var i,r=!1,u=0;function c(){i&&clearTimeout(i)}function a(){var a=this,l=Date.now()-u,f=arguments;function d(){u=Date.now(),e.apply(a,f)}function p(){i=void 0}r||(n&&!i&&d(),c(),void 0===n&&l>t?d():!0!==o&&(i=setTimeout(n?p:d,void 0===n?t-l:t)))}return"boolean"!=typeof o&&(n=e,e=o,o=void 0),a.cancel=function(){c(),r=!0},a.updateDelay=function(o){t=o},a}Object.defineProperty(exports,"__esModule",{value:!0}),exports.throttle=void 0,exports.throttle=throttle;
//# sourceMappingURL=throttle.js.map
}, function(modId) { var map = {}; return __REQUIRE__(map[modId], modId); })
__DEFINE__(1666529690836, function(require, module, exports) {
Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib");tslib_1.__exportStar(require("./BlueToothAdapter4H5"),exports),tslib_1.__exportStar(require("./DeviceAdapter4H5"),exports);
//# sourceMappingURL=index.js.map
}, function(modId) { var map = {"./BlueToothAdapter4H5":1666529690837,"./DeviceAdapter4H5":1666529690839}; return __REQUIRE__(map[modId], modId); })
__DEFINE__(1666529690837, function(require, module, exports) {
Object.defineProperty(exports,"__esModule",{value:!0}),exports.BlueToothAdapter4H5=void 0;var tslib_1=require("tslib"),base_1=require("../base"),BlueToothBridge_1=require("./BlueToothBridge"),BlueToothAdapter4H5=function(e){function t(t){var o=t.h5Websocket,n=t.devMode,i=t.actions,r=tslib_1.__rest(t,["h5Websocket","devMode","actions"]),c=this,s=new BlueToothBridge_1.BlueToothBridge({h5Websocket:o});return c=e.call(this,tslib_1.__assign({actions:tslib_1.__assign({registerDevice:function(e){var t=e.deviceName,o=e.productId;return tslib_1.__awaiter(c,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return[4,s.control("registryDevice",{deviceName:t,productId:this.devMode?o:""})];case 1:return e.sent(),[2]}}))}))},bindDevice:function(e){var t=e.deviceName,o=e.productId;return tslib_1.__awaiter(c,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return[4,s.control("bindDevice",{deviceName:t,productId:this.devMode?o:""})];case 1:return e.sent(),[2]}}))}))}},i),devMode:n,h5Websocket:o,bluetoothApi:s},r))||this,c._onDeviceFoundThrottle=0,c._blueToothBridge=s,c._h5Websocket.on("connect",(function(){c.syncDeviceConnectStatus()})),c._h5Websocket.on("message",(function(e){e&&"connect"===e.action&&c.syncDeviceConnectStatus()})),c}return tslib_1.__extends(t,e),t.prototype.onBluetoothDeviceFound=function(e){var t=(void 0===e?{}:e).devices;return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return t?[3,2]:[4,this.getBluetoothDevices()];case 1:return t=e.sent(),console.log("onBluetoothDeviceFound from getBluetoothDevices",t),[3,3];case 2:console.log("onBluetoothDeviceFound from mp event",t),e.label=3;case 3:try{"function"==typeof this._onBluetoothDeviceFoundHandler&&this._onBluetoothDeviceFoundHandler(t)}catch(e){console.error("_onBluetoothDeviceFoundHandler error",e)}return[2,t]}}))}))},t.prototype.syncDeviceConnectStatus=function(){var e=this._deviceAdapterStore.getAll().filter((function(e){return e.isConnected})).map((function(e){return{deviceId:e.deviceId,connected:e.isConnected}}));e.length&&this._blueToothBridge.control("syncDeviceConnectStatus",{devices:e})},t}(base_1.BlueToothAdapter);exports.BlueToothAdapter4H5=BlueToothAdapter4H5;
//# sourceMappingURL=BlueToothAdapter4H5.js.map
}, function(modId) { var map = {"../base":1666529690827,"./BlueToothBridge":1666529690838}; return __REQUIRE__(map[modId], modId); })
__DEFINE__(1666529690838, function(require, module, exports) {
Object.defineProperty(exports,"__esModule",{value:!0}),exports.BlueToothBridge=void 0;var tslib_1=require("tslib"),event_emitter_for_miniprogram_1=tslib_1.__importDefault(require("event-emitter-for-miniprogram")),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),tryCallHandler=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.tryCallHandler,BlueToothBridge=function(t){function e(e){var o=e.h5Websocket,n=t.call(this)||this;return n._h5Websocket=null,n._blueToothBridgeEnable=!1,n._h5Websocket=o,n._h5Websocket.on("message",(function(t){var e=t.action,o=t.payload;return tslib_1.__awaiter(n,void 0,void 0,(function(){return tslib_1.__generator(this,(function(t){switch(t.label){case 0:switch(e){case"connect":return[3,1];case"onBluetoothAdapterStateChange":return[3,5];case"onBLEConnectionStateChange":return[3,6];case"onBLECharacteristicValueChange":return[3,7];case"onBluetoothDeviceFound":return[3,8]}return[3,9];case 1:return this._blueToothBridgeEnable?[4,this._h5Websocket.connect()]:[3,4];case 2:return t.sent(),[4,this.init()];case 3:t.sent(),t.label=4;case 4:return[3,9];case 5:return tryCallHandler(this,"onBluetoothAdapterStateChange",o),[3,9];case 6:return tryCallHandler(this,"onBLEConnectionStateChange",o),[3,9];case 7:return tryCallHandler(this,"onBLECharacteristicValueChange",o),[3,9];case 8:return tryCallHandler(this,"onBluetoothDeviceFound",o),[3,9];case 9:return[2]}}))}))})),n}return tslib_1.__extends(e,t),e.prototype.init=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(t){switch(t.label){case 0:return this._blueToothBridgeEnable=!0,[4,this._h5Websocket.send("Control",{action:"init"})];case 1:return t.sent(),[2]}}))}))},e.prototype.openBluetoothAdapter=function(){return this.init()},e.prototype.control=function(t,e){return this._h5Websocket.send("Control",{action:t,payload:e})},e.prototype.callWxApi=function(t,e){return tslib_1.__awaiter(this,void 0,void 0,(function(){var o,n;return tslib_1.__generator(this,(function(r){switch(r.label){case 0:return o=Date.now(),[4,this.control("callApi",{api:t,params:e})];case 1:return n=r.sent(),console.log("[BlueToothBridge] call Wx api: "+t+" success, time cost: "+(Date.now()-o)+"ms"),[2,n]}}))}))},e.prototype.stopBluetoothDevicesDiscovery=function(t){return this.callWxApi("stopBluetoothDevicesDiscovery",t)},e.prototype.startBluetoothDevicesDiscovery=function(t){return this.callWxApi("startBluetoothDevicesDiscovery",t)},e.prototype.getConnectedBluetoothDevices=function(t){return this.callWxApi("getConnectedBluetoothDevices",t)},e.prototype.getBluetoothDevices=function(t){return this.callWxApi("getBluetoothDevices",t)},e.prototype.getBluetoothAdapterState=function(t){return this.callWxApi("getBluetoothAdapterState",t)},e.prototype.writeBLECharacteristicValue=function(t){return this.callWxApi("writeBLECharacteristicValue",t)},e.prototype.setBLEMTU=function(t){return this.callWxApi("setBLEMTU",t)},e.prototype.readBLECharacteristicValue=function(t){return this.callWxApi("readBLECharacteristicValue",t)},e.prototype.notifyBLECharacteristicValueChange=function(t){return this.callWxApi("notifyBLECharacteristicValueChange",t)},e.prototype.getBLEDeviceServices=function(t){return this.callWxApi("getBLEDeviceServices",t)},e.prototype.getBLEDeviceRSSI=function(t){return this.callWxApi("getBLEDeviceRSSI",t)},e.prototype.getBLEDeviceCharacteristics=function(t){return this.callWxApi("getBLEDeviceCharacteristics",t)},e.prototype.createBLEConnection=function(t){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){return[2,this.callWxApi("createBLEConnection",t)]}))}))},e.prototype.closeBLEConnection=function(t){return this.callWxApi("closeBLEConnection",t)},e.prototype.onBluetoothAdapterStateChange=function(t){this._onBluetoothAdapterStateChangeHandler=t},e.prototype.offBluetoothAdapterStateChange=function(){this._onBluetoothAdapterStateChangeHandler=null},e.prototype.onBLEConnectionStateChange=function(t){this._onBLEConnectionStateChangeHandler=t},e.prototype.offBLEConnectionStateChange=function(){this._onBLEConnectionStateChangeHandler=null},e.prototype.onBLECharacteristicValueChange=function(t){this._onBLECharacteristicValueChangeHandler=t},e.prototype.offBLECharacteristicValueChange=function(){this._onBLECharacteristicValueChangeHandler=null},e.prototype.onBluetoothDeviceFound=function(t){this._onBluetoothDeviceFoundHandler=t},e.prototype.offBluetoothDeviceFound=function(){this._onBluetoothDeviceFoundHandler=null},e.prototype.getSystemInfo=function(t){var e=(void 0===t?{}:t).useCache,o=void 0===e||e;return tslib_1.__awaiter(this,void 0,void 0,(function(){var t;return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return this._systemInfoCache&&o?[2,this._systemInfoCache]:(t=this,[4,this.callWxApi("getSystemInfo",{})]);case 1:return t._systemInfoCache=e.sent(),[2,this._systemInfoCache]}}))}))},e.prototype.closeBluetoothAdapter=function(){},e}(event_emitter_for_miniprogram_1.default);exports.BlueToothBridge=BlueToothBridge;
//# sourceMappingURL=BlueToothBridge.js.map
}, function(modId) { var map = {}; return __REQUIRE__(map[modId], modId); })
__DEFINE__(1666529690839, function(require, module, exports) {
Object.defineProperty(exports,"__esModule",{value:!0}),exports.DeviceAdapter4H5=exports.AdapterDeviceAdapter4H5=void 0;var tslib_1=require("tslib"),base_1=require("../base"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),arrayBufferToHexStringArray=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.arrayBufferToHexStringArray;exports.AdapterDeviceAdapter4H5=function(e){return function(e){function r(){for(var r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];var o=e.apply(this,tslib_1.__spread(r))||this;return o.on("connect",(function(){var e,r,t=o,i=t.explorerDeviceId,n=t.deviceId,d=t.deviceName,c=t.originName,a=t.productId,s=t.extendInfo,p=t.serviceId;null===(e=o._h5Websocket)||void 0===e||e.send("Control",{action:"reportDeviceConnectStatus",payload:{connected:!0,explorerDeviceId:i,deviceId:n}}),null===(r=o._h5Websocket)||void 0===r||r.send("Control",{action:"h5_mirror_connect",payload:{serviceId:p,deviceId:n,deviceName:d,name:c,productId:a,extendInfo:s}})})).on("disconnect",(function(){var e,r,t=o,i=t.explorerDeviceId,n=t.deviceId;null===(e=o._h5Websocket)||void 0===e||e.send("Control",{action:"reportDeviceConnectStatus",payload:{connected:!1,explorerDeviceId:i,deviceId:n}}),null===(r=o._h5Websocket)||void 0===r||r.send("Control",{action:"h5_mirror_disconnect",payload:{explorerDeviceId:i,deviceId:n}})})),o}return tslib_1.__extends(r,e),r.prototype.write=function(e,r){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(t){return"string"==typeof e?console.log("writeBLECharacteristicValue from H5",e):e instanceof ArrayBuffer&&(e=arrayBufferToHexStringArray(e).join("")),[2,this._write(e,r)]}))}))},r}(e)},exports.DeviceAdapter4H5=exports.AdapterDeviceAdapter4H5(base_1.DeviceAdapter);
//# sourceMappingURL=DeviceAdapter4H5.js.map
}, function(modId) { var map = {"../base":1666529690827}; return __REQUIRE__(map[modId], modId); })
__DEFINE__(1666529690840, function(require, module, exports) {
Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib");tslib_1.__exportStar(require("./BlueToothAdapter4Mp"),exports),tslib_1.__exportStar(require("./DeviceAdapter4Mp"),exports);
//# sourceMappingURL=index.js.map
}, function(modId) { var map = {"./BlueToothAdapter4Mp":1666529690841,"./DeviceAdapter4Mp":1666529690842}; return __REQUIRE__(map[modId], modId); })
__DEFINE__(1666529690841, function(require, module, exports) {
Object.defineProperty(exports,"__esModule",{value:!0}),exports.BlueToothAdapter4Mp=void 0;var tslib_1=require("tslib"),base_1=require("../base"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),_a=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils,arrayBufferToHexStringArray=_a.arrayBufferToHexStringArray,hexToArrayBuffer=_a.hexToArrayBuffer,parseAdvertisData=function(e){var t=tslib_1.__assign({},e);if(t.advertisData)try{t.advertisData=arrayBufferToHexStringArray(t.advertisData)}catch(e){console.error("Parse bluetoothe device advertisData fail",e)}return t},BlueToothAdapter4Mp=function(e){function t(t){var o=t.bluetoothApi,n=tslib_1.__rest(t,["bluetoothApi"]),s=e.call(this,tslib_1.__assign({bluetoothApi:o},n))||this;return s._h5ChanelOpened=!1,s._localDiscoveringInUse=!1,s._h5DiscoveringInUse=!1,s._cleanupTimer=null,s._currentProductId="",s.handleH5WsMessage=null,s.deviceDelayDisconnectQueue=[],s._mpBleConnectionStateCache={},s._h5Websocket&&"function"==typeof s._h5Websocket.on&&(s.on("adapterStateChange",(function(e){var t=e.available,o=e.discovering;s.response2BlueToothChanel("onBluetoothAdapterStateChange",{available:t,discovering:o})})),s._h5Websocket.on("message",(function(e){var t=e.data,o=e.reqId;return tslib_1.__awaiter(s,void 0,void 0,(function(){var e,n,s,r,i,c,a,l,u,h,d,p,v,_,g,f,D,y=this;return tslib_1.__generator(this,(function(C){switch(C.label){case 0:if(console.log("bluetooth ws on message",t),"function"==typeof this.handleH5WsMessage)try{if(this.handleH5WsMessage({data:t,reqId:o}))return console.log("h5 message already handled by handleH5WsMessage implement."),[2]}catch(e){console.error("call handleH5WsMessage error",e)}switch(e=t.action,n=t.payload,e){case"reportDeviceConnectStatus":return[3,1];case"syncDeviceConnectStatus":return[3,2];case"bindDevice":return[3,3];case"registryDevice":return[3,7];case"connect":return[3,11];case"disconnect":return[3,12];case"init":return[3,13];case"callApi":return[3,17]}return[3,32];case 1:return s=n.connected,r=n.explorerDeviceId,i=n.deviceId,this.onDeviceConnectStatusChange({connected:s,explorerDeviceId:r,deviceId:i}),[3,32];case 2:c=n.devices,(_=void 0===c?[]:c).forEach((function(e){var t=e.deviceId,o=e.connected,n=y._mpBleConnectionStateCache[t]||!1;n!==o&&(console.log("[syncDeviceConnectStatus] deviceId="+t+",","h5.connected="+o+", actualConnected="+n),y.response2BlueToothChanel("onBLEConnectionStateChange",{deviceId:t,connected:n}))})),C.label=3;case 3:return C.trys.push([3,5,,6]),l=n.deviceName,u=n.productId,[4,this._actions.bindDevice({productId:this.devMode&&u?u:this._currentProductId,deviceName:l})];case 4:return C.sent(),this.response2BlueToothChanel("response",{code:0},o),[3,6];case 5:return a=C.sent(),this.response2BlueToothChanel("response",a,o),[3,6];case 6:return[3,32];case 7:return C.trys.push([7,9,,10]),l=n.deviceName,u=n.productId,[4,this._actions.registerDevice({productId:this.devMode&&u?u:this._currentProductId,deviceName:l})];case 8:return C.sent(),this.response2BlueToothChanel("response",{code:0},o),[3,10];case 9:return h=C.sent(),this.response2BlueToothChanel("response",h,o),[3,10];case 10:return[3,32];case 11:return console.log("h5chanel opened"),this._h5ChanelOpened=!0,[3,32];case 12:return console.log("h5chanel closed"),this._h5ChanelOpened=!1,this._h5DiscoveringInUse&&this.stopBluetoothDevicesDiscovery(!0),[3,32];case 13:return C.trys.push([13,15,,16]),[4,this.init()];case 14:return C.sent(),this.response2BlueToothChanel("response",{code:0},o),[3,16];case 15:return d=C.sent(),this.response2BlueToothChanel("response",d,o),[3,16];case 16:return[3,32];case 17:p=n.api,v=n.params,C.label=18;case 18:switch(C.trys.push([18,30,,31]),console.log("call api",p,v),p){case"createBLEConnection":return[3,19];case"getBluetoothDevices":return[3,21];case"writeBLECharacteristicValue":return[3,23];case"startBluetoothDevicesDiscovery":return[3,25];case"stopBluetoothDevicesDiscovery":return[3,27]}return[3,29];case 19:return this.tryCancelDisconnectDevice(v.deviceId),[4,this._bluetoothApi.createBLEConnection(v)];case 20:return C.sent(),this.response2BlueToothChanel("response",{},o),[2];case 21:return[4,this.getBluetoothDevices()];case 22:return _=C.sent(),this.response2BlueToothChanel("response",{devices:_.map(parseAdvertisData)},o),[2];case 23:return g=v.value,console.log("calling writeBLECharacteristicValue",tslib_1.__assign(tslib_1.__assign({},v),{value:hexToArrayBuffer(g)})),[4,this._bluetoothApi.writeBLECharacteristicValue(tslib_1.__assign(tslib_1.__assign({},v),{value:hexToArrayBuffer(g)}))];case 24:return f=C.sent(),this.response2BlueToothChanel("response",f,o),[2];case 25:return[4,this.startBluetoothDevicesDiscovery(!0)];case 26:return f=C.sent(),this.response2BlueToothChanel("response",f,o),[2];case 27:return[4,this.stopBluetoothDevicesDiscovery(!0)];case 28:return f=C.sent(),this.response2BlueToothChanel("response",f,o),[2];case 29:return[3,31];case 30:return D=C.sent(),console.error("[BlueToothAdapter4Mp] call bluetoothApi fail",D),this.response2BlueToothChanel("response",this._normalizeError(D),o),[2];case 31:return wx[p]&&wx[p](tslib_1.__assign(tslib_1.__assign({},v),{success:function(e){console.log("[BlueToothAdapter4Mp] call wx api success",e),y.response2BlueToothChanel("response",e,o)},fail:function(e){console.log("call api fail",e),y.response2BlueToothChanel("response",y._normalizeError(e),o)}})),[3,32];case 32:return[2]}}))}))}))),s}return tslib_1.__extends(t,e),t.prototype.tryCancelDisconnectDevice=function(e){var t=this.deviceDelayDisconnectQueue.findIndex((function(t){return t.deviceId===e}));if(t>-1){var o=this.deviceDelayDisconnectQueue[t];return clearTimeout(o.timer),this.deviceDelayDisconnectQueue.splice(t,1),console.log("Cancel disconnect device: "+e),!0}return console.log("Try cancel disconnect device: "+e+", but not found in queue, maybe it's already disconnected"),!1},t.prototype.disconnectDevice=function(e,t){var o=this,n=e.deviceId,s=e.explorerDeviceId;void 0===t&&(t=0),console.log("call disconnectDevice",{deviceId:n,explorerDeviceId:s});var r=this._deviceConnectStatusStore.get({deviceId:n,explorerDeviceId:s});if(null==r?void 0:r.connected)if(t>0){var i=setTimeout((function(){console.log("execute closeBLEConnection for deviceId: "+n+" after "+t+"ms"),o._bluetoothApi.closeBLEConnection({deviceId:n})}),t);console.log("Will disconnect device: "+n+" after "+t+"ms..."),this.deviceDelayDisconnectQueue.push({deviceId:n,timer:i})}else this._bluetoothApi.closeBLEConnection({deviceId:n});else console.log("call disconnectDevice, but device maybe not connected",r,this._deviceConnectStatusStore.getAll())},t.prototype.setCurrentProduct=function(e){this._currentProductId=e},t.prototype.startBluetoothDevicesDiscovery=function(t){return void 0===t&&(t=!1),t?this._h5DiscoveringInUse=!0:this._localDiscoveringInUse=!0,e.prototype.startBluetoothDevicesDiscovery.call(this)},t.prototype.stopBluetoothDevicesDiscovery=function(t){if(void 0===t&&(t=!1),console.log("try call stopBluetoothDevicesDiscovery,\n     isFromH5: "+t+", _h5DiscoveringInUse: "+this._h5DiscoveringInUse+",\n      _localDiscoveringInUse: "+this._localDiscoveringInUse),t?this._h5DiscoveringInUse=!1:this._localDiscoveringInUse=!1,this._h5DiscoveringInUse||!this._localDiscoveringInUse)return e.prototype.stopBluetoothDevicesDiscovery.call(this)},t.prototype.response2BlueToothChanel=function(e,t,o){return void 0===t&&(t={}),void 0===o&&(o=""),tslib_1.__awaiter(this,void 0,void 0,(function(){var n;return tslib_1.__generator(this,(function(s){switch(s.label){case 0:return s.trys.push([0,2,,3]),this._h5ChanelOpened?(console.log("response2BlueToothChanel",e,t),[4,this._h5Websocket.send("Response",{action:e,payload:t},{reqId:o})]):(console.log("h5 chanel not opened"),[2]);case 1:return s.sent(),[3,3];case 2:return n=s.sent(),console.warn("try send bluetooth message fail",n),[3,3];case 3:return[2]}}))}))},t.prototype.startCleanupTimer=function(){var e=this;clearTimeout(this._cleanupTimer),console.log("start cleanup timer"),this._cleanupTimer=setTimeout((function(){var t=e._deviceAdapterStore.getAll().filter((function(e){return e.isConnected}));console.log("bluetooth searching or deviceMap not empty, reset cleanup timer",e._discovering,t),e._h5ChanelOpened||e._discovering||t.length?e.startCleanupTimer():e.cleanup()}),3e4)},t.prototype.init=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var t=this;return tslib_1.__generator(this,(function(o){return[2,e.prototype.init.call(this).then((function(){return t.startCleanupTimer()}))]}))}))},t.prototype.onBleConnectionStateChange=function(t){var o=t.deviceId,n=t.connected;return this.response2BlueToothChanel("onBLEConnectionStateChange",{deviceId:o,connected:n}),this._mpBleConnectionStateCache[o]=n,e.prototype.onBleConnectionStateChange.call(this,{deviceId:o,connected:n})},t.prototype.onBLECharacteristicValueChange=function(t){var o=t.deviceId,n=t.serviceId,s=t.characteristicId,r=t.value;return this.response2BlueToothChanel("onBLECharacteristicValueChange",{deviceId:o,serviceId:n,characteristicId:s,value:arrayBufferToHexStringArray(r)}),e.prototype.onBLECharacteristicValueChange.call(this,{deviceId:o,serviceId:n,characteristicId:s,value:r})},t.prototype.onBluetoothDeviceFound=function(t){return tslib_1.__awaiter(this,void 0,void 0,(function(){var o;return tslib_1.__generator(this,(function(n){switch(n.label){case 0:return[4,e.prototype.onBluetoothDeviceFound.call(this,t)];case 1:return o=n.sent(),this.response2BlueToothChanel("onBluetoothDeviceFound",{devices:o.map(parseAdvertisData)}),[2]}}))}))},t.prototype.startSearch=function(t){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(o){switch(o.label){case 0:return[4,e.prototype.startSearch.call(this,t)];case 1:return o.sent(),this.startCleanupTimer(),[2]}}))}))},t.prototype.searchDevice=function(t){return tslib_1.__awaiter(this,void 0,void 0,(function(){var o;return tslib_1.__generator(this,(function(n){switch(n.label){case 0:return[4,e.prototype.searchDevice.call(this,t)];case 1:return o=n.sent(),this.startCleanupTimer(),[2,o]}}))}))},t.prototype.cleanup=function(t){e.prototype.cleanup.call(this,t),this._mpBleConnectionStateCache={}},t}(base_1.BlueToothAdapter);exports.BlueToothAdapter4Mp=BlueToothAdapter4Mp;
//# sourceMappingURL=BlueToothAdapter4Mp.js.map
}, function(modId) { var map = {"../base":1666529690827}; return __REQUIRE__(map[modId], modId); })
__DEFINE__(1666529690842, function(require, module, exports) {
Object.defineProperty(exports,"__esModule",{value:!0}),exports.DeviceAdapter4Mp=exports.AdapterDeviceAdapter4Mp=void 0;var tslib_1=require("tslib"),base_1=require("../base");exports.AdapterDeviceAdapter4Mp=function(e){return function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),t}(e)},exports.DeviceAdapter4Mp=exports.AdapterDeviceAdapter4Mp(base_1.DeviceAdapter);
//# sourceMappingURL=DeviceAdapter4Mp.js.map
}, function(modId) { var map = {"../base":1666529690827}; return __REQUIRE__(map[modId], modId); })
return __REQUIRE__(1666529690826);
})()
//# sourceMappingURL=index.js.map