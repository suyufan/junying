"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Models=void 0;var tslib_1=require("tslib"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),iotexplorer_ui_dev_config_1=require("iotexplorer-ui-dev-config"),libs_1=require("../../libs"),shortid_for_miniprogram_1=tslib_1.__importDefault(require("shortid-for-miniprogram")),Models=function(){function e(e){this.appDevSdk=e}return e.prototype.getDeviceConfig=function(e){var t=e.DeviceId,i=e.DeviceKey,r=void 0===i?"*":i,n=e.isUserConfig,o=void 0!==n&&n;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,i,n,s;return tslib_1.__generator(this,(function(c){switch(c.label){case 0:e={},c.label=1;case 1:return c.trys.push([1,3,,4]),[4,this.appDevSdk.requestApi(o?"AppGetUserDeviceConfig":"AppGetDeviceConfig",{DeviceId:t,DeviceKey:r})];case 2:return i=c.sent(),e=i.Configs,[3,4];case 3:return n=c.sent(),console.warn("AppGetDeviceConfig fail",n),[3,4];case 4:if("*"===r)return[2,e];if("string"==typeof(s=e[r])&&~s.indexOf("{"))try{s=JSON.parse(s)}catch(e){console.warn("parse device value fail",e)}return[2,s]}}))}))},e.prototype.getDeviceSignAgitated=function(e){var t=e.DeviceId,i=e.Content,r=e.SignMethod,n=void 0===r?"hmacsha256":r,o=e.ContentType,s=void 0===o?"hex":o;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,r,o,c;return tslib_1.__generator(this,(function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),[4,this.appDevSdk.requestApi("AppDeviceCustomSignatureAgitated",{DeviceId:t,Content:i,SignMethod:n,ContentType:s})];case 1:return e=a.sent(),r=e.AgitatedContent,o=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.hexToStr(r.slice(32)).replace(/\//g,""),[2,tslib_1.__assign(tslib_1.__assign({},e),{Timestamp:Number(o)})];case 2:return c=a.sent(),console.warn("get signAgitated failed",c),[2,Promise.reject(c)];case 3:return[2]}}))}))},e.prototype.getDeviceSign=function(e){var t=e.DeviceId,i=e.Content,r=e.SignMethod,n=void 0===r?"hmacsha256":r,o=e.ContentType;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,r,s;return tslib_1.__generator(this,(function(c){switch(c.label){case 0:return c.trys.push([0,2,,3]),[4,this.appDevSdk.requestApi("AppDeviceCustomSignature",{DeviceId:t,Content:i,SignMethod:n,ContentType:o})];case 1:return e=c.sent(),r=e.Signature,[2,libs_1.xorHalf(libs_1.base64toHEX(r))];case 2:return s=c.sent(),console.warn("get device sign failed",s),[2,Promise.reject(s)];case 3:return[2]}}))}))},e.prototype.getDeviceSecret=function(e){var t=e.DeviceId,i=e.AppNonce,r=e.DeviceNonce,n=e.DeviceNonceSign;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,o,s;return tslib_1.__generator(this,(function(c){switch(c.label){case 0:return c.trys.push([0,2,,3]),[4,this.appDevSdk.requestApi("AppGetLLsyncSecretEncryptKey",{DeviceId:t,AppNonce:i,DeviceNonce:r,DeviceNonceSign:n})];case 1:return e=c.sent(),o=e.SecretEncryptKeyHex,[2,libs_1.xorHalf(o)];case 2:return s=c.sent(),console.warn("get sign failed",s),[2,Promise.reject(s)];case 3:return[2]}}))}))},e.prototype.getLLsyncSecretEncryptKey=function(e){var t=e.AppNonce,i=e.DeviceNonce,r=e.DeviceNonceSign;return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){return[2,this.appDevSdk.requestApi("AppGetLLsyncSecretEncryptKey",{AppNonce:t,DeviceNonce:i,DeviceNonceSign:r})]}))}))},e.prototype.setDeviceConfig=function(e){var t=e.DeviceId,i=e.DeviceKey,r=e.DeviceValue,n=e.isUserConfig,o=void 0!==n&&n;return"string"!=typeof r&&(r=JSON.stringify(r)),this.appDevSdk.requestApi(o?"AppSetUserDeviceConfig":"AppSetDeviceConfig",{DeviceId:t,DeviceKey:i,DeviceValue:r})},e.prototype.reportBlueToothDeviceData=function(e){var t=e.ProductId,i=e.DeviceName,r=e.Data,n=e.DataTimeStamp;return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){return r||(r={}),"string"!=typeof r&&(r=JSON.stringify(r)),[2,this.appDevSdk.requestApi("AppReportDataAsDevice",{ProductId:t,DeviceName:i,Data:r,DataTimeStamp:n})]}))}))},e.prototype.getDeviceData=function(e){var t=e.ProductId,i=e.DeviceName;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e;return tslib_1.__generator(this,(function(r){switch(r.label){case 0:return[4,this.appDevSdk.requestApi("AppGetDeviceData",{ProductId:t,DeviceName:i})];case 1:e=r.sent().Data;try{return"string"==typeof e&&(e=JSON.parse(e)),[2,e]}catch(e){return console.error("parse json fail",{ProductId:t,DeviceName:i},e),[2,{}]}return[2]}}))}))},e.prototype.reportDeviceEvent=function(e){var t=e.DeviceId,i=e.EventId,r=e.Params;return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){return[2,this.appDevSdk.requestApi("AppReportDeviceEvent",{DeviceId:t,EventId:i,Params:r,Method:"ReportEventAsDevice"})]}))}))},e.prototype.addDeviceBySigInFamily=function(e){var t=e.Signature,i=e.DeviceTimestamp,r=e.ProductId,n=e.DeviceName,o=e.DeviceId,s=e.ConnId,c=e.FamilyId,a=e.RoomId,p=e.SignMethod,u=void 0===p?"hmacsha1":p,d=e.BindType,v=void 0===d?"other_sign":d;return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return[4,this.appDevSdk.requestApi("AppSigBindDeviceInFamily",{Signature:t,DeviceTimestamp:i,ProductId:r,DeviceName:n,DeviceId:o,ConnId:s,FamilyId:c,RoomId:a,BindType:v,SignMethod:u})];case 1:return[2,e.sent().Data.AppDeviceInfo]}}))}))},e.prototype.deleteDeviceFromFamily=function(e){var t=e.FamilyId,i=e.DeviceId;return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){return[2,this.appDevSdk.requestApi("AppDeleteDeviceInFamily",{FamilyId:t,DeviceId:i})]}))}))},e.prototype.reportDeviceInfo=function(e){var t=e.productId,i=e.deviceName,r=e.deviceInfo;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,n;return tslib_1.__generator(this,(function(o){return e={method:"report_info",clientToken:t+"/"+i+"-"+shortid_for_miniprogram_1.default(),params:r},n={ProductId:t,DeviceName:i,Topic:"$thing/up/property/"+t+"/"+i,Payload:JSON.stringify(e)},[2,this.appDevSdk.requestApi("AppPublishMsgAsDevice",n)]}))}))},e.prototype.publishDeviceActionMessage=function(e){var t=e.productId,i=e.deviceName,r=e.clientToken,n=e.actionId,o=e.output;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,s;return tslib_1.__generator(this,(function(c){return e={method:"action_reply",clientToken:r,ActionId:n,timestamp:Math.floor(Date.now()/1e3),response:o,code:0,status:"action execute success!"},s={ProductId:t,DeviceName:i,Topic:"$thing/up/action/"+t+"/"+i,Payload:JSON.stringify(e)},console.log("---reply action---",s),[2,this.appDevSdk.requestApi("AppPublishMsgAsDevice",s)]}))}))},e.prototype.reportOTAVersion=function(e){var t=e.Version,i=e.DeviceId;return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){return[2,this.appDevSdk.requestApi("AppReportFirmwareVersion",{Version:t,DeviceId:i})]}))}))},e.prototype.getDeviceOTAInfo=function(e){var t=e.DeviceId;return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){return[2,this.appDevSdk.requestApi("AppGetDeviceOTAInfo",{DeviceId:t})]}))}))},e.prototype.getProduct=function(e){var t=e.ProductId;return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return[4,this.appDevSdk.requestApi("AppGetProducts",{ProductIds:[t]})];case 1:return[2,e.sent().Products[0]]}}))}))},e.prototype.getProductConfig=function(e){var t=e.ProductId;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,i;return tslib_1.__generator(this,(function(r){switch(r.label){case 0:return[4,this.appDevSdk.requestApi("AppGetProductsConfig",{ProductIds:[t]})];case 1:return e=r.sent().Data,i={},e.forEach((function(e){try{e.Config=JSON.parse(e.Config)}catch(t){e.Config={}}i[e.ProductId]=iotexplorer_ui_dev_config_1.initializeUIDevConfig(e.Config)})),[2,i[t]]}}))}))},e.prototype.dynamicRegisterDevice=function(e){var t=e.deviceName,i=e.productId,r=e.timestamp,n=e.nonce,o=e.sign;return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return[4,this.appDevSdk.requestApi("AppDeviceDynamicRegister",{DeviceId:i+"/"+t,DeviceTimestamp:r,Nonce:n,Signature:o})];case 1:return[2,{payload:e.sent().Payload}]}}))}))},e}();exports.Models=Models;
//# sourceMappingURL=Models.js.map