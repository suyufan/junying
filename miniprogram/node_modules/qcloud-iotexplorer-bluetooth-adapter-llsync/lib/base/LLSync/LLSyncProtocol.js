"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isHeartbeatResp=exports.LLSyncProtocol=exports.LLSyncConfig=exports.BindState=void 0;var BindState,tslib_1=require("tslib"),constants=tslib_1.__importStar(require("../../constants")),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),libs_1=require("../../libs"),_a=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils,noop=_a.noop,genPromise=_a.genPromise,byteUtil=_a.byteUtil;!function(t){t[t.NOT_BOUND=0]="NOT_BOUND",t[t.WAITING_BIND=1]="WAITING_BIND",t[t.HAS_BOUND=2]="HAS_BOUND",t[t.CONNECTED=3]="CONNECTED"}(BindState=exports.BindState||(exports.BindState={})),exports.LLSyncConfig={BLE_PSK_DEVICE_KEY:"ble_psk_device_ket",Secret_Encrypt_Key:"secret_encrypt_key",waitConnectReplyTime:1e4,waitBindReplyTime:1e4,waitGetRegisterDeviceInfo:1e4,waitGetCheckTimeoutReplyTime:1e4,waitGetCheckTimeoutDefaultReplyTime:6e4,waitControlReplyTime:1e4,waitGetDeviceInfoTime:1e4,waitUpdateReplyInt:1e4,waitGetAdvDataReplyTime:1e4,mtuDefaultMap:{0:void 0,1:20,2:20}};var LLSyncProtocol=function(){function t(t){this._cleanupUserCheckHandleAfterCancel=noop,this.deviceAdapter=t,this._parseDataBeforeConnect=this._parseDataBeforeConnect.bind(this)}return Object.defineProperty(t.prototype,"reporter",{get:function(){return this.deviceAdapter.reporter},enumerable:!1,configurable:!0}),t.prototype.requestBindDevice=function(t){var e=t.needUserCheck,n=void 0!==e&&e,i=t.isDynamicRegister,s=void 0!==i&&i;return tslib_1.__awaiter(this,void 0,void 0,(function(){var t,e,i,o,r,a=this;return tslib_1.__generator(this,(function(c){switch(c.label){case 0:return t=Math.floor(Date.now()/1e3),e=parseInt(libs_1.gen4BytesIntHex(),16),i=this._parseDataBeforeConnect(""+constants.DEVICE_INFO_WRITE_PREFIX[constants.TIME_SYNC]+e.toString(16)+t.toString(16),constants.TIME_SYNC),this.reporter.info(constants.TIME_SYNC,{timestamp:t,nonce:e,bindDeviceData:i,needUserCheck:n,isDynamicRegister:s}),s?[4,this.registerDevice({timestamp:t,bindDeviceData:i,nonce:e})]:[3,2];case 1:o=c.sent(),i=o.bleData,t=o.timestamp,c.label=2;case 2:return r={bindDeviceData:i,dataHandler:function(i){if(!i.length)throw{code:constants.CONNECT_REPLY_INVALID};if(n){var s=!(libs_1.getStrLength(i)>>15);if(console.log("bind auth response userCheckResult",s),!s)throw{code:constants.GET_USER_CHECK_REJECT}}var o=i.slice(2,22).join(""),r=libs_1.hex2str(i.slice(22)),c={sign:o.toLocaleLowerCase(),deviceName:r,nonce:e,timestamp:t+60};return a.reporter.info(constants.TIME_SYNC,c),c}},this.reporter.info(constants.TIME_SYNC,r),[2,n?this.waitUserCheckAndBindDevice(r):this.bindDeviceDirectly(r)]}}))}))},t.prototype.registerDevice=function(t){var e=t.timestamp,n=t.nonce,i=t.bindDeviceData;return tslib_1.__awaiter(this,void 0,void 0,(function(){var t,s,o,r,a,c,_,E,I=this;return tslib_1.__generator(this,(function(d){switch(d.label){case 0:return[4,this.deviceAdapter.writeAndWait4Response(i,constants.REGISTER_DEVICE_INFO_REPLY,(function(t){if(!t.length)throw{code:constants.REGISTER_DEVICE_INFO_REPLY_INVALID};var e=libs_1.getStrLength(t),n=parseInt(t.slice(2,3).join(""),16),i=libs_1.hex2str(t.slice(3,3+n)),s=libs_1.hex2str(t.slice(3+n,3+e));return I.reporter.info(constants.REGISTER_DEVICE_INFO_REPLY,{allLength:e,deviceNameLength:n,deviceName:i,sign:s}),{sign:s,deviceName:i}}),{timeout:exports.LLSyncConfig.waitGetRegisterDeviceInfo,timeoutCode:constants.WAIT_REGISTER_DEVICE_INFO_REPLY_TIMEOUT,writeId:constants.DEVICE_INFO_WRITE_ID})];case 1:t=d.sent(),s=t.deviceName,o=t.sign,this.reporter.info(constants.TIME_SYNC,{deviceName:s,sign:o}),r=0,d.label=2;case 2:return d.trys.push([2,4,,5]),[4,this.deviceAdapter.models.dynamicRegisterDevice({deviceName:s,sign:o,productId:this.deviceAdapter.productId,timestamp:e,nonce:n})];case 3:return a=d.sent().payload,c=Math.floor(Date.now()/1e3),r=1,_=this._parseDataBeforeConnect(constants.DEVICE_INFO_WRITE_PREFIX[constants.SEND_REGISTER_DEVICE_PAYLOAD]+""+libs_1.U8ToHexString(r)+libs_1.U8ToHexString(a.length)+libs_1.str2hexStr(a)+n.toString(16)+c.toString(16),constants.SEND_REGISTER_DEVICE_PAYLOAD),this.reporter.info(constants.REGISTER_DEVICE_SUCCESS,{payload:a,bleData:_}),[2,{bleData:_,timestamp:c}];case 4:throw E=d.sent(),tslib_1.__assign(tslib_1.__assign({},E),{code:constants.REGISTER_DEVICE_ERROR});case 5:return[2]}}))}))},t.prototype.bindDeviceDirectly=function(t){var e=t.bindDeviceData,n=t.dataHandler;return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(t){return[2,this.deviceAdapter.writeAndWait4Response(e,constants.BIND_AUTH,n,{timeout:exports.LLSyncConfig.waitBindReplyTime,timeoutCode:constants.WAIT_CONNECT_REPLY_TIMEOUT,writeId:constants.DEVICE_INFO_WRITE_ID})]}))}))},t.prototype.waitUserCheckAndBindDevice=function(t){var e=t.bindDeviceData,n=t.dataHandler;return tslib_1.__awaiter(this,void 0,void 0,(function(){var t,i,s,o=this;return tslib_1.__generator(this,(function(r){switch(r.label){case 0:return t=genPromise(),s=function(e){clearTimeout(i),console.log("registerUserCheckTimer",e),i=setTimeout((function(){console.log("user check timeout",e),o.cancelUserCheck("timeout"),t.reject({code:constants.WAIT_USER_CHECK_TIMEOUT})}),e)},this.deviceAdapter.wait4EventResponse(constants.USER_CHECK_TIMEOUT_CALLBACK,(function(t){if(!t.length)return console.log("get user check timeout duration fail, trigger default timeout timer"),o.reporter.info(constants.GET_USER_CHECK_TIMEOUT_ERROR),s(exports.LLSyncConfig.waitGetCheckTimeoutDefaultReplyTime);var e=1e3*parseInt(t.slice(2).join(""),16);o.reporter.info(constants.GET_USER_CHECK_TIMEOUT_SUCCESS,{timeoutDuration:e}),s(e)}),{timeout:exports.LLSyncConfig.waitGetCheckTimeoutReplyTime,timeoutHandler:function(){o.reporter.info(constants.GET_USER_CHECK_TIMEOUT_TIMEOUT),s(exports.LLSyncConfig.waitGetCheckTimeoutDefaultReplyTime-exports.LLSyncConfig.waitGetCheckTimeoutReplyTime)}}),this._cleanupUserCheckHandleAfterCancel=function(){console.log("process cleanup user check handler"),t.reject(null),o.deviceAdapter.off(constants.BIND_AUTH),o._cleanupUserCheckHandleAfterCancel=noop},[4,Promise.race([t.promise,this.deviceAdapter.writeAndWait4Response(e,constants.BIND_AUTH,n,{timeout:exports.LLSyncConfig.waitGetCheckTimeoutDefaultReplyTime+exports.LLSyncConfig.waitGetCheckTimeoutReplyTime,timeoutCode:constants.WAIT_CONNECT_REPLY_TIMEOUT,writeId:constants.DEVICE_INFO_WRITE_ID})])];case 1:return[2,r.sent()]}}))}))},t.prototype.cancelUserCheck=function(t){void 0===t&&(t="timeout"),console.log("cancel user check, reason: ",t),"cancel"===t&&this._cleanupUserCheckHandleAfterCancel();var e=""+constants.DEVICE_INFO_WRITE_PREFIX[constants.USER_CHECK_TIMEOUT]+libs_1.U8ToHexString("timeout"===t?constants.WRITE_USER_CHECK_TIMEOUT:constants.WRITE_USER_CHECK_CANCEL);this.deviceAdapter.write(e,{writeId:constants.DEVICE_INFO_WRITE_ID})},t.prototype.getDeviceAuthInfo=function(){var t=Math.floor(Date.now()/1e3),e=this._parseDataBeforeConnect(""+constants.DEVICE_INFO_WRITE_PREFIX[constants.CONNECT_AUTH]+t.toString(16)+libs_1.encrypt(t,this.deviceAdapter.localPsk),constants.CONNECT_AUTH);return console.log("[LLsyncProtocol] auth data:",{data:e,moduleVersion:this.deviceAdapter.extendInfo.moduleVersion,localPsk:this.deviceAdapter.localPsk,dataStr:""+constants.DEVICE_INFO_WRITE_PREFIX[constants.CONNECT_AUTH]+t.toString(16)+libs_1.encrypt(t,this.deviceAdapter.localPsk)}),this.deviceAdapter.writeAndWait4Response(e,constants.CONNECT_AUTH,(function(e){if(!e.length)throw{code:constants.CONNECT_REPLY_INVALID};return{sign:e.slice(2,22).join("").toLocaleLowerCase(),timestamp:t}}),{timeout:exports.LLSyncConfig.waitConnectReplyTime,timeoutCode:constants.WAIT_CONNECT_REPLY_TIMEOUT,writeId:constants.DEVICE_INFO_WRITE_ID})},t.prototype.getDeviceInfo=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(t){return[2,this.deviceAdapter.writeAndWait4Response(constants.DEVICE_INFO_WRITE_PREFIX[constants.CONNECT_RESULT_WRITE_SUCCESS],constants.DEVICE_INFO,(function(t){if(!t.length)throw{code:constants.DEVICE_INFO_INVALID};var e=parseInt(t.slice(2,3).join(""),16),n=parseInt(t.slice(3,5).join(""),16),i=!!(n>>15),s=8191&n,o=t.slice(6).join("");return{version:e,mtu:s,needSetMtu:i,otaVersion:o?libs_1.hex2str(o):o}}),{timeout:exports.LLSyncConfig.waitGetDeviceInfoTime,timeoutCode:constants.WAIT_GET_DEVICE_INFO_TIMEOUT,writeId:constants.DEVICE_INFO_WRITE_ID})]}))}))},t.prototype.getUnbindAuthSign=function(){var t=this._parseDataBeforeConnect(""+constants.DEVICE_INFO_WRITE_PREFIX[constants.UNBIND_AUTH]+libs_1.encrypt(constants.UNBIND_REQUEST,this.deviceAdapter.localPsk),constants.UNBIND_AUTH);return this.deviceAdapter.writeAndWait4Response(t,constants.UNBIND_AUTH,(function(t){if(!t.length)throw{code:constants.UNBIND_REPLY_INVALID};return{sign:t.slice(2,22).join("").toLocaleLowerCase()}}),{timeout:exports.LLSyncConfig.waitConnectReplyTime,timeoutCode:constants.WAIT_UNBIND_REPLY_TIMEOUT,writeId:constants.DEVICE_INFO_WRITE_ID})},t.prototype.controlDeviceAction=function(t){var e=libs_1.convertActionControlToTlv(t,this.deviceAdapter.dataTemplate),n=e.actionIndex,i=e.tlvData,s=e.tmpData,o=this.deviceAdapter.sliceData(tslib_1.__spread([libs_1.getTypeHead(constants.DEVICE_DATA_WRITE_HEAD[constants.CONTROL_ACTION],n),libs_1.U16ToHexString(i.length)],i),s,constants.CONTROL_ACTION);return this.deviceAdapter.isEncrypted&&(o=this.deviceAdapter.encrypt(o,this.deviceAdapter.sessionKey,{contentType:"hex"})),this.deviceAdapter.writeAndWait4Response(o,constants.ACTION_REPLY,(function(t){if(!t.length)throw{code:constants.CONTROL_REPLY_INVALID};var e=parseInt(t.slice(2,3).join(""),16),n=t.slice(3);if(0===e)return{success:!0,output:n};throw{code:constants.CONTROL_REPLY_CODE_INVALID,errCode:e}}),{timeout:exports.LLSyncConfig.waitControlReplyTime,timeoutCode:constants.WAIT_CONTROL_ACTION_REPLY_TIMEOUT,writeId:constants.DEVICE_DATA_WRITE_ID,wrapSplitDataMode:constants.ACTION_REPLY})},t.prototype.controlDeviceProperty=function(t){var e=libs_1.convertPropertiesChangeToTlv(t,this.deviceAdapter.dataTemplate),n=e.tlvData,i=e.tmpData,s=this.deviceAdapter.sliceData(tslib_1.__spread([libs_1.getTypeHead(constants.DEVICE_DATA_WRITE_HEAD[constants.CONTROL_DEVICE],constants.DEVICE_DATA_WRITE_SUFFIX[constants.CONTROL_DEVICE]),libs_1.U16ToHexString(n.length)],n),i,constants.CONTROL_DEVICE);return this.deviceAdapter.isEncrypted&&(s=this.deviceAdapter.encrypt(s,this.deviceAdapter.sessionKey,{contentType:"hex"})),this.deviceAdapter.writeAndWait4Response(s,constants.CONTROL_REPLY,(function(t){if(!t.length)throw{code:constants.CONTROL_REPLY_INVALID};var e=parseInt(t.slice(2).join(""),16);if(0===e)return{code:0};throw{code:constants.CONTROL_REPLY_CODE_INVALID,errCode:e}}),{timeout:exports.LLSyncConfig.waitControlReplyTime,timeoutCode:constants.WAIT_CONTROL_DEVICE_REPLY_TIMEOUT,writeId:constants.DEVICE_DATA_WRITE_ID})},t.prototype.reportBindSuccess=function(t){return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,n;return tslib_1.__generator(this,(function(i){switch(i.label){case 0:return e=libs_1.gen4BytesIntHex(),this.reporter.info(constants.BIND_AUTH_SUCCESS,{identify:this.deviceAdapter.userIdentify,localPsk:e,timeCost:Date.now()-t}),n=""+constants.DEVICE_INFO_WRITE_PREFIX[constants.BIND_AUTH_SUCCESS]+constants.DEVICE_INFO_WRITE_PREFIX[constants.BIND_AUTH_SUCCESS]+e+this.deviceAdapter.userIdentify,[4,this.deviceAdapter.writeData(this._parseDataBeforeConnect(n,constants.BIND_AUTH_SUCCESS),{writeId:constants.DEVICE_INFO_WRITE_ID})];case 1:return i.sent(),[4,this.deviceAdapter.models.setDeviceConfig({DeviceId:this.deviceAdapter.explorerDeviceId,DeviceKey:exports.LLSyncConfig.BLE_PSK_DEVICE_KEY,DeviceValue:e})];case 2:return i.sent(),[2,e]}}))}))},t.prototype.reportBindEncryptedSuccess=function(t,e){return tslib_1.__awaiter(this,void 0,void 0,(function(){var n,i;return tslib_1.__generator(this,(function(s){switch(s.label){case 0:return this.reporter.info(constants.BIND_AUTH_SUCCESS,{identify:this.deviceAdapter.userIdentify,timeCost:Date.now()-t,secretkey:e}),n=this.deviceAdapter.encrypt("BindResult0",e),libs_1.log("bind result encrypted",n),[4,this.deviceAdapter.writeAndWait4Response(this._parseDataBeforeConnect(""+constants.DEVICE_INFO_WRITE_PREFIX[constants.RESPONSE_BIND]+n,constants.BIND_AUTH_SUCCESS),constants.RESPONSE_BIND,(function(t){return libs_1.log("result res data",t),{ack:parseInt(t[2],16),errCode:constants.BleErrorMsg[t[3]]}}),{writeId:constants.DEVICE_INFO_WRITE_ID,timeout:exports.LLSyncConfig.waitGetRegisterDeviceInfo,timeoutCode:constants.WAIT_REGISTER_DEVICE_INFO_REPLY_TIMEOUT})];case 1:if(1===(i=s.sent()).ack)throw{code:i.errCode};return[4,this.deviceAdapter.models.setDeviceConfig({DeviceId:this.deviceAdapter.explorerDeviceId,DeviceKey:exports.LLSyncConfig.Secret_Encrypt_Key,DeviceValue:e})];case 2:return s.sent(),[2,i]}}))}))},t.prototype.reportBindError=function(t){void 0===t&&(t="");var e=""+constants.DEVICE_INFO_WRITE_PREFIX[constants.BIND_AUTH_FAIL]+libs_1.str2hexStr(t);this.deviceAdapter.write(e,{writeId:constants.DEVICE_INFO_WRITE_ID})},t.prototype.reportBindEncryptedError=function(t){var e=this.deviceAdapter.encrypt("BindResult1",t);this.deviceAdapter.write(""+constants.DEVICE_INFO_WRITE_PREFIX[constants.RESPONSE_BIND]+e,{writeId:constants.DEVICE_INFO_WRITE_ID})},t.prototype.reportConnectError=function(){var t=constants.DEVICE_INFO_WRITE_PREFIX[constants.CONNECT_RESULT_WRITE_FAIL];this.deviceAdapter.write(t,{writeId:constants.DEVICE_INFO_WRITE_ID})},t.prototype.reportPropertyReportResult=function(t){void 0===t&&(t=0);var e=constants.DEVICE_DATA_WRITE_HEAD,n=constants.DEVICE_DATA_WRITE_SUFFIX,i=constants.REPORT_RESULT,s=constants.DEVICE_DATA_WRITE_ID,o=""+libs_1.getTypeHead(e[i],n[i])+byteUtil.byteToHex(byteUtil.convertNumberToByte(t));this.deviceAdapter.isEncrypted&&(o=this.deviceAdapter.encrypt(o,this.deviceAdapter.sessionKey,{contentType:"hex"})),this.deviceAdapter.writeData(o,{writeId:s})},t.prototype.reportEventReportResult=function(t,e){void 0===t&&(t=0);var n=constants.DEVICE_DATA_WRITE_HEAD,i=constants.EVENT_REPLY,s=constants.DEVICE_DATA_WRITE_ID,o=""+libs_1.getTypeHead(n[i],e)+byteUtil.byteToHex(byteUtil.convertNumberToByte(t));this.deviceAdapter.isEncrypted&&(o=this.deviceAdapter.encrypt(o,this.deviceAdapter.sessionKey,{contentType:"hex"})),this.deviceAdapter.writeData(o,{writeId:s})},t.prototype.reportGetStatusResult=function(t,e,n){void 0===t&&(t=0);var i=constants.DEVICE_DATA_WRITE_HEAD,s=constants.DEVICE_DATA_WRITE_SUFFIX,o=constants.GET_STATUS,r=constants.DEVICE_DATA_WRITE_ID,a=[""+libs_1.getTypeHead(i[o],s[o]),byteUtil.byteToHex(byteUtil.convertNumberToByte(t))];e&&(a=this.deviceAdapter.sliceData(a.concat(tslib_1.__spread([libs_1.U16ToHexString(e.length)],e)),n,constants.GET_STATUS)),this.deviceAdapter.isEncrypted&&(a=this.deviceAdapter.encrypt(a,this.deviceAdapter.sessionKey,{contentType:"hex"})),this.deviceAdapter.writeData(a,{writeId:r})},t.prototype.reportUnbindResult=function(t){if(this.deviceAdapter.isEncrypted){var e=this.deviceAdapter.encrypt("fail"===t?"UnbindFail":"UnbindOk",this.deviceAdapter.sessionKey);libs_1.log("unbind send payload",e);var n=""+constants.DEVICE_INFO_WRITE_PREFIX[constants.UNBIND_RESPONSE]+e,i=this._parseDataBeforeConnect(n,constants.UNBIND_RESPONSE);return this.deviceAdapter.writeData(i,{writeId:constants.DEVICE_INFO_WRITE_ID})}i=constants.DEVICE_INFO_WRITE_PREFIX[constants.UNBIND_RESULT_AUTH_SUCCESS];return"fail"===t&&(i=constants.DEVICE_INFO_WRITE_PREFIX[constants.UNBIND_RESULT_AUTH_FAIL]),this.deviceAdapter.write(i,{writeId:constants.DEVICE_INFO_WRITE_ID})},t.prototype.notifyAppReady=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var t,e,n,i;return tslib_1.__generator(this,(function(s){switch(s.label){case 0:return t=constants.DEVICE_INFO_WRITE_PREFIX,e=constants.APP_IS_READY,n=constants.DEVICE_INFO_WRITE_ID,i=t[e],this.reporter.info(e),[4,this.deviceAdapter.writeData(i,{writeId:n})];case 1:return s.sent(),[2]}}))}))},t.prototype.notifyAppOnIOSDevice=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var t,e,n,i;return tslib_1.__generator(this,(function(s){switch(s.label){case 0:return t=constants.DEVICE_INFO_WRITE_PREFIX,e=constants.APP_ON_IOS_DEVICE,n=constants.DEVICE_INFO_WRITE_ID,i=t[e],this.reporter.info(e),[4,this.deviceAdapter.writeData(i,{writeId:n})];case 1:return s.sent(),[2]}}))}))},t.prototype.notifyLocalRssi=function(t){var e=t.rssi;return tslib_1.__awaiter(this,void 0,void 0,(function(){var t,n,i,s,o;return tslib_1.__generator(this,(function(r){switch(r.label){case 0:return!Number.isSafeInteger(e)||e<-255||e>0?[2,Promise.reject({msg:"RSSI 取值超出范围",code:"INVALID_RSSI_VALUE"})]:(t=constants.DEVICE_INFO_WRITE_PREFIX,n=constants.NOTIFY_LOCAL_RSSI,i=constants.DEVICE_INFO_WRITE_ID,s=e+255,o=[t[n],s.toString(16).padStart(2,"0")].join(""),[4,this.deviceAdapter.writeData(o,{writeId:i})]);case 1:return r.sent(),[2]}}))}))},t.prototype.sendHeartbeat=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var t,e,n,i;return tslib_1.__generator(this,(function(s){switch(s.label){case 0:return t=constants.DEVICE_INFO_WRITE_PREFIX,e=constants.HEARTBEAT_REQ,n=constants.DEVICE_INFO_WRITE_ID,i=t[e],[4,this.deviceAdapter.writeData(i,{writeId:n})];case 1:return s.sent(),[2]}}))}))},t.prototype.getAdvertisingData=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var t=this;return tslib_1.__generator(this,(function(e){return this.reporter.info(constants.GET_ADV_DATA,{}),[2,this.deviceAdapter.writeAndWait4Response(constants.DEVICE_INFO_WRITE_PREFIX[constants.GET_ADV_DATA],constants.GET_ADV_DATA_REPLY,(function(e){if(e.length<20)throw{code:constants.GET_ADV_DATA_REPLY_INVALID};var n=parseInt(e[2],16);if(n)throw{code:constants.GET_ADV_DATA_FAIL,ack:n};var i=parseInt(e[3],16),s=3&i,o={bindState:s,isEncrypted:!!(i>>>3&1),isDynamicRegister:!!(i>>>2&1),moduleVersion:i>>>4};if(s===BindState.CONNECTED||s===BindState.HAS_BOUND){var r=e.slice(4,12).join("").toLocaleLowerCase(),a=e.slice(12,20).join("").toLocaleLowerCase();Object.assign(o,{deviceIdentify:r,deviceUserIdentify:a})}else{var c=e.slice(4,10).join(":"),_=libs_1.hex2str(e.slice(10,20));Object.assign(o,{macAddress:c,productId:_})}return t.reporter.info(constants.GET_ADV_DATA_RESULT,o),o}),{timeout:exports.LLSyncConfig.waitGetAdvDataReplyTime,timeoutCode:constants.WAIT_GET_ADV_DATA_REPLY_TIMEOUT,writeId:constants.DEVICE_INFO_WRITE_ID})]}))}))},t.prototype._parseDataBeforeConnect=function(t,e){void 0===this.deviceAdapter.extendInfo.moduleVersion&&console.warn("[LLsyncProtocol] invalid moduleVersion:",this.deviceAdapter.extendInfo.moduleVersion);var n,i=this.deviceAdapter.extendInfo.moduleVersion||2;i&&(n=exports.LLSyncConfig.mtuDefaultMap[i],i>=2&&(n=exports.LLSyncConfig.mtuDefaultMap[2])),this.reporter.info(constants.SET_MTU_BEFORE_CONNECT,{version:i,mtuLength:n}),this.deviceAdapter.bleVersion=i,this.deviceAdapter.mtu=n;var s=byteUtil.hexString2hexArray(t.slice(2)),o=[s],r=[t.slice(0,2)];return i>0&&r.push(libs_1.U16ToHexString(s.length)),r=r.concat(s),this.deviceAdapter.sliceData(r,o,e)},t}();exports.LLSyncProtocol=LLSyncProtocol,exports.isHeartbeatResp=function(t){return 4===t.length&&"1B"===t[0]&&"00"===t[1]&&"01"===t[2]&&"00"===t[3]};
//# sourceMappingURL=LLSyncProtocol.js.map