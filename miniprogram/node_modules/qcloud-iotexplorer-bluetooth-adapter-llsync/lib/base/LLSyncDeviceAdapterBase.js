"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.LLSyncDeviceAdapterBase=void 0;var tslib_1=require("tslib"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),utils=tslib_1.__importStar(require("../libs")),constants=tslib_1.__importStar(require("../constants")),qcloud_iotexplorer_bluetooth_adapter_1=require("qcloud-iotexplorer-bluetooth-adapter"),qcloud_iotexplorer_common_libs_1=require("qcloud-iotexplorer-common-libs"),LLSyncProtocol_1=require("./LLSync/LLSyncProtocol"),libs_1=require("../libs"),_a=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils,genPromise=_a.genPromise,delay=_a.delay,envDetect=_a.envDetect,LLSyncDeviceAdapterBase=function(e){function t(t){var r=e.call(this,t)||this;return r.on("message",r.notifyMessage.bind(r)),r.on("disconnect",(function(){r.writeDataQueue.cancelAllTasks({code:10006,errCode:10006,msg:"当前连接已断开",cause:"LLSyncDeviceAdapter disconnect event"})})),r.writeDataQueue=new qcloud_iotexplorer_common_libs_1.CancelableQueue({autoStart:!0,handler:function(e){var t=e.businessData,i=e.isCancelled;return r.writeDataInternal({params:t,isCancelled:i})},onTaskSuccess:function(e){var t=e.businessData;return"function"==typeof t.onSuccess&&t.onSuccess()},onTaskError:function(e,t){var r=t.businessData;return"function"==typeof r.onError&&r.onError(e)}}),r}return tslib_1.__extends(t,e),t.prototype.notifyMessage=function(e){var t=void 0===e?{}:e,r=t.type,i=t.data;if("unknown"!==r)return console.log("check this in notifyMessage",this,{type:r,data:i}),this.emit(r,{type:r,data:i})},t.prototype.handleBLEMessage=function(e){if(this.isEncrypted&&this.authorized&&!LLSyncProtocol_1.isHeartbeatResp(e)){var t=utils.decrypt(e.join(""),this.sessionKey).match(/[\da-f]{2}/gi);if(!t)return console.error("llsync decrypt ble message fail",e.join(""),this.sessionKey),{};e=t}var r=parseInt(e[0],16),i={type:constants.INDICATE_TYPE_MAP[r]||"unknown",data:e.splice(1)};return console.log("Message(hex)",i),i},t.prototype.wait4EventResponse=function(e,t,r){var i=void 0===r?{}:r,n=i.timeout,o=i.timeoutCode,s=i.timeoutHandler,a=i.wrapSplitDataMode,c=i.shouldWrapSplitDataFn,u=void 0===c||c,l=i.afterBindEvent;return tslib_1.__awaiter(this,void 0,void 0,(function(){var r,i,c,d,_,p=this;return tslib_1.__generator(this,(function(v){switch(v.label){case 0:r=genPromise(),console.log("wait4EventResponse",{eventName:e}),i=!1,c=function(n){return tslib_1.__awaiter(p,void 0,void 0,(function(){return tslib_1.__generator(this,(function(o){try{i?console.log("Target event: "+e+" triggered, but is already timeout"):(r.resolve(t(n)),i=!0)}catch(e){r.reject(e)}finally{this.off(e,d)}return[2]}))}))},d=u?utils.wrapEventHandler(c,a):c,this.on(e,d),v.label=1;case 1:return v.trys.push([1,5,,6]),"function"!=typeof l?[3,3]:[4,l()];case 2:v.sent(),v.label=3;case 3:return[4,Promise.race([r.promise,new Promise((function(t,r){n&&n>0&&setTimeout((function(){i||(libs_1.log("Wait for target event: "+e+" timeout"),i=!0,p.off(e,d),"function"==typeof s?(console.log("trigger timeout handler"),t(s())):r({code:o}))}),n)}))])];case 4:return[2,v.sent()];case 5:return _=v.sent(),this.off(e,d),[2,Promise.reject(_)];case 6:return[2]}}))}))},t.prototype.writeAndWait4Response=function(e,t,r,i){var n=void 0===i?{}:i,o=n.timeout,s=n.timeoutCode,a=n.timeoutHandler,c=n.writeId,u=n.wrapSplitDataMode,l=n.shouldWrapSplitDataFn,d=void 0===l||l;return tslib_1.__awaiter(this,void 0,void 0,(function(){var i=this;return tslib_1.__generator(this,(function(n){return libs_1.log("data2Write:",e),[2,this.wait4EventResponse(t,r,{timeout:o,timeoutCode:s,timeoutHandler:a,wrapSplitDataMode:u,shouldWrapSplitDataFn:d,afterBindEvent:function(){return i.writeData(e,{writeId:c}).catch((function(e){return Promise.reject(tslib_1.__assign({code:constants.BLE_WRITE_ERROR},e))}))}})]}))}))},t.prototype.writeMtuResult=function(e){var t="success"===e?0:65535,r=""+constants.DEVICE_INFO_WRITE_PREFIX[constants.WRITE_MTU_RESULT]+libs_1.U16ToHexString(t);this.write(r,{writeId:constants.DEVICE_INFO_WRITE_ID})},t.prototype.sliceData=function(e,t,r){var i=this.mtu;if(this.isEncrypted&&(i=libs_1.getMtuEncrypted(this.mtu)),!this.mtu||e.join("").length<=2*i)return[e.join("")];var n=e.slice(0,r===constants.GET_STATUS?2:1);return console.log("---head----",n),utils.sliceData(t,{mtu:i,head:n,mode:r})},t.prototype.writeData=function(e,t){var r=this;return void 0===t&&(t={}),new Promise((function(i,n){r.writeDataQueue.push(tslib_1.__assign({data:e,onSuccess:i,onError:n},t))}))},t.prototype.setMtu=function(e){return tslib_1.__awaiter(this,void 0,void 0,(function(){var t;return tslib_1.__generator(this,(function(r){switch(r.label){case 0:return envDetect.isIOS?[2]:[4,this.setBLEMTU({deviceId:this.deviceId,mtu:e})];case 1:return t=r.sent(),this.reporter.info(constants.ANDROID_SET_MTU,{mtu:e,ret:t}),[2,t]}}))}))},t.prototype.writeDataInternal=function(e){var t=e.params,r=e.isCancelled;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,i,n,o,s,a,c,u,l,d,_;return tslib_1.__generator(this,(function(p){switch(p.label){case 0:e=t.data,i=t.writeId,n=t.waitGap,o=void 0===n?0:n,s=t.retryTime,a=void 0===s?5:s,Array.isArray(e)||(e=[e]),c=0,p.label=1;case 1:return c<e.length?(u=e[c],0!==c&&o>0?[4,delay(o)]:[3,3]):[3,11];case 2:p.sent(),p.label=3;case 3:l=a,p.label=4;case 4:if(r())return[2,Promise.reject({code:constants.WRITE_DATA_CANCEL_ERROR_CODE})];p.label=5;case 5:return p.trys.push([5,7,,9]),[4,this.write(u,{writeId:i})];case 6:return p.sent(),[3,10];case 7:if(d=p.sent(),console.log("--- LLSync core writeData error ---- retry time "+l,d),--l<=0)throw d;return _=o>0?o:100,[4,delay(Math.min(10*_*(a-l),constants.MAX_WRITE_DATA_WAIT_GAP))];case 8:return p.sent(),[3,9];case 9:if(l>0)return[3,4];p.label=10;case 10:return c++,[3,1];case 11:return[2]}}))}))},t}(qcloud_iotexplorer_bluetooth_adapter_1.DeviceAdapter);exports.LLSyncDeviceAdapterBase=LLSyncDeviceAdapterBase;
//# sourceMappingURL=LLSyncDeviceAdapterBase.js.map