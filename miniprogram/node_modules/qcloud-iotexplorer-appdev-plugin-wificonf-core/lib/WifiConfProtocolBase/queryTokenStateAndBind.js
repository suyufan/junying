"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.queryTokenStateAndBind=void 0;var tslib_1=require("tslib"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),constants_1=require("../constants"),utils_1=require("../utils"),getBindState=function(e,t){return e.requestApi("AppGetDeviceBindTokenState",{Token:t},{isTokenApi:!0})},getMultiBindState=function(e,t){return e.requestApi("AppGetMultiDeviceBindTokenState",{Token:t},{isTokenApi:!0})};function queryTokenStateAndBind(e){var t,r,o,n,i,d=e.token,s=e.productId,u=e.deviceName,a=e.familyId,c=e.roomId,l=e.onProgress,_=e.sdk,p=e.skipBind,S=void 0!==p&&p,v=e.newTokenVersion,E=void 0!==v&&v;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,p,v,I,T,k,D,N;return tslib_1.__generator(this,(function(m){switch(m.label){case 0:e=E?"v3.0":"v2.0",p=Date.now(),l({code:constants_1.WifiConfStepCode.BUSINESS_QUERY_TOKEN_STATE_START,detail:{data:{Token:d}},reportEvents:["queryToken"]}),m.label=1;case 1:return m.trys.push([1,6,,7]),console.log("protoVersion ",e,"newTokenVersion",E),E?[4,utils_1.pollRequest({request:function(){return getMultiBindState(_,d)},checkResp:function(e){var t;console.log("checkrespv3",e);var r=e.Data;return!(!r||!Array.isArray(r))&&2===(null===(t=r[0])||void 0===t?void 0:t.State)},reporter:_.reporter,maxIgnoreErrorTimes:15})]:[3,3];case 2:if(I=m.sent(),null==(v=I.Data)?void 0:v[0]){try{s===(null===(t=v[0])||void 0===t?void 0:t.ProductId)&&u===(null===(r=v[0])||void 0===r?void 0:r.DeviceName)||null===(o=null==_?void 0:_.reporter)||void 0===o||o.info("QUERY_TOKEN_DEVICE_INFO_INCORRECT",{data:tslib_1.__assign({productIdFromDeviceReport:s,deviceNameFromDeviceReport:u},v[0])})}catch(e){console.error(e)}s=null===(n=v[0])||void 0===n?void 0:n.ProductId,u=null===(i=v[0])||void 0===i?void 0:i.DeviceName}return[3,5];case 3:return[4,utils_1.pollRequest({request:function(){return getBindState(_,d)},checkResp:function(e){return 2===e.State},reporter:_.reporter,maxIgnoreErrorTimes:15})];case 4:if(I=m.sent(),!(s&&u||(T=I.ProductId,k=I.DeviceName,s=T,u=k,T)))throw{code:"BUSINESS_QUERY_PRODUCTID_NOT_FOUND"};m.label=5;case 5:return[3,7];case 6:throw(D=m.sent())&&"POLL_REQUEST_TIMEOUT"===D.code?{code:"BUSINESS_QUERY_BIND_TOKEN_TIMEOUT"}:{code:"BUSINESS_QUERY_BIND_TOKEN_FAIL",detail:D,msg:qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.tips.getErrorMsg(D),reqId:null==D?void 0:D.reqId};case 7:if(l({code:constants_1.WifiConfStepCode.BUSINESS_QUERY_TOKEN_STATE_SUCCESS,detail:{protoVersion:e,timeCost:Date.now()-p},reportEvents:["queryToken"]}),console.log("new tokenVersion query token come to return"),S||E)return[2,{productId:s,deviceName:u}];l({code:constants_1.WifiConfStepCode.BUSINESS_ADD_DEVICE_START,detail:{data:{Token:d,ProductId:s,DeviceName:u,FamilyId:a,RoomId:c},protoVersion:e},reportEvents:["addDevice"]}),m.label=8;case 8:return m.trys.push([8,10,,11]),[4,utils_1.tryRequest((function(){return _.requestApi("AppTokenBindDeviceFamily",{FamilyId:a,ProductId:s,DeviceName:u,Token:d,RoomId:c},{isTokenApi:!0})}),{reporter:_.reporter})];case 9:return m.sent(),[3,11];case 10:return N=m.sent(),[2,Promise.reject({code:"BUSINESS_ADD_DEVICE_FAIL",detail:N,msg:qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.tips.getErrorMsg(N),reqId:N.reqId})];case 11:return l({code:constants_1.WifiConfStepCode.BUSINESS_ADD_DEVICE_SUCCESS}),[2,{productId:s,deviceName:u}]}}))}))}exports.queryTokenStateAndBind=queryTokenStateAndBind;
//# sourceMappingURL=queryTokenStateAndBind.js.map