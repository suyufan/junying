"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.WifiConfProtocolBase=void 0;var tslib_1=require("tslib"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),constants_1=require("../constants"),utils_1=require("../utils"),issueHandler_1=require("./issueHandler"),queryTokenStateAndBind_1=require("./queryTokenStateAndBind"),WifiConfProtocolBase=function(e){function o(o,t){var s=e.call(this)||this;return s.connectAborted=!1,s.options={udpPort:8266,stepInterval:1e3,familyId:"default",autoRetry:!1,autoBind:!0},s.sdk=o,Object.assign(s.options,t),s}return tslib_1.__extends(o,e),o.prototype.onProgress=function(e){"function"==typeof this.options.onProgress&&this.options.onProgress(e)},o.prototype.onComplete=function(e){"function"==typeof this.options.onComplete&&this.options.onComplete(e)},o.prototype.onError=function(e){"function"==typeof this.options.onError&&this.options.onError(e)},o.prototype.start=function(e){var o=(void 0===e?{}:e).doNotRetry,t=void 0!==o&&o;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,o,s,r,n,i,d,a,c,p,u,_=this;return tslib_1.__generator(this,(function(l){switch(l.label){case 0:this.onProgress({code:constants_1.WifiConfStepCode.WIFI_CONF_START}),e=this.options.targetWifiInfo,o=e.SSID,s=e.BSSID,r=e.password,this.onProgress({code:constants_1.WifiConfStepCode.PROTOCOL_START,detail:{SSID:o,password:r},reportEvents:["配网","发送wifi"]}),l.label=1;case 1:l.trys.push([1,7,,10]),n=Date.now(),i=void 0,l.label=2;case 2:return l.trys.push([2,4,,5]),[4,this.doProtocol({SSID:o,BSSID:s,password:r})];case 3:return d=l.sent(),i=d?d.address:null,[3,5];case 4:throw a=l.sent(),console.error(a),tslib_1.__assign({code:"PROTOCOL_FAIL"},a);case 5:if(!i)throw{code:"PROTOCOL_INVALID_RESPONSE"};return this.onProgress({code:constants_1.WifiConfStepCode.PROTOCOL_SUCCESS,detail:{data:{address:i},timeCost:Date.now()-n},reportEvents:["发送wifi"]}),[4,this.doBusiness({address:i})];case 6:return c=l.sent(),this.onProgress({code:constants_1.WifiConfStepCode.WIFI_CONF_SUCCESS,detail:tslib_1.__assign({timeCost:Date.now()-n},c),reportEvents:["配网"]}),this.onComplete(c),[3,10];case 7:return p=l.sent(),console.error(p),p&&p.code in constants_1.WifiConfErrorMsg&&(p.uiMsg=constants_1.WifiConfErrorMsg[p.code]),t||!this.options.autoRetry?[3,9]:[4,issueHandler_1.issueHandler({error:p,targetWifiInfo:this.options.targetWifiInfo,wifiConfType:this.options.wifiConfType,onProgress:function(e){_.onProgress.call(_,e)}})];case 8:if(u=l.sent(),console.log("handle udp error, isHandled: "+u),u)return this.onProgress({code:constants_1.WifiConfStepCode.WIFI_CONF_AUTO_RETRY}),[2,this.start({doNotRetry:!0})];l.label=9;case 9:return this.connectAborted=!0,this.onProgress({code:constants_1.WifiConfStepCode.WIFI_CONF_FAIL,detail:{error:p}}),this.onError({code:"WIFI_CONF_FAIL",detail:{error:p}}),[3,10];case 10:return[2]}}))}))},o.prototype.doProtocol=function(e){throw new Error("子类必须自行实现自己协议传输逻辑")},o.prototype.doBusiness=function(e){var o=e.address;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,t,s,r,n,i,d=this;return tslib_1.__generator(this,(function(a){switch(a.label){case 0:return this.onProgress({code:constants_1.WifiConfStepCode.BUSINESS_START}),this.onProgress({code:constants_1.WifiConfStepCode.CREATE_UDP_CONNECTION_START,reportEvents:["udp"]}),e=Date.now(),t=new utils_1.UdpServer({address:o,port:this.options.udpPort,sdk:this.sdk}),s=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.genPromise(),r=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.genPromise(),t.onError((function(e){return s.reject({code:"UDP_ERROR",errMsg:e})})),t.onProgressError((function(e){return r.reject({code:"BUSINESS_DEVICE_ERROR",message:e})})),n=function(){return tslib_1.__awaiter(d,void 0,void 0,(function(){var o,s,r,n,i,d,a,c=this;return tslib_1.__generator(this,(function(p){switch(p.label){case 0:return p.trys.push([0,7,,8]),o=function(e){return tslib_1.__awaiter(c,void 0,void 0,(function(){return tslib_1.__generator(this,(function(o){switch(o.label){case 0:return[4,qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.delay(e||this.options.stepInterval)];case 1:return o.sent(),this.connectAborted&&qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.logger.debug("connection aborted"),[2]}}))}))},[4,o()];case 1:return p.sent(),s="2.0",r={},console.log("getDeviceExtendInfo",this.options.getDeviceExtendInfo),"function"!=typeof this.options.getDeviceExtendInfo?[3,3]:[4,this.options.getDeviceExtendInfo({udpServer:t})];case 2:r=p.sent(),p.label=3;case 3:return[4,t.send(tslib_1.__assign({cmdType:0,token:this.options.wifiConfToken},r),{validateResponse:function(e){return console.log("cmdType",e.cmdType),2==+e.cmdType}})];case 4:return n=p.sent(),this.onProgress({code:constants_1.WifiConfStepCode.CREATE_UDP_CONNECTION_SUCCESS,detail:{data:n,timeCost:Date.now()-e,protoVersion:s},reportEvents:["udp"]}),t.destroy(),[4,o()];case 5:return p.sent(),i=n.productId,d=n.deviceName,[4,queryTokenStateAndBind_1.queryTokenStateAndBind({token:this.options.wifiConfToken,productId:i,deviceName:d,familyId:this.options.familyId,roomId:this.options.roomId,onProgress:function(e){c.onProgress.call(c,e)},sdk:this.sdk,newTokenVersion:this.options.newTokenVersion})];case 6:return p.sent(),[2,{productId:i,deviceName:d}];case 7:throw a=p.sent(),t.destroy(),a;case 8:return[2]}}))}))},[4,Promise.race([n(),s.promise,r.promise])];case 1:return i=a.sent(),this.onProgress({code:constants_1.WifiConfStepCode.BUSINESS_SUCCESS,detail:{response:i},reportEvents:["addDevice"]}),[2,i]}}))}))},o}(qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.EventEmitter);exports.WifiConfProtocolBase=WifiConfProtocolBase;
//# sourceMappingURL=WifiConfProtocolBase.js.map