"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.issueHandler=void 0;var tslib_1=require("tslib"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),constants_1=require("../constants"),wxApis_1=tslib_1.__importDefault(require("../utils/wxApis")),utils_1=require("../utils"),delay=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.delay,UDP_ERROR_WAIT_RETRY_TIME=1500,WIFI_CONNECT_WAIT_RETRY_TIME=4e3,handleWifiIssue=function(e){var t=e.error,r=e.targetWifiInfo,s=e.onProgress;return tslib_1.__awaiter(void 0,void 0,void 0,(function(){var e,o,i,n,_,a,c,d;return tslib_1.__generator(this,(function(l){switch(l.label){case 0:s({code:constants_1.WifiConfStepCode.AUTO_HANDLE_WIFI_PROBLEM_START,detail:{targetWifiInfo:r}}),l.label=1;case 1:return l.trys.push([1,12,,13]),e=t.code,o=void 0===e?" ":e,i=t.errMsg,n=void 0===i?"":i,utils_1.checkIsIOS()?new RegExp(/no route to host/i).test(n)?[4,qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.tips.showModal({title:"需要先开启微信本地网络权限才能继续配网",confirmText:"去开启",confirmColor:qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.constants.themeColorMap.primary,cancelText:"取消",cancelColor:qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.constants.themeColorMap.danger})]:[3,7]:[3,7];case 2:return l.sent()?[3,3]:[2,!1];case 3:return l.trys.push([3,6,,7]),[4,wxApis_1.default.getWifiList()];case 4:return l.sent(),[4,new Promise((function(e){wxApis_1.default.onAppShow((function(){e(!0)}))}))];case 5:return l.sent(),s({code:constants_1.WifiConfStepCode.AUTO_HANDLE_WIFI_NO_ROUTE,detail:{msg:"处理用户本地网络设置开关没打开的情况"}}),[2,!0];case 6:return _=l.sent(),console.log("handle no route error fail",_),[2,!1];case 7:return[4,wxApis_1.default.getConnectedWifi()];case 8:return(a=l.sent().wifi)&&a.SSID===r.SSID?"UDP_SEND_MSG_FAIL"!==o&&"UDP_ERROR"!==o?[3,10]:[4,delay(UDP_ERROR_WAIT_RETRY_TIME)]:[3,11];case 9:return l.sent(),s({code:constants_1.WifiConfStepCode.AUTO_HANDLE_WIFI_PROBLEM_SUCCESS,detail:{msg:"UDP错误，或许是连接wifi的延迟，直接重试下"}}),[2,!0];case 10:return s({code:constants_1.WifiConfStepCode.AUTO_HANDLE_WIFI_PROBLEM_CANCEL,detail:{msg:"当前连接的wifi正确，不需要处理"}}),[2,!1];case 11:return[3,13];case 12:return c=l.sent(),console.error("getConnectedWifi failed",c),c.errCode&&12010!==c.errCode?(s({code:constants_1.WifiConfStepCode.AUTO_HANDLE_WIFI_PROBLEM_CANCEL,detail:tslib_1.__assign({msg:"获取当前连接的wifi出错 "},c)}),[2,!1]):[3,13];case 13:return l.trys.push([13,17,,19]),[4,wxApis_1.default.startWifi()];case 14:return l.sent(),[4,wxApis_1.default.connectWifi({SSID:r.SSID,password:r.password})];case 15:return l.sent(),[4,delay(WIFI_CONNECT_WAIT_RETRY_TIME)];case 16:return l.sent(),s({code:constants_1.WifiConfStepCode.AUTO_HANDLE_WIFI_PROBLEM_SUCCESS,detail:{handled:!0}}),[2,!0];case 17:return d=l.sent(),console.error(d),qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.logger.debug("connectWifi fail",d),[4,qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.tips.showModal({title:"手机连接"+r.SSID+"失败，请在设置页面手动切换到"+r.SSID+"再继续",confirmText:"继续",confirmColor:qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.constants.themeColorMap.primary,cancelText:"取消",cancelColor:qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.constants.themeColorMap.danger})];case 18:return l.sent()?(s({code:constants_1.WifiConfStepCode.AUTO_HANDLE_WIFI_PROBLEM_SUCCESS,detail:{msg:"自动连接的wifi错误，用户设置自动连接"}}),[2,!0]):(s({code:constants_1.WifiConfStepCode.AUTO_HANDLE_WIFI_PROBLEM_CANCEL,detail:{msg:"自动连接的wifi错误，用户取消自动连接"}}),[2,!1]);case 19:return[2]}}))}))};exports.issueHandler=function(e){var t=e.error,r=e.targetWifiInfo,s=e.wifiConfType,o=e.onProgress,i=e.softAPInfo;return tslib_1.__awaiter(void 0,void 0,void 0,(function(){var e;return tslib_1.__generator(this,(function(n){switch(n.label){case 0:switch(e=!1,t.code){case"PROTOCOL_TIMEOUT":case"CONNECT_SMARTCONFIG_FAIL":return[3,1];case"UDP_ERROR":case"UDP_SEND_MSG_FAIL":return[3,3]}return[3,9];case 1:return"SoftAp"===s?[3,3]:[4,handleWifiIssue({error:t,targetWifiInfo:r,onProgress:o})];case 2:e=n.sent(),n.label=3;case 3:return"SoftAp"!==s?[3,6]:i?[4,handleWifiIssue({error:t,targetWifiInfo:i,onProgress:o})]:[3,5];case 4:e=n.sent(),n.label=5;case 5:return[3,8];case 6:return[4,handleWifiIssue({error:t,targetWifiInfo:r,onProgress:o})];case 7:e=n.sent(),n.label=8;case 8:case 9:return[3,10];case 10:return[2,e]}}))}))};
//# sourceMappingURL=issueHandler.js.map