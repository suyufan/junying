"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.UdpServer=void 0;var tslib_1=require("tslib"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),decodeUdpMsg=function(e){var r=new Uint8Array(e),t=String.fromCharCode.apply(null,r);return decodeURIComponent(escape(t))},UdpServer=function(){function e(e){var r=this,t=e.address,s=e.port,o=e.sdk,n=e.retryTime,a=void 0===n?5:n,i=e.retryGap,d=void 0===i?2e3:i,l=e.failRetryGap,p=void 0===l?200:l,c=e.messageNoParse,u=void 0!==c&&c,_=e.retryWhenFail,h=void 0!==_&&_;Object.assign(this,{address:t,port:s,sdk:o,retryTime:a,retryGap:d,messageNoParse:u,retryWhenFail:h,failRetryGap:p});var f=this.socket=wx.createUDPSocket();f.bind(this.port);var v=function(e){return r._onErrorHandler(e)},g=function(e){return r._onMessageHandler(e)};f.onError(v),f.onMessage(g),this.destroy=function(){r.socket.offError(v),r.socket.offMessage(g),r.socket.close()}}return e.prototype._onErrorHandler=function(e){"function"==typeof this._errorHandler?this._errorHandler(e):console.warn("UdpServer unhandled error",e)},e.prototype._onMessageHandler=function(e){var r,t,s;try{if(this.messageNoParse){var o=decodeUdpMsg(e.message);return null===(r=this.sdk)||void 0===r||r.reporter.info("udp-on-message",{data:{message:o}}),void("function"==typeof this._msgHandler?this._msgHandler(o):console.warn("UdpServer unhandled msg",o))}var n=JSON.parse(decodeUdpMsg(e.message));null===(t=this.sdk)||void 0===t||t.reporter.info("udp-on-message",{data:{message:n}}),this._cmdTypeHandler(n)}catch(e){null===(s=this.sdk)||void 0===s||s.reporter.info("udp-parse-message-error",{error:e})}},e.prototype._cmdTypeHandler=function(e){var r,t=this,s=function(e){"function"==typeof t._msgHandler?t._msgHandler(e):console.warn("UdpServer unhandled msg",e)};switch(console.log("------",e),+e.cmdType){case 2:"Current_Error"===e.deviceReply?this._onProgressErrorHandler({code:"BUSINESS_DEVICE_ERROR",detail:e}):"Previous_Error"===e.deviceReply?null===(r=this.sdk)||void 0===r||r.reporter.info("softap-receive-prev-error",{data:{message:e}}):s(e);break;case 5:case 7:s(e)}},e.prototype._onProgressErrorHandler=function(e){"function"==typeof this._progressErrorHandler?this._progressErrorHandler(e):console.warn("UdpServer unhandled progress error",e)},e.prototype.onError=function(e){return this._errorHandler=e,this},e.prototype.onProgressError=function(e){return this._progressErrorHandler=e,this},e.prototype.onMessage=function(e){return this._msgHandler=e,this},e.prototype._send=function(e){"string"!=typeof e&&(e=JSON.stringify(e)),this.socket.send({address:this.address,port:this.port,message:e})},e.prototype.send=function(e,r){var t=this,s=(void 0===r?{}:r).validateResponse;return this.aborted=!1,new Promise((function(r,o){return tslib_1.__awaiter(t,void 0,void 0,(function(){var t,n,a,i,d,l,p,c=this;return tslib_1.__generator(this,(function(u){switch(u.label){case 0:u.trys.push([0,9,,10]),t=!0,n=0,a=0,this.onMessage((function(e){try{t=!1,(!s||"function"==typeof s&&!0===s(e))&&r(e)}catch(e){o(e)}})),i=function(){var r,t;null===(t=null===(r=c.sdk)||void 0===r?void 0:r.reporter)||void 0===t||t.info("udp-send-msg",{data:{msg:e,retryCount:n,failRetryCount:a}}),c._send(e)},u.label=1;case 1:return u.trys.push([1,2,,6]),i(),[3,6];case 2:return d=u.sent(),console.log("come handle udp error",a),this.retryWhenFail?(l=function(){return tslib_1.__awaiter(c,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:console.log("retry send udp"),e.label=1;case 1:return e.trys.push([1,5,,7]),a<this.retryTime?[4,qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.delay(this.failRetryGap)]:[3,3];case 2:return e.sent(),a++,i(),[3,4];case 3:o(tslib_1.__assign({code:"UDP_SEND_MSG_FAIL"},d)),e.label=4;case 4:return[3,7];case 5:return e.sent(),[4,l()];case 6:return e.sent(),[3,7];case 7:return[2]}}))}))},[4,l()]):[3,4];case 3:return u.sent(),[3,5];case 4:o(tslib_1.__assign({code:"UDP_SEND_MSG_FAIL"},d)),u.label=5;case 5:return[3,6];case 6:return!this.aborted&&t&&n<=this.retryTime?[4,qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.delay(this.retryGap)]:[3,8];case 7:return u.sent(),this.aborted?[2,o(null)]:t?(n++,i(),[3,6]):[2];case 8:return this.aborted?[2,o(null)]:(o({code:"UDP_NOT_RESPONSE"}),[3,10]);case 9:return p=u.sent(),o(tslib_1.__assign({code:"UDP_SEND_MSG_FAIL"},p)),[3,10];case 10:return[2]}}))}))}))},e.prototype.abort=function(){this.aborted=!0},e}();exports.UdpServer=UdpServer;
//# sourceMappingURL=UdpServer.js.map