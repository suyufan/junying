"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.pollRequest=void 0;var tslib_1=require("tslib"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),tryRequest_1=require("./tryRequest"),DEFAULT_MAX_QUERY_TIMES=20,DEFAULT_MAX_IGNORE_ERROR_TIMES=20,DEFAULT_QUERY_GAP=2e3,resolveParams=function(e){var r=e.maxQueryTimes||DEFAULT_MAX_QUERY_TIMES,t=e.maxIgnoreErrorTimes||DEFAULT_MAX_IGNORE_ERROR_TIMES,s=e.queryGap||DEFAULT_QUERY_GAP;if(r=Math.max(r,t),t=Math.min(r,t),"function"!=typeof e.request)throw new Error("PollRequestProps request must be a function");return tslib_1.__assign(tslib_1.__assign({},e),{maxQueryTimes:r,maxIgnoreErrorTimes:t,queryGap:s})};exports.pollRequest=function(e){return tslib_1.__awaiter(this,void 0,void 0,(function(){var r,t,s,o,u,_,i,l,a,n,p;return tslib_1.__generator(this,(function(c){switch(c.label){case 0:r=resolveParams(e),t=r.maxQueryTimes,s=r.maxIgnoreErrorTimes,o=r.queryGap,u=r.request,_=r.checkResp,i=r.reporter,l=0,a=0,c.label=1;case 1:if(qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.logger.debug("poll request retryTime",l),qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.logger.debug("poll request errorTime",a),console.log("poll request time",l,a),!(a<s))return[3,7];c.label=2;case 2:return c.trys.push([2,4,,6]),[4,u()];case 3:return n=c.sent(),l++,[3,6];case 4:return p=c.sent(),a++,console.error("ignore request method error",p),[4,qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.delay(o)];case 5:return c.sent(),[3,1];case 6:return[3,9];case 7:return[4,tryRequest_1.tryRequest((function(){return u()}),{reporter:i})];case 8:n=c.sent(),l++,c.label=9;case 9:if(n&&("function"!=typeof _||!0===_(n)))return[3,11];if(l>=t)throw{code:"POLL_REQUEST_TIMEOUT"};return[4,qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.delay(o)];case 10:return c.sent(),[3,1];case 11:return[2,n]}}))}))};
//# sourceMappingURL=pollRequest.js.map