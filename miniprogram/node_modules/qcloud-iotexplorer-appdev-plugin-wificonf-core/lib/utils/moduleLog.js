"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.collectModuleLog=void 0;var tslib_1=require("tslib"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),constants_1=require("../constants"),UdpServer_1=require("./UdpServer"),wxApis_1=tslib_1.__importDefault(require("./wxApis")),util_1=require("./util"),MODULE_REPORT_AP_SSID="ESP-LOG-QUERY",MODULE_REPORT_AP_PASSWORD="86013388",MODULE_REPORT_AP_UDP_ADDRESS="192.168.4.1",MODULE_REPORT_AP_UDP_PORT="9876",MODULE_REPORT_AP_TIMEOUT=6e4,MODULE_REPORT_RETRY_TIMES=12,collectModuleLogInternal=function(e){var r=e.reporter,t=e.sdk;return tslib_1.__awaiter(void 0,void 0,void 0,(function(){var e,o,_,s,i,n,d;return tslib_1.__generator(this,(function(p){switch(p.label){case 0:return p.trys.push([0,,8,10]),e=Date.now(),r.info(constants_1.WifiConfStepCode.MODULE_REPORT_START),(o=util_1.checkIsAndroid())||qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.tips.showLoading("收集日志中"),r.info(constants_1.WifiConfStepCode.MODULE_REPORT_CONNECT_WIFI_START,{urgent:!0}),[4,wxApis_1.default.startWifi()];case 1:return p.sent(),[4,wxApis_1.default.connectWifi({SSID:MODULE_REPORT_AP_SSID,password:MODULE_REPORT_AP_PASSWORD})];case 2:return p.sent(),[4,wxApis_1.default.getConnectedWifi()];case 3:if(p.sent().wifi.SSID!==MODULE_REPORT_AP_SSID)throw{code:"WIFI_RECONNECT_FAIL"};o&&qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.tips.showLoading("收集日志中"),r.info(constants_1.WifiConfStepCode.MODULE_REPORT_CONNECT_WIFI_SUCCESS,{timeCost:Date.now()-e,shouldStopTemp:!0}),p.label=4;case 4:return p.trys.push([4,6,,7]),_=new UdpServer_1.UdpServer({address:MODULE_REPORT_AP_UDP_ADDRESS,port:MODULE_REPORT_AP_UDP_PORT,reporter:r,retryTime:MODULE_REPORT_RETRY_TIMES,retryGap:MODULE_REPORT_AP_TIMEOUT/MODULE_REPORT_RETRY_TIMES,messageNoParse:!0,sdk:t}),s=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.genPromise(),i=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.genPromise(),_.onError((function(e){return s.reject({code:"MODULE_REPORT_COMMUNICATE_AP_ERROR",detail:{errMsg:e}})})),_.onProgressError((function(e){return i.reject({code:"MODULE_REPORT_COMMUNICATE_AP_ERROR",detail:e})})),r.info(constants_1.WifiConfStepCode.MODULE_REPORT_COMMUNICATE_AP_START),[4,_.send({cmdType:3})];case 5:return n=p.sent(),r.info(constants_1.WifiConfStepCode.MODULE_REPORT_COMMUNICATE_AP_SUCCESS,{moudleDetail:n,timeCost:Date.now()-e}),[3,7];case 6:return d=p.sent(),r.error("MODULE_REPORT_COMMUNICATE_AP_ERROR",{error:d}),[3,7];case 7:return[3,10];case 8:return qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.tips.hideLoading(),[4,qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.delay(2e3)];case 9:return p.sent(),r.info(constants_1.WifiConfStepCode.MODULE_REPORT_COMMUNICATE_END,{shouldStopTemp:!1}),[7];case 10:return[2]}}))}))};exports.collectModuleLog=function(e){var r=e.reporter,t=e.doCollectModuleLog,o=void 0===t?collectModuleLogInternal:t,_=e.timeout,s=void 0===_?MODULE_REPORT_AP_TIMEOUT:_,i=e.sdk;return tslib_1.__awaiter(void 0,void 0,void 0,(function(){var e,t,_;return tslib_1.__generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),e=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.genPromise(),setTimeout((function(){e.reject({code:"MODULE_REPORT_TIMEOUT"})}),s),[4,Promise.race([e.promise,o({reporter:r,sdk:i})])];case 1:return n.sent(),qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.tips.showModal({title:"上报设备端日志成功",content:"收集成功，已上报给工程师处理",confirmText:"我知道了",showCancel:!1}),[2,!0];case 2:return t=n.sent(),(_=t&&(t.errCode||t.code))&&(_ in constants_1.WifiConfErrorMsg||_ in constants_1.WifiConfErrorMsg)&&(t.uiMsg=constants_1.WifiConfErrorMsg[_]),r.error("MODULE_REPORT_FAIL",{error:t}),qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.tips.showModal({title:"上报设备端日志失败",content:t.uiMsg||constants_1.WifiConfErrorMsg.MODULE_REPORT_ERROR,confirmText:"我知道了",showCancel:!1}),[2,!1];case 3:return[2]}}))}))};
//# sourceMappingURL=moduleLog.js.map