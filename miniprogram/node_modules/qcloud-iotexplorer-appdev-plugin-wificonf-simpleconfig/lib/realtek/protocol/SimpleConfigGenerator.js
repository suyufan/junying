"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SimpleConfigGenerator=void 0;var tslib_1=require("tslib"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),qcloud_iotexplorer_appdev_plugin_wificonf_core_1=require("qcloud-iotexplorer-appdev-plugin-wificonf-core"),SimpleConfigData_1=require("./SimpleConfigData"),realtekTaskParameter_1=require("../base/realtekTaskParameter"),byteUtil=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.byteUtil,arrayFill=qcloud_iotexplorer_appdev_plugin_wificonf_core_1.utils.arrayFill,UDPSocketClient=qcloud_iotexplorer_appdev_plugin_wificonf_core_1.utils.UDPSocketClient,UDPSocketServer=qcloud_iotexplorer_appdev_plugin_wificonf_core_1.utils.UDPSocketServer,SimpleConfigGenerator=function(e){function a(a,t,r,l,i){var s=e.call(this)||this;return s.mIsCancelled=!1,s.mDefaultMac="02:00:00:00:00:00",s.mEachPacketSendCounts=3,s.mPacketSendTimeIntervalMs=5,s.logger=console,console.log("inetAddress",l),s.mApBssid=t,s.mApSsid=a,s.mApPassword=r,s.mLocalIp=l,s.logger=i,s.init(),s}return tslib_1.__extends(a,e),a.prototype.init=function(){var e=this;this.resetSimpleConfig(),this.mSocketClient=new UDPSocketClient(realtekTaskParameter_1.SimpleConfigParam.UNICAST_SPORT),this.mSocketServer=new UDPSocketServer(this.mSocketClient.mSocket,realtekTaskParameter_1.SimpleConfigParam.WAIT_UDP_TOTAL_MILLISECOND),this.mSocketClient.on("udpSocketError",(function(a){var t=a.errMsg;console.error(t),e.emit("onError",{code:"UDP_ERROR",errMsg:t}),e.interrupt()}))},a.prototype.generate=function(){this.resetSimpleConfig(),this.setDefaultPin(""),this.setPin(""),this.setSSid(this.mApSsid),this.mApPassword&&this.setPassword(this.mApPassword),this.setIp(this.mLocalIp),this.configData.scGenRandom(),this.configData.generateKey(this.mDefaultMac),this.configData.encryptProfile()},a.prototype.resetSimpleConfig=function(){realtekTaskParameter_1.RtkSC.PlainTotalLen=256,arrayFill(realtekTaskParameter_1.RtkSC.PlainBuf,byteUtil.convertNumberToByte(0)),realtekTaskParameter_1.RtkSC.PlainCurrent=realtekTaskParameter_1.RtkSC.PlainBuf,realtekTaskParameter_1.RtkSC.PlainCurrentLen[0]=0,realtekTaskParameter_1.RecvACK.MaxCfgNum=0,arrayFill(realtekTaskParameter_1.RecvACK.Status,byteUtil.convertNumberToByte(0));for(var e=0;e<32;e++)arrayFill(realtekTaskParameter_1.RecvACK.Mac[e],byteUtil.convertNumberToByte(0)),arrayFill(realtekTaskParameter_1.RecvACK.Type[e],byteUtil.convertNumberToByte(0)),arrayFill(realtekTaskParameter_1.RecvACK.IPBuf[e],byteUtil.convertNumberToByte(0)),arrayFill(realtekTaskParameter_1.RecvACK.NameBuf[e],byteUtil.convertNumberToByte(0));realtekTaskParameter_1.RecvACK.IP=[],realtekTaskParameter_1.RecvACK.Name=[],this.mIsCancelled=!1,this.configData=new SimpleConfigData_1.SimpleConfigData},a.prototype.setSSid=function(e){null!==e&&(null===this.configData.scProfileAddSSID(realtekTaskParameter_1.RtkSC.PlainCurrent,realtekTaskParameter_1.RtkSC.PlainTotalLen,realtekTaskParameter_1.RtkSC.PlainCurrentLen,byteUtil.getBytesByString(e))&&this.logger.info("SSID is null"))},a.prototype.setPassword=function(e){null!==e&&(null===this.configData.scProfileAddPasswd(realtekTaskParameter_1.RtkSC.PlainCurrent,realtekTaskParameter_1.RtkSC.PlainTotalLen,realtekTaskParameter_1.RtkSC.PlainCurrentLen,byteUtil.getBytesByString(e))&&this.logger.info("password is null"))},a.prototype.setPin=function(e){null!==e&&e.length>0?(this.configData.Index=3,realtekTaskParameter_1.SimpleConfigParam.Local_PIN=e):(this.configData.Index=2,realtekTaskParameter_1.SimpleConfigParam.Local_PIN=realtekTaskParameter_1.SimpleConfigParam.Default_PIN)},a.prototype.setDefaultPin=function(e){null!==e&&e.length>0?realtekTaskParameter_1.SimpleConfigParam.Default_PIN=e:this.logger.info("Invalid PIN")},a.prototype.setIp=function(e){var a=this.configData.scProfileAddIP(realtekTaskParameter_1.RtkSC.PlainCurrent,realtekTaskParameter_1.RtkSC.PlainTotalLen,realtekTaskParameter_1.RtkSC.PlainCurrentLen,e);this.logger.info("IP is"+e),null==a&&this.logger.info("IP is null\n")},a.prototype.sendSync=function(e){for(var a=void 0===e?{}:e,t=a.type,r=void 0===t?"promise":t,l=a.callback,i=void 0===l?function(){}:l,s=this.configData.mcastUDPCreateSync(this.configData.Index,realtekTaskParameter_1.RtkSC.CryptLen[0]),n=[],o=0;o<9;o++){realtekTaskParameter_1.UDPMcast.SendLen=s[3*o];var k="239."+String(255&s[3*o])+"."+String(255&s[3*o+1])+"."+String(255&s[3*o+2]);this.configData.Flag&&(realtekTaskParameter_1.UDPMcast.IPAddr=k,n.push([realtekTaskParameter_1.UDPMcast.IPAddr,realtekTaskParameter_1.UDPMcast.SendLen]))}return this.sendUdp({type:r,callback:i,messages:n})},a.prototype.sendData=function(e){var a=void 0===e?{}:e,t=a.type,r=void 0===t?"promise":t,l=a.callback,i=void 0===l?function(){}:l,s=new Int8Array(6),n=[];s[0]=1,s[1]=0,s[2]=94;for(var o=0;o<realtekTaskParameter_1.RtkSC.CryptLen[0];o++)s[4]=0,s[3]=byteUtil.convertNumberToByte(o+9),realtekTaskParameter_1.UDPMcast.SendLen=o+9,s[5]=realtekTaskParameter_1.RtkSC.CryptBuf[o],s[4]=byteUtil.convertNumberToByte(realtekTaskParameter_1.SimpleConfigParam.CHECKSUM(s,6)),realtekTaskParameter_1.UDPMcast.IPAddr="239."+String(255&s[3])+"."+String(255&s[4])+"."+String(255&s[5]),n.push([realtekTaskParameter_1.UDPMcast.IPAddr,realtekTaskParameter_1.UDPMcast.SendLen]);return this.sendUdp({type:r,callback:i,messages:n})},a.prototype.sendUdp=function(e){var a=this,t=void 0===e?{}:e,r=t.type,l=void 0===r?"promise":r,i=t.callback,s=void 0===i?function(){}:i,n=t.messages,o=void 0===n?[]:n,k=function(e){if(e>=o.length||a.mIsCancelled)return s();var t=o[e],r=t[0],l=new Array(a.mEachPacketSendCounts);arrayFill(l,new Int8Array(t[1])),a.mSocketClient.sendDataSideBySide(l,0,l.length,r,realtekTaskParameter_1.UDPMcast.DestPort,a.mPacketSendTimeIntervalMs,(function(){k(e+1)}))};switch(l){case"promise":return new Promise((function(e,t){return tslib_1.__awaiter(a,void 0,void 0,(function(){var a,t;return tslib_1.__generator(this,(function(r){switch(r.label){case 0:a=0,r.label=1;case 1:return a<o.length&&!this.mIsCancelled?(t=new Array(this.mEachPacketSendCounts),arrayFill(t,new Int8Array(o[a][1])),[4,this.mSocketClient.sendData(t,0,t.length,o[a][0],realtekTaskParameter_1.UDPMcast.DestPort,this.mPacketSendTimeIntervalMs)]):[3,5];case 2:return r.sent(),[4,qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.delay(this.mPacketSendTimeIntervalMs)];case 3:r.sent(),r.label=4;case 4:return a++,[3,1];case 5:return e(),[2]}}))}))}));case"callback":return k(0)}},a.prototype.handleCfgACK=function(e){var a,t=0,r=0,l=e[1]<<8&65280|255&e[2];if(console.log("handleCfgACK: "+l),l<13)return this.logger.error("Received format error"),[-1];if(realtekTaskParameter_1.RecvACK.MaxCfgNum>32)return this.logger.error("Receive buf is full"),[-1];if(realtekTaskParameter_1.RecvACK.MaxCfgNum>0)for(t=0;t<realtekTaskParameter_1.RecvACK.MaxCfgNum;t++){for(var i=0;i<6;i++)e[3+i]===realtekTaskParameter_1.RecvACK.Mac[t][i]&&r++;if(6===r)break;r=0}for(a=0;a<4&&0===e[12+a];a++);var s="";if(4!==a&&null!=realtekTaskParameter_1.RecvACK.IP[t]&&realtekTaskParameter_1.RecvACK.IP[t].length>0){for(byteUtil.arrayCopy(e,3,realtekTaskParameter_1.RecvACK.Mac[t],0,6),a=0;a<6;a++)s+=byteUtil.convertByte2HexString(byteUtil.convertByte2Uint8(realtekTaskParameter_1.RecvACK.Mac[t][a])),a<5&&(s+=":");byteUtil.arrayCopy(e,12,realtekTaskParameter_1.RecvACK.IPBuf[t],0,4),realtekTaskParameter_1.RecvACK.IP[t]=byteUtil.convertByte2Uint8(realtekTaskParameter_1.RecvACK.IPBuf[t][0])+("."+byteUtil.convertByte2Uint8(realtekTaskParameter_1.RecvACK.IPBuf[t][1]))+"."+byteUtil.convertByte2Uint8(realtekTaskParameter_1.RecvACK.IPBuf[t][2])+"."+byteUtil.convertByte2Uint8(realtekTaskParameter_1.RecvACK.IPBuf[t][3]),this.logger.info("Refresh IP: "+realtekTaskParameter_1.RecvACK.IP[t]+" of MAC: "+s)}if(this.sendCfgAckPacket(),6===r)return[0,s,realtekTaskParameter_1.RecvACK.IP[t]];byteUtil.arrayCopy(e,3,realtekTaskParameter_1.RecvACK.Mac[realtekTaskParameter_1.RecvACK.MaxCfgNum],0,6),s="";for(var n=0;n<6;n++)s+=byteUtil.convertByte2HexString(byteUtil.convertByte2Uint8(realtekTaskParameter_1.RecvACK.Mac[realtekTaskParameter_1.RecvACK.MaxCfgNum][n])),n<5&&(s+=":");if(this.logger.info("Added MAC: "+s),l>7&&(realtekTaskParameter_1.RecvACK.Status[realtekTaskParameter_1.RecvACK.MaxCfgNum]=e[9]),l>9&&byteUtil.arrayCopy(e,10,realtekTaskParameter_1.RecvACK.Type[realtekTaskParameter_1.RecvACK.MaxCfgNum],0,2),l>13&&(byteUtil.arrayCopy(e,12,realtekTaskParameter_1.RecvACK.IPBuf[realtekTaskParameter_1.RecvACK.MaxCfgNum],0,4),realtekTaskParameter_1.RecvACK.IP[realtekTaskParameter_1.RecvACK.MaxCfgNum]=byteUtil.convertByte2Uint8(255&realtekTaskParameter_1.RecvACK.IPBuf[realtekTaskParameter_1.RecvACK.MaxCfgNum][0])+("."+byteUtil.convertByte2Uint8(255&realtekTaskParameter_1.RecvACK.IPBuf[realtekTaskParameter_1.RecvACK.MaxCfgNum][1]))+"."+byteUtil.convertByte2Uint8(255&realtekTaskParameter_1.RecvACK.IPBuf[realtekTaskParameter_1.RecvACK.MaxCfgNum][2])+"."+byteUtil.convertByte2Uint8(255&realtekTaskParameter_1.RecvACK.IPBuf[realtekTaskParameter_1.RecvACK.MaxCfgNum][3]),this.logger.info("IP: "+realtekTaskParameter_1.RecvACK.IP[realtekTaskParameter_1.RecvACK.MaxCfgNum]),this.sendCfgAckPacket()),l>14){byteUtil.arrayCopy(e,16,realtekTaskParameter_1.RecvACK.NameBuf[realtekTaskParameter_1.RecvACK.MaxCfgNum],0,64);var o="";try{o=byteUtil.utf8ByteArrayToString(realtekTaskParameter_1.RecvACK.NameBuf[realtekTaskParameter_1.RecvACK.MaxCfgNum])}catch(e){this.logger.error("Get device's name error",tslib_1.__assign({},e))}o.length>0?realtekTaskParameter_1.RecvACK.Name[realtekTaskParameter_1.RecvACK.MaxCfgNum]=o:realtekTaskParameter_1.RecvACK.Name[realtekTaskParameter_1.RecvACK.MaxCfgNum]=null,this.logger.info("Name: "+realtekTaskParameter_1.RecvACK.Name[realtekTaskParameter_1.RecvACK.MaxCfgNum])}return realtekTaskParameter_1.RecvACK.MaxCfgNum+=1,[0,s,realtekTaskParameter_1.RecvACK.IP[realtekTaskParameter_1.RecvACK.MaxCfgNum]]},a.prototype.sendCfgAckPacket=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,a;return tslib_1.__generator(this,(function(t){switch(t.label){case 0:if(e=new Int8Array(92),arrayFill(e,byteUtil.convertNumberToByte(0)),0,e[0]=byteUtil.convertNumberToByte(e[0]+0),0,e[0]=byteUtil.convertNumberToByte(e[0]+0),0,e[0]=byteUtil.convertNumberToByte(e[0]+4),e[1]=0,e[2]=90,e[3]=0,!(null!=realtekTaskParameter_1.RecvACK.IP[0]&&realtekTaskParameter_1.RecvACK.IP[0].length>0&&"0.0.0.0"!==realtekTaskParameter_1.RecvACK.IP[0]))return[3,4];realtekTaskParameter_1.UDPUcast.IPAddr=realtekTaskParameter_1.RecvACK.IP[0],realtekTaskParameter_1.UDPUcast.SendLen=e.length,realtekTaskParameter_1.UDPUcast.SendMsg=e,this.logger.info("UDPUnicastSend CFG ACK"),a=0,t.label=1;case 1:return a<8?[4,this.mSocketClient.sendData([realtekTaskParameter_1.UDPUcast.SendMsg],0,1,realtekTaskParameter_1.UDPUcast.IPAddr,realtekTaskParameter_1.UDPUcast.DestPort)]:[3,4];case 2:t.sent(),t.label=3;case 3:return a++,[3,1];case 4:realtekTaskParameter_1.UDPBcast.IPAddr="255.255.255.255",realtekTaskParameter_1.UDPBcast.SendLen=e.length,realtekTaskParameter_1.UDPBcast.SendMsg=e,this.logger.info("UDPBroadcastSend CFG ACK"),a=0,t.label=5;case 5:return a<8?[4,this.mSocketClient.sendData([realtekTaskParameter_1.UDPBcast.SendMsg],0,1,realtekTaskParameter_1.UDPBcast.IPAddr,realtekTaskParameter_1.UDPBcast.DestPort)]:[3,8];case 6:t.sent(),t.label=7;case 7:return a++,[3,5];case 8:return[2]}}))}))},a.prototype.interrupt=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return this.mIsCancelled?[2]:(this.mIsCancelled=!0,[4,qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.delay(300)]);case 1:return e.sent(),this.mSocketClient.interrupt(),[2]}}))}))},a}(qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.EventEmitter);exports.SimpleConfigGenerator=SimpleConfigGenerator;
//# sourceMappingURL=SimpleConfigGenerator.js.map