"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SimpleConfig=void 0;var tslib_1=require("tslib"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),SimpleConfigGenerator_1=require("../protocol/SimpleConfigGenerator"),realtekTaskParameter_1=require("../base/realtekTaskParameter"),byteUtil=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.byteUtil,SimpleConfig=function(e){function t(t,r,i,s,o){var n=e.call(this)||this;return n.mIsSuc=!1,n.profileSendTimeMillis=4e4,n.profileSendTimeIntervalMs=50,n.mWaitUdpReceivingMillisecond=1e4,n.mExpectTaskResultCount=1,n.mRealtekResultList=[],n.mMacStrTaskSucCountMap=[],n.mThresholdSucBroadcastCount=1,n.logger=console,n.mIsCancelled=!1,n.mGenerator=new SimpleConfigGenerator_1.SimpleConfigGenerator(t,r,i,s,o),n.mGenerator.on("onError",(function(e){n.emit("onError",e),n.interrupt()})),o&&(n.logger=o),n}return tslib_1.__extends(t,e),t.prototype.start=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return this.mGenerator.mSocketServer.startServer(),this.__listenAsyn("promise"),[4,this.__execute()];case 1:return e.sent()?[2,this.__getEsptouchResultList()]:this.mIsCancelled?[3,3]:[4,qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.delay(this.mWaitUdpReceivingMillisecond)];case 2:e.sent(),this.mIsSuc||(this.emit("onError",{code:"PROTOCOL_TIMEOUT"}),this.interrupt()),e.label=3;case 3:return[2,this.__getEsptouchResultList()]}}))}))},t.prototype.__execute=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,t,r;return tslib_1.__generator(this,(function(i){switch(i.label){case 0:this.mGenerator.generate(),e=Date.now(),t=Date.now(),r=0,i.label=1;case 1:return!this.mIsCancelled&&t-e<this.profileSendTimeMillis?[4,this.mGenerator.sendSync({type:"promise"})]:[3,5];case 2:return i.sent(),[4,this.mGenerator.sendData({type:"promise"})];case 3:return i.sent(),[4,qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.delay(this.profileSendTimeIntervalMs)];case 4:return i.sent(),t=Date.now(),r++,this.logger.info("Config rounds: "+r),this.logger.info("Config Time Elapsed: "+(t-e)+"ms"),[3,1];case 5:return[2,this.mIsSuc]}}))}))},t.prototype.startInNoPromise=function(){var e=this;this.mGenerator.mSocketServer.startServer(),this.__listenAsyn("callback"),this.__executeInNoPromise(),setTimeout((function(){e.mIsSuc?e.mIsCancelled||e.emit("result",e.__getEsptouchResultList()):e.emit("onError",{code:"PROTOCOL_TIMEOUT"}),e.interrupt()}),this.mWaitUdpReceivingMillisecond+this.profileSendTimeMillis)},t.prototype.__executeInNoPromise=function(){var e=this;this.mGenerator.generate();var t=Date.now(),r=Date.now(),i=function(){e.mIsCancelled||r-t>e.profileSendTimeMillis||(r=Date.now(),e.mGenerator.sendSync({type:"callback",callback:function(){e.mGenerator.sendData({type:"callback",callback:function(){setTimeout((function(){i()}),e.profileSendTimeIntervalMs)}})}}))};i()},t.prototype.__listenAsyn=function(e){var t=this;this.mGenerator.mSocketServer.on("recieveCorrectMsg",(function(r){t.mIsCancelled||(t.logger.info("RECIEVE_MSG",r),function(e){var r=e.message,i=e.remoteInfo,s=i.size;realtekTaskParameter_1.UDPUcast.RecvBuf=new Int8Array(r);var o=new Int8Array(s);if(byteUtil.arrayCopy(realtekTaskParameter_1.UDPUcast.RecvBuf,0,o,0,s),t.logger.info("recvBuf: "+o+": "+s),s<9)return t.logger.error("invaid recvLent: "+s+", need lower then 9"),-1;var n=o[0];if(0!=(n&(realtekTaskParameter_1.SimpleConfigParam.BIT(7)|realtekTaskParameter_1.SimpleConfigParam.BIT(6))))return t.logger.error("ACK version not match\n"),-1;if(32!=(n&realtekTaskParameter_1.SimpleConfigParam.BIT(5)))return t.logger.error("Not response ACK\n"),-1;var a={obj:void 0,what:void 0};switch(31&n){case 0:var l=tslib_1.__read(t.mGenerator.handleCfgACK(o),3),u=l[0],c=l[1],m=l[2];return t.__putEsptouchResult(!u,c,m,i);case 1:a.obj=o,a.what=1,t.logger.info("revice module message",{detail:a});break;case 2:a.obj=o,a.what=2,t.logger.info("revice module message",{detail:a});break;case 3:a.obj=o,a.what=3,t.logger.info("revice module message",{detail:a});break;case 4:a.obj=o,a.what=4,t.logger.info("revice module message",{detail:a});break;default:t.logger.error("Unknow response")}t.interrupt()}(r),t.mIsSuc=t.mRealtekResultList.length>=t.mExpectTaskResultCount,t.mIsSuc&&(t.logger.info("__listenAsyn() finish",{detail:t.__getEsptouchResultList()}),"callback"===e&&t.emit("result",t.__getEsptouchResultList()),t.interrupt()))}))},t.prototype.__putEsptouchResult=function(e,t,r,i){var s=this.mMacStrTaskSucCountMap[t];if(null==s&&(s=0),++s,this.logger.info("PUT_REALTEK_RESULT:__putEsptouchResult(): count = "+s),this.mMacStrTaskSucCountMap[t]=s,s>=this.mThresholdSucBroadcastCount){for(var o=!1,n=0;n<this.mRealtekResultList.length;n++)if(this.mRealtekResultList[n].macStr===t){o=!0;break}if(!o){this.logger.info("PUT_REALTEK_RESULT:put one more result macStr = "+t+" , address = "+r+",the remoteInfo from weapp"+JSON.stringify(i));var a={isSuc:e,macStr:t,inetAddress:r||i.address,remoteInfo:i};this.mRealtekResultList.push(a)}}else this.logger.info("PUT_REALTEK_RESULT:__putEsptouchResult(): count = "+s+", isn't enough")},t.prototype.__getEsptouchResultList=function(){return this.logger.info("GET_RESULT",{data:this.mRealtekResultList}),this.mRealtekResultList},t.prototype.interrupt=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){return this.mIsCancelled||(this.mIsCancelled=!0,this.mGenerator.interrupt()),[2]}))}))},t}(qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.EventEmitter);exports.SimpleConfig=SimpleConfig;
//# sourceMappingURL=SimpleConfig.js.map