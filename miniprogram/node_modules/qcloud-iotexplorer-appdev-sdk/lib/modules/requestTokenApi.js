"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.requestTokenApi=void 0;var tslib_1=require("tslib"),shortid_for_miniprogram_1=tslib_1.__importDefault(require("shortid-for-miniprogram")),utils_1=require("../utils"),env_detect_1=require("../utils/env-detect"),defaultUrl="https://iot.cloud.tencent.com/api/exploreropen/";exports.requestTokenApi=function(e,r,t){return void 0===r&&(r={}),void 0===t&&(t={}),tslib_1.__awaiter(void 0,void 0,void 0,(function(){var o,i,s,n,a,d,u,c,l,_,p,f,m,g,v,h=r.uin,b=r.AccessToken,q=tslib_1.__rest(r,["uin","AccessToken"]),w=t.method,A=void 0===w?"POST":w,k=t.reporter,y=t.doNotReport,T=void 0!==y&&y,N=t.isSecureApi,x=void 0!==N&&N,E=t.isTokenApi,P=void 0===E||E,R=t.url,S=tslib_1.__rest(t,["method","reporter","doNotReport","isSecureApi","isTokenApi","url"]);return tslib_1.__generator(this,(function(r){switch(r.label){case 0:shortid_for_miniprogram_1.default.characters("0123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKMNPQRSTUVWXYZ-_$@#%"),o=shortid_for_miniprogram_1.default(),i=Date.now(),s=!1,r.label=1;case 1:if(r.trys.push([1,9,,10]),a={uin:h,cmd:e},q=Object.assign({},q,{Action:e,RequestId:o,AccessToken:b}),R=R||defaultUrl,!x)return[3,3];if(!env_detect_1.isMiniProgram)throw new Error("secure api 仅支持在小程序中调用");return R+="appsecureapi",a.cmd=e,[4,utils_1.pify(wx.login)()];case 2:return d=r.sent().code,q.JsCode=d,[3,4];case 3:P?(R+="tokenapi",a.cmd=e):R+=e,r.label=4;case 4:R=utils_1.appendParams(R,a),n=tslib_1.__assign({url:R,data:q,method:A},S),u=void 0,r.label=5;case 5:return r.trys.push([5,7,,8]),[4,utils_1.request(n)];case 6:return c=r.sent().data,u=c,[3,8];case 7:throw l=r.sent(),s=!0,l;case 8:if(_=u.code,p=u.msg,f=u.data,m=void 0===f?{}:f,_){if(null==m?void 0:m.Error)throw{code:m.Error.Code,msg:m.Error.Message,reqId:o};throw{code:_,msg:p,reqId:o}}return k.info("cgi-response",{reqBody:utils_1.cutoffLong(JSON.stringify(q)),action:e,timeCost:Date.now()-i,doNotReport:T,code:_,resBody:utils_1.cutoffLong(JSON.stringify(m)),msg:p,reqId:o}),[2,m];case 9:return g=r.sent(),v=utils_1.normalizeError(g),k.info(s?"cgi-fail":"cgi-error",{action:e,timeCost:Date.now()-i,doNotReport:T,error:v,reqId:o}),[2,Promise.reject(g)];case 10:return[2]}}))}))};
//# sourceMappingURL=requestTokenApi.js.map