"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.IotWebsocket=void 0;var tslib_1=require("tslib"),event_emitter_for_miniprogram_1=tslib_1.__importDefault(require("event-emitter-for-miniprogram")),shortid_for_miniprogram_1=tslib_1.__importDefault(require("shortid-for-miniprogram")),utils_1=require("../utils"),defaultOptions={url:"wss://iot.cloud.tencent.com/ws/explorer",heartbeatInterval:5e4},IotWebsocket=function(e){function t(t,s){var i=e.call(this)||this;return i.sdk=t,i.requestHandlerMap=new Map,i.options=Object.assign({},defaultOptions,s),i._connected=!1,i._subscribeDeviceIdList=[],i._heartBeatTimer=null,i}return tslib_1.__extends(t,e),t.prototype.isConnected=function(){return!!this._connected},t.prototype.doConnectWs=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var e=this;return tslib_1.__generator(this,(function(t){return[2,this._doConnectWsPromise||(this._doConnectWsPromise=new Promise((function(t,s){return tslib_1.__awaiter(e,void 0,void 0,(function(){var e,i,r=this;return tslib_1.__generator(this,(function(n){e=function(e){s(e),r.emit("error",e),r.disconnect(),r.sdk.reporter.error("websocket-error",{error:e})};try{i=this.options.url,this.ws=new utils_1.WebSocket(utils_1.appendParams(i,{uin:this.sdk._debug?this.sdk._defaultUin:this.sdk.loginManager.userId})),this.ws.onOpen((function(){r._connected=!0,r.emit("connect"),t(),utils_1.logger.debug("websocket connected"),r.sdk.reporter.info("websocket-connect")})),this.ws.onError(e),this.ws.onMessage((function(e){var t=e.data;r.emit("message",t);try{t=JSON.parse(t)}catch(e){return void utils_1.logger.warn("onMessage parse event.data error: "+t)}t.push?(r.emit("push",t),r.sdk.reporter.info("websocket-push",{data:t})):void 0!==t.reqId&&r.requestHandlerMap.has(t.reqId)?r.requestHandlerMap.get(t.reqId)(null,t):r.sdk.reporter.info("websocket-onmessage",{data:t})})),this.ws.onClose((function(e){return tslib_1.__awaiter(r,void 0,void 0,(function(){return tslib_1.__generator(this,(function(t){return utils_1.logger.debug("websocket closed"),this.disconnect(),this.emit("close",e),this.sdk.reporter.info("websocket-close",{data:e}),[2]}))}))}))}catch(t){e(t)}return[2]}))}))})))]}))}))},t.prototype.connect=function(e){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(t){switch(t.label){case 0:return e&&(this._subscribeDeviceIdList=e),[4,this.sdk.loginManager.checkLogin()];case 1:return t.sent(),this.isConnected()||!this._subscribeDeviceIdList.length?[3,3]:[4,this.doConnectWs()];case 2:t.sent(),t.label=3;case 3:return[2,this.activePush()]}}))}))},t.prototype.disconnect=function(){this.ws&&(this.ws.close(),this._connected=!1,this._doConnectWsPromise=null,this.ws=null,clearInterval(this._heartBeatTimer),this._heartBeatTimer=null)},t.prototype.send=function(e,t,s){void 0===t&&(t={});var i=(void 0===s?{}:s).reqId;return tslib_1.__awaiter(this,void 0,void 0,(function(){var s,r,n,o,a=this;return tslib_1.__generator(this,(function(c){switch(c.label){case 0:if(i||(i=shortid_for_miniprogram_1.default()),!this.ws)return[3,6];s=Date.now(),this.ws.send({data:JSON.stringify({action:e,reqId:i,params:t})}),r={reqBody:utils_1.cutoffLong(JSON.stringify(t)),action:e,reqId:i,timeCost:null},c.label=1;case 1:return c.trys.push([1,3,4,5]),[4,Promise.race([new Promise((function(e,t){a.requestHandlerMap.set(i,(function(i,o){if(r.timeCost=Date.now()-s,!i)return o.data||!o.error&&!o.error_message?(a.sdk.reporter.info("websocket-response",tslib_1.__assign(tslib_1.__assign({},r),{resBody:utils_1.cutoffLong(JSON.stringify(o.data))})),e(o.data)):(n="error",void t({code:o.error,msg:o.error_message}));t(i),n="fail"}))})),new Promise((function(e,t){setTimeout((function(){t({code:"TIMEOUT"}),n="timeout"}),2e4)}))])];case 2:return[2,c.sent()];case 3:return o=c.sent(),this.sdk.reporter.info("websocket-"+n,tslib_1.__assign(tslib_1.__assign({},r),{error:o,timeCost:Date.now()-s})),[3,5];case 4:return this.requestHandlerMap.delete(i),[7];case 5:return[3,7];case 6:utils_1.logger.warn("Try send ws message but no ws instance",e,t),c.label=7;case 7:return[2]}}))}))},t.prototype.sendWsHeatBeat=function(){var e;if(null===(e=this._subscribeDeviceIdList)||void 0===e?void 0:e.length){var t=shortid_for_miniprogram_1.default(),s={Action:"AppDeviceTraceHeartBeat",ActionParams:Object.assign({},{Platform:this.sdk._apiPlatform,RequestId:t,AccessToken:this.sdk.loginManager.accessToken,DeviceIds:this._subscribeDeviceIdList})};return this.send("YunApi",s,{reqId:t})}},t.prototype.activePush=function(){var e=this,t=this.sdk.loginManager,s=t.isLogin,i=t.accessToken,r=t.appKey;s&&i&&this._subscribeDeviceIdList&&(this.sdk.reporter.info("websocket activepush("+this._subscribeDeviceIdList.join(";")+")",{data:{DeviceIds:this._subscribeDeviceIdList,Platform:"weapp",AccessToken:i,RegionId:this.sdk._apiRegionId}}),this.send("ActivePush",{DeviceIds:this._subscribeDeviceIdList,Platform:"weapp",AccessToken:i,AppKey:r,RegionId:this.sdk._apiRegionId}),this.sendWsHeatBeat(),clearInterval(this._heartBeatTimer),this._heartBeatTimer=setInterval((function(){return e.sendWsHeatBeat()}),this.options.heartbeatInterval))},t}(event_emitter_for_miniprogram_1.default);exports.IotWebsocket=IotWebsocket;
//# sourceMappingURL=IotWebsocket.js.map