"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.LoginManager=exports.accessTokenStorageKey=void 0;var tslib_1=require("tslib"),event_emitter_for_miniprogram_1=tslib_1.__importDefault(require("event-emitter-for-miniprogram")),utils_1=require("../utils"),constants=tslib_1.__importStar(require("../constants"));exports.accessTokenStorageKey="__qcloud-iotexplorer-appdev-sdk-accessToken";var LoginManager=function(e){function t(t,s){var r=s.getAccessToken,n=s.appKey,i=s.enableAccessTokenCache,o=void 0===i||i,a=e.call(this)||this;return a.accessToken="",a.isLogin=!1,a._accessTokenStorageKey=exports.accessTokenStorageKey,a.sdk=t,a.getAccessToken=r,a.enableAccessTokenCache=o,a.appKey=n,a}return tslib_1.__extends(t,e),t.prototype.login=function(e){var t=(void 0===e?{}:e).reload;return tslib_1.__awaiter(this,void 0,void 0,(function(){var e=this;return tslib_1.__generator(this,(function(s){return t&&(this._loginPromise=null),[2,this._loginPromise||(this._loginPromise=new Promise((function(s,r){return tslib_1.__awaiter(e,void 0,void 0,(function(){var e,n,i,o,a,c;return tslib_1.__generator(this,(function(u){switch(u.label){case 0:e=!1,u.label=1;case 1:return u.trys.push([1,12,15,16]),n=void 0,t?[4,utils_1.storage.removeItem(exports.accessTokenStorageKey)]:[3,3];case 2:u.sent(),u.label=3;case 3:return t||!this.enableAccessTokenCache?[3,5]:[4,utils_1.storage.getItem(exports.accessTokenStorageKey)];case 4:n=u.sent(),u.label=5;case 5:return n?[3,7]:[4,this.getAccessToken()];case 6:return i=u.sent(),o=i.Token,n=o,[3,8];case 7:e=!0,u.label=8;case 8:return this.accessToken=n,[4,this.sdk.requestApi("AppGetUser",{},{needLogin:!1,isTokenApi:!0,doNotRetry:!0})];case 9:return a=u.sent().Data,this.enableAccessTokenCache?[4,utils_1.storage.setItem(exports.accessTokenStorageKey,n)]:[3,11];case 10:u.sent(),u.label=11;case 11:return this.userInfo=a,this.isLogin=!0,this.emit(constants.EventTypes.LoginStateChange,!0),s(),[3,16];case 12:return c=u.sent(),utils_1.isVerifyLoginError(c)?[4,this.logout().catch(utils_1.noop)]:[3,14];case 13:if(u.sent(),e)return utils_1.logger.debug("Cached Token expired, retrying..."),this.login({reload:!0}).then(s).catch(r),[2];u.label=14;case 14:return[2,r(c)];case 15:return this._loginPromise=null,[7];case 16:return[2]}}))}))})))]}))}))},Object.defineProperty(t.prototype,"userId",{get:function(){return this.userInfo?this.userInfo.UserID:this.sdk._defaultUin},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"nickName",{get:function(){return this.userInfo?this.userInfo.NickName:""},enumerable:!1,configurable:!0}),t.prototype.checkLogin=function(){if(this._loginPromise)return this._loginPromise;if(!this.isLogin)throw utils_1.genVerifyLoginFailError()},t.prototype.logout=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return[4,utils_1.storage.removeItem(exports.accessTokenStorageKey)];case 1:return e.sent(),this.accessToken="",this.isLogin=!1,this.emit(constants.EventTypes.LoginStateChange,!1),[2]}}))}))},t.prototype.reLogin=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return[4,this.logout()];case 1:return e.sent(),[4,this.login({reload:!0})];case 2:return e.sent(),[2]}}))}))},t}(event_emitter_for_miniprogram_1.default);exports.LoginManager=LoginManager;
//# sourceMappingURL=LoginManager.js.map