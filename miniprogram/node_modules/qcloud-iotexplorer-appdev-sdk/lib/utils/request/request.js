"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.request=void 0;var tslib_1=require("tslib"),query_string_1=tslib_1.__importDefault(require("query-string")),jsonp_1=require("./jsonp"),env_detect_1=require("../env-detect"),request_manager_1=require("./request-manager"),pify_1=require("../pify"),utillib_1=require("../utillib"),maxConcurrentNum=10,currentRequestingNum=0,jsonpcallbackCounter=0;function requestXHR(e,t,r){return void 0===t&&(t={}),void 0===r&&(r={}),new Promise((function(s,n){try{if("jsonp"===r.dataType)return jsonp_1.jsonp(e,{},(function(e,t){return e?n({code:"timeout"}):s(t)}));var a=r.method,u=r.headers,i=void 0===u?{}:u,o=r.responseType,c=void 0===o?"json":o;a=(a||"get").toUpperCase(),Object.assign(i,{"Content-type":"application/json"});var p=new window.XMLHttpRequest;p.responseType=c,p.timeout=1e4,p.onreadystatechange=function(){4===p.readyState&&(200===p.status?s({data:p.response}):n({code:p.status,msg:p.statusText}))},"GET"===a?e="url"+(-1===e.indexOf("?")?"?":"&")+query_string_1.default.stringify(t):"POST"===a&&(t=JSON.stringify(t)),p.open(a,e,!0),Object.keys(i).forEach((function(e){p.setRequestHeader(e,i[e])})),p.send("POST"===a?t:null)}catch(e){console.error(e),n(e)}}))}function requestWeapp(e){return tslib_1.__awaiter(this,void 0,void 0,(function(){var t,r,s;return tslib_1.__generator(this,(function(n){switch(n.label){case 0:n.trys.push([0,7,8,9]),n.label=1;case 1:return currentRequestingNum>=maxConcurrentNum?[4,request_manager_1.startBlocking()]:[3,3];case 2:return n.sent(),[3,1];case 3:return currentRequestingNum++,"jsonp"!==e.dataType?[3,5]:(e.method="GET",t=e.callback||"jsonpcallback"+ ++jsonpcallbackCounter,e.url=utillib_1.appendParams(e.url,{callback:t}),[4,pify_1.pify(wx.request)(e)]);case 4:return 200===(r=n.sent()).statusCode&&r.data&&"string"==typeof r.data&&(r.data=utillib_1.jsonp2json(r.data)),[2,r];case 5:return[4,pify_1.pify(wx.request)(e)];case 6:return[2,n.sent()];case 7:return s=n.sent(),[2,Promise.reject(s)];case 8:return currentRequestingNum--,request_manager_1.resolveFirstBlock(),[7];case 9:return[2]}}))}))}exports.request=function(e){return tslib_1.__awaiter(void 0,void 0,void 0,(function(){var t=e.url,r=e.data,s=e.header,n=void 0===s?{}:s,a=e.method,u=void 0===a?"GET":a,i=e.dataType,o=e.responseType,c=tslib_1.__rest(e,["url","data","header","method","dataType","responseType"]);return tslib_1.__generator(this,(function(e){return env_detect_1.isBrowser?[2,requestXHR(t,r,{headers:n,method:u,responseType:o,dataType:i})]:[2,requestWeapp(tslib_1.__assign({url:t,data:r,header:n,method:u,dataType:i,responseType:o},c))]}))}))};
//# sourceMappingURL=request.js.map