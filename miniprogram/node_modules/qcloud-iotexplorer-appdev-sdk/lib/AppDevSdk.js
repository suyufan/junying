"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AppDevSdk=exports.AppDevPlugin=void 0;var tslib_1=require("tslib"),event_emitter_for_miniprogram_1=tslib_1.__importDefault(require("event-emitter-for-miniprogram")),modules_1=require("./modules"),utils_1=require("./utils"),utils=tslib_1.__importStar(require("./utils")),constants=tslib_1.__importStar(require("./constants")),ReportLevel={INFO:0,WARN:1,ERROR:2},AppDevPlugin=function(){function e(){}return e.install=function(e){},e}();exports.AppDevPlugin=AppDevPlugin;var AppDevSdk=function(e){function t(t){var n=t.getAccessToken,i=t.appKey,s=void 0===i?"":i,r=t.apiPlatform,o=void 0===r?"":r,a=t.apiRegionId,c=void 0===a?1:a,l=t.debug,u=void 0!==l&&l,d=t.apiUrl,p=t.wsConfig,_=t.reporter,g=t.plugins,v=void 0===g?[]:g,h=t.defaultUin,f=void 0===h?"unknown":h,b=t.enableAccessTokenCache,y=void 0===b||b,m=e.call(this)||this;m.isManuallyClose=!1,m._defaultFamilyIdPromise=null,m._connectWsWhenInit=!0,m.constants=constants,m.utils=utils,m.plugins={},m._defaultUin=f,m._apiUrl=d,m._debug=u,utils_1.logger.config({debug:u});var w=_||utils_1.noop;m.reporter={info:function(e,t){void 0===t&&(t={});try{w(e,tslib_1.__assign({level:ReportLevel.INFO},t))}catch(e){utils_1.logger.warn(e)}},warn:function(e,t){void 0===t&&(t={});try{w(e,tslib_1.__assign({level:ReportLevel.WARN},t))}catch(e){utils_1.logger.warn(e)}},error:function(e,t){void 0===t&&(t={});try{w(e,tslib_1.__assign({level:ReportLevel.ERROR},t))}catch(e){utils_1.logger.warn(e)}}};var P=p||{},I=P.autoReconnect,k=void 0===I||I,W=P.disconnectWhenAppHide,D=void 0===W||W,A=P.connectWhenAppShow,E=void 0===A||A,R=P.connectWhenInit,T=void 0===R||R,L=tslib_1.__rest(P,["autoReconnect","disconnectWhenAppHide","connectWhenAppShow","connectWhenInit"]);return m.ws=new modules_1.IotWebsocket(m,tslib_1.__assign(tslib_1.__assign({},L),{apiPlatform:o})),m.loginManager=new modules_1.LoginManager(m,{getAccessToken:n,appKey:s,enableAccessTokenCache:y}),m._apiPlatform=o,m._apiRegionId=c,m.loginManager.on(constants.EventTypes.LoginStateChange,(function(e){return m.emit(constants.EventTypes.LoginStateChange,{isLogin:e})})),m.ws.on("error",(function(e){utils_1.logger.debug("websocket error",e),m.emit(constants.EventTypes.WsError,e),k&&m._reconnectWs()})),m.ws.on("close",(function(e){var t=void 0===e?{}:e,n=t.code,i=t.reason;utils_1.logger.debug("websocket close",{code:n,reason:i}),m.emit(constants.EventTypes.WsClose,{code:n,reason:i}),k&&m._onWebsocketClose()})),m.ws.on("push",(function(e){return m._handlePushEvent(e)})),utils_1.envDetect.isMiniProgram&&(wx.onAppHide((function(){D&&(m.isManuallyClose=!0,m.ws.disconnect())})),wx.onAppShow((function(){E&&m.isLogin&&m.ws.connect()}))),(null==v?void 0:v.length)&&v.forEach((function(e){return m.usePlugin(e)})),m._connectWsWhenInit=T,m}return tslib_1.__extends(t,e),t.prototype.usePlugin=function(e){e.install(this)},Object.defineProperty(t.prototype,"userInfo",{get:function(){return this.loginManager.userInfo},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isLogin",{get:function(){return this.loginManager.isLogin},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"userId",{get:function(){return this.loginManager.userId},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"uin",{get:function(){return this.loginManager.userId},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"nickName",{get:function(){return this.loginManager.nickName},enumerable:!1,configurable:!0}),t.prototype.init=function(e){return tslib_1.__awaiter(this,void 0,void 0,(function(){var t=this;return tslib_1.__generator(this,(function(n){return e||(e={}),e.reload&&(this._initPromise=null),this.isLogin?[2,Promise.resolve()]:[2,this._initPromise||(this._initPromise=new Promise((function(n,i){return tslib_1.__awaiter(t,void 0,void 0,(function(){var t;return tslib_1.__generator(this,(function(s){switch(s.label){case 0:return s.trys.push([0,4,5,6]),[4,this.loginManager.login({reload:e.reload})];case 1:return s.sent(),this._connectWsWhenInit?[4,this.ws.connect()]:[3,3];case 2:s.sent(),s.label=3;case 3:return n(),[3,6];case 4:return t=s.sent(),i(utils_1.normalizeError(t)),[3,6];case 5:return this._initPromise=null,[7];case 6:return[2]}}))}))})))]}))}))},t.prototype.getDefaultFamilyId=function(){var e=this;return this._defaultFamilyIdPromise||(this._defaultFamilyIdPromise=new Promise((function(t,n){return tslib_1.__awaiter(e,void 0,void 0,(function(){var e,i,s,r;return tslib_1.__generator(this,(function(o){switch(o.label){case 0:return o.trys.push([0,4,,5]),[4,this.requestApi("AppGetFamilyList",{Offset:0,Limit:100})];case 1:return e=o.sent(),i=e.FamilyList,e.Total?[3,3]:[4,this.requestApi("AppCreateFamily",{Name:this.loginManager.nickName})];case 2:return s=o.sent().Data.FamilyId,[2,t(s)];case 3:return t(i[0].FamilyId),[3,5];case 4:return r=o.sent(),n(r),this._defaultFamilyIdPromise=null,[3,5];case 5:return[2]}}))}))})))},t.prototype.sendWebsocketMessage=function(e,t){return void 0===t&&(t={}),tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(n){switch(n.label){case 0:return[4,this.init()];case 1:return n.sent(),[2,this.ws.send(e,t)]}}))}))},t.prototype.connectWebsocket=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return[4,this.init()];case 1:return e.sent(),[4,this.ws.connect()];case 2:return e.sent(),[2]}}))}))},t.prototype.disconnectWebsocket=function(){this.ws.disconnect()},t.prototype.subscribeDevices=function(e){return tslib_1.__awaiter(this,void 0,void 0,(function(){var t;return tslib_1.__generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.ws.connect((e||[]).map((function(e){return"string"==typeof e?e:(null==e?void 0:e.DeviceId)?e.DeviceId:null})).filter(Boolean))];case 1:return n.sent(),[3,3];case 2:return t=n.sent(),utils_1.logger.warn("subscribeDevices fail",t),[3,3];case 3:return[2]}}))}))},t.prototype.requestApi=function(e,t,n){void 0===t&&(t={}),void 0===n&&(n={});var i=n.doNotRetry,s=void 0!==i&&i,r=n.needLogin,o=void 0===r||r,a=n.doNotReport,c=void 0!==a&&a,l=tslib_1.__rest(n,["doNotRetry","needLogin","doNotReport"]);return tslib_1.__awaiter(this,void 0,void 0,(function(){var n,i,r,a,u,d,p;return tslib_1.__generator(this,(function(_){switch(_.label){case 0:return _.trys.push([0,6,,13]),o?[4,this.loginManager.checkLogin()]:[3,2];case 1:_.sent(),_.label=2;case 2:return n=this.loginManager,i=n.accessToken,r=n.userId,t&&"default"===t.FamilyId?(a=t,[4,this.getDefaultFamilyId()]):[3,4];case 3:a.FamilyId=_.sent(),_.label=4;case 4:return u=tslib_1.__assign({uin:this._debug?this._defaultUin:r,RegionId:this._apiRegionId},t),i&&(u.AccessToken=i),this._apiPlatform&&(u.Platform=this._apiPlatform),[4,modules_1.requestTokenApi(e,u,tslib_1.__assign({reporter:this.reporter,doNotReport:c,url:this._apiUrl},l))];case 5:return[2,_.sent()];case 6:if(d=_.sent(),utils_1.logger.debug("requestApi fail",d),!utils_1.isVerifyLoginError(d))return[3,12];if(s)return[3,11];_.label=7;case 7:return _.trys.push([7,9,,10]),[4,this.loginManager.reLogin()];case 8:return _.sent(),[3,10];case 9:return p=_.sent(),utils_1.logger.error("reLogin fail",p),[2,Promise.reject(utils_1.genVerifyLoginFailError(d))];case 10:return[2,this.requestApi(e,t,tslib_1.__assign({doNotRetry:!0},l))];case 11:return[2,Promise.reject(utils_1.genVerifyLoginFailError(d))];case 12:return[2,Promise.reject(utils_1.normalizeError(d))];case 13:return[2]}}))}))},t.prototype._handlePushEvent=function(e){var t,n,i,s;e||(e={}),this.emit(constants.EventTypes.WsPush,e);var r=e.action,o=e.params;o||(o={});var a=o.DeviceId,c=o.Type,l=o.SubType,u=o.Time,d=o.Payload,p=new Date(u).getTime();if(d)try{d=JSON.parse(utils_1.base64.decode(d))}catch(e){return void utils_1.logger.error(e)}if(utils_1.logger.debug("websocket push payload",d),"DeviceChange"===r)switch(c){case"Property":case"Shadow":case"Template":switch(l){case"Report":var _={};try{if(d){var g=d.method,v=d.params,h=d.type,f=d.state;if(h&&"update"===h&&f&&f.reported&&(g="report",v=f.reported),v||(v={}),"report"===g)try{for(var b=tslib_1.__values(Object.keys(v)),y=b.next();!y.done;y=b.next()){_[I=y.value]={Value:v[I],lastUpdate:p,LastUpdate:p}}}catch(e){t={error:e}}finally{try{y&&!y.done&&(n=b.return)&&n.call(b)}finally{if(t)throw t.error}}}}catch(e){utils_1.logger.error("handle report event error",e)}this.emit(constants.EventTypes.WsReport,{deviceId:a,deviceData:_});break;case"Push":_={};try{if(d){g=d.method,v=d.params,h=d.type;var m=d.payload;if(h&&"delta"===h&&m&&m.state&&(g="control",v=m.state),"control"===g&&v){try{for(var w=tslib_1.__values(Object.keys(v)),P=w.next();!P.done;P=w.next()){var I;_[I=P.value]={Value:v[I],LastUpdate:p}}}catch(e){i={error:e}}finally{try{P&&!P.done&&(s=w.return)&&s.call(w)}finally{if(i)throw i.error}}this.emit(constants.EventTypes.WsControl,{deviceId:a,deviceData:_})}}}catch(e){utils_1.logger.error(e)}}break;case"Event":if("Report"===l)this.emit(constants.EventTypes.WsEventReport,{Payload:d,deviceId:a});break;case"Action":switch(l){case"Push":this.emit(constants.EventTypes.WsActionPush,{Payload:d,deviceId:a});break;case"Report":this.emit(constants.EventTypes.WsActionReport,{Payload:d,deviceId:a})}break;case"StatusChange":switch(l){case"Bind":this.emit(constants.EventTypes.WsDeviceBind,{Payload:d,deviceId:a});break;case"Unbind":this.emit(constants.EventTypes.WsDeviceUnbind,{Payload:d,deviceId:a});break;case"Online":case"Offline":var k="Online"===l?1:0;this.emit(constants.EventTypes.WsStatusChange,{deviceId:a,deviceStatus:k});break;default:console.warn("unknown subtype 【"+l+"】 of statusChange")}case"Gateway":switch(l){case"bind":this.emit(constants.EventTypes.WsSubDeviceBind,{gatewayDeviceId:a,subDeviceList:d}),this.emit(constants.EventTypes.WsSubDeviceChange,{gatewayDeviceId:a,subDeviceList:d,action:"bind"});break;case"unbind":this.emit(constants.EventTypes.WsSubDeviceUnbind,{gatewayDeviceId:a,subDeviceList:d}),this.emit(constants.EventTypes.WsSubDeviceChange,{gatewayDeviceId:a,subDeviceList:d,action:"unbind"})}}},t.prototype._onWebsocketClose=function(){if(!this.isManuallyClose)return this._reconnectWs();this.isManuallyClose=!1},t.prototype._reconnectWs=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var e;return tslib_1.__generator(this,(function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),utils_1.logger.debug("websocket reconnecting in 2 seconds"),[4,utils_1.delay(2e3)];case 1:return t.sent(),[4,this.ws.connect()];case 2:return t.sent(),[3,4];case 3:return e=t.sent(),utils_1.logger.error("error when reconnect ws",e),[2,Promise.reject(e)];case 4:return[2]}}))}))},t.utils=utils,t.constants=constants,t}(event_emitter_for_miniprogram_1.default);exports.AppDevSdk=AppDevSdk;
//# sourceMappingURL=AppDevSdk.js.map