"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BleComboEspDeviceAdapter=void 0;var tslib_1=require("tslib"),qcloud_iotexplorer_bluetooth_adapter_1=require("qcloud-iotexplorer-bluetooth-adapter"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),constants=tslib_1.__importStar(require("./constants")),qcloud_iotexplorer_bluetooth_adapter_llsync_1=require("qcloud-iotexplorer-bluetooth-adapter-llsync"),_a=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils,envDetect=_a.envDetect,byteUtil=_a.byteUtil,hex2str=qcloud_iotexplorer_bluetooth_adapter_llsync_1.utils.hex2str,BleComboEspDeviceAdapter=function(t){function e(e){var n,i,s=t.call(this,e)||this;return s.version=0,s.supportSendSplitDataMinimumVersion=512,s.sequence=0,s.waitVersionReplyTimeout=3e3,s.waitCustomDataTimeout=3e4,s.waitWiFiStateTimeout=3e4,s.MODE_TYPE_MAP=((n={})[constants.REPORT_CONNECT_STATE_SUB_TYPE]="wifiConnectStateChange",n[constants.SEND_TOKEN_SUB_TYPE]="tokenStateChange",n[constants.MODULE_ERROR_LOG_REPORT_SUB_TYPE]="moduleLogReport",n),s.MODE_TYPE_MAP_V2=((i={})[constants.REPORT_CONNECT_STATE_SUB_TYPE_V2]="wifiConnectStateChange",i[constants.GET_CUSTOM_DATA_V2]="CustomDataReport",i[constants.VERSION_REPLY_V2]="versionReport",i),s.on("message",s.handleMessageToEmitEvent),s.on("disconnect",(function(){s.initSequence()})),s}return tslib_1.__extends(e,t),e.prototype.initSequence=function(){this.sequence=0},e.prototype.getSequence=function(){return this.sequence++},e.prototype.handleBLEMessage=function(t){var e=parseInt(t[0],16)>>2;return{type:0===this.version?this.MODE_TYPE_MAP[e]||this.MODE_TYPE_MAP_V2[e]:1===this.version?this.MODE_TYPE_MAP[e]:this.MODE_TYPE_MAP_V2[e],subType:e,data:t}},e.prototype.handleMessageToEmitEvent=function(t){var e=t.type,n=t.subType,i=t.data;this.emit(e,{subType:n,data:i})},e.prototype.connectDevice=function(e){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(n){switch(n.label){case 0:return[4,t.prototype.connectDevice.call(this,e)];case 1:n.sent(),n.label=2;case 2:return n.trys.push([2,6,,7]),[4,this.getVersion()];case 3:return n.sent().version>=this.supportSendSplitDataMinimumVersion?[4,this.setMtu(constants.DEFAULT_MTU)]:[3,5];case 4:n.sent(),n.label=5;case 5:return[3,7];case 6:return n.sent(),[3,7];case 7:return[2]}}))}))},e.prototype.setMtu=function(t){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return console.log("---set---mtu",t),envDetect.isIOS?[2]:[4,this.setBLEMTU({deviceId:this.deviceId,mtu:t})];case 1:return[2,e.sent()]}}))}))},e.prototype.buildBleData=function(t){var e=t.mode,n=t.subType,i=t.data,s=[],o=[];if(s[0]=n<<2|e,s[1]=constants.BLE_DATA_TYPE_P2E,s[2]>=255)throw{code:"BLE_GATT_SERVER_NEED_RESTART"};if(i instanceof Int8Array!=!0)throw{msg:"传入的数据用于组装BleData的格式不对，需要Int8Array"};if(i.length>=255)throw{code:"SSID_OR_PASSWORD_OVERLOAD"};if(this.version>=this.supportSendSplitDataMinimumVersion&&i.length>constants.DEFAULT_DATA_LENGTH_CONSIDER_MTU-4)for(var r=constants.DEFAULT_DATA_LENGTH_CONSIDER_MTU-4-2,a=0;a<i.length;a+=r){var c=Math.min(i.length-a,r),_=i.length-a;_-r>0?o.push(tslib_1.__spread([s[0],s[1]|constants.SPLIT_FLAG,this.getSequence(),c+2,_,0],i.slice(a,a+r))):o.push(tslib_1.__spread([s[0],s[1],this.getSequence(),c],i.slice(a)))}else s[2]=this.getSequence(),s[3]=i.length,0===i.length?s[4]=0:i.map((function(t){return s.push(t)})),o.push(s);return o},e.prototype.writeData=function(t){return tslib_1.__awaiter(this,void 0,void 0,(function(){var e;return tslib_1.__generator(this,(function(n){switch(n.label){case 0:e=0,n.label=1;case 1:return e<t.length?(console.log("===data===",e,t[e]),[4,this.write(byteUtil.byteArrayToHex(t[e]))]):[3,4];case 2:n.sent(),n.label=3;case 3:return e++,[3,1];case 4:return[2]}}))}))},e.prototype.getVersion=function(){var t=this;return new Promise((function(e,n){t.writeData(t.buildBleData({mode:constants.CONTROL_MODE,subType:constants.GET_VERSION_V2,data:new Int8Array([])})).catch((function(t){n(tslib_1.__assign(tslib_1.__assign({},t),{code:"WRITE_ERROR"}))}));var i=setTimeout((function(){n({code:"TIMEOUT"})}),t.waitVersionReplyTimeout);t.on("moduleLogReport",(function(){t.version=1,clearTimeout(i),e({version:t.version})})),t.on("versionReport",(function(n){var s=n.data;clearTimeout(i);var o=parseInt(s[3]);t.version=2===o?2:parseInt(s.slice(s.length-2).join(""),16),console.log("get---version--",t.version),e({version:t.version})}))}))},e.prototype.sendSwitchWiFi=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var t;return tslib_1.__generator(this,(function(e){switch(e.label){case 0:return t=this.buildBleData({mode:constants.CONTROL_MODE,subType:constants["STA_SUB_TYPE"+(this.version>1?"_V2":"")],data:new Int8Array([1])}),[4,this.writeData(t)];case 1:return e.sent(),[2,t]}}))}))},e.prototype.sendSsid=function(t){return tslib_1.__awaiter(this,void 0,void 0,(function(){var e;return tslib_1.__generator(this,(function(n){switch(n.label){case 0:return e=this.buildBleData({mode:constants.DATA_MODE,subType:constants["SSID_SUB_TYPE"+(this.version>1?"_V2":"")],data:byteUtil.getBytesByString(t)}),[4,this.writeData(e)];case 1:return n.sent(),[2,e]}}))}))},e.prototype.sendPassword=function(t){return tslib_1.__awaiter(this,void 0,void 0,(function(){var e;return tslib_1.__generator(this,(function(n){switch(n.label){case 0:return e=this.buildBleData({mode:constants.DATA_MODE,subType:constants["PASSWORD_SUB_TYPE"+(this.version>1?"_V2":"")],data:byteUtil.getBytesByString(t)}),[4,this.writeData(e)];case 1:return n.sent(),[2,e]}}))}))},e.prototype.getCustomData=function(t){var e=this,n=t.mode,i=t.subType,s=t.data;return new Promise((function(t,o){if(e.version>=2){var r=i===constants.SEND_TOKEN_SUB_TYPE?{cmdType:3,token:s}:{cmdType:4,log:"1"};s=JSON.stringify(r),i=constants.GET_CUSTOM_DATA_V2,n=constants.DATA_MODE,console.log("send data",i,n,s)}s instanceof Int8Array!=!0&&("string"==typeof s?s=byteUtil.getBytesByString(s):Array.isArray(s)&&(s=new Int8Array(s))),e.writeData(e.buildBleData({mode:n,subType:i,data:s})).catch((function(t){o(tslib_1.__assign(tslib_1.__assign({},t),{code:"WRITE_ERROR"}))}));var a=setTimeout((function(){o({code:"TIMEOUT"})}),e.waitCustomDataTimeout),c="";c=e.version<=1?i===constants.SEND_TOKEN_SUB_TYPE?"tokenStateChange":"moduleLogReport":"CustomDataReport";var _=[];e.on(c,(function(e){var n=e.data;if(clearTimeout(a),"14"!==n[1]){_=_.concat(n.slice(4));var i=hex2str(_);try{~i.indexOf("{")?t(JSON.parse(i)):t(i)}catch(t){return o(tslib_1.__assign({code:"ERROR"},t))}}else _=_.concat(n.slice(6))}))}))},e.prototype.getWifiConnectState=function(){var t=this;return new Promise((function(e,n){t.writeData(t.buildBleData({mode:constants.CONTROL_MODE,subType:constants["CONNECT_AP_SUB_TYPE"+(t.version>1?"_V2":"")],data:new Int8Array([])}));var i,s,o=setTimeout((function(){n({code:"TIMEOUT"})}),t.waitWiFiStateTimeout),r=[];t.on("wifiConnectStateChange",(function(t){var a,c=t.data;if(clearTimeout(o),void 0===i){i="14"===c[1].toString();var _=parseInt(c[i?7:5],16);if(_!==constants.CONNECT_WIFI_SUCCESS)return n({code:"ERROR",connectState:_})}if(i&&r.length){var u="14"===c[1].toString()?6:4;a=c.slice(u)}else{u=i?11:9;s=parseInt(c[u-1],16),a=c.length>u?c.slice(u):[]}(r=r.concat(a)).length!==s&&i||e(r)}))}))},e.serviceId="0000FFFF-0000-1000-8000-00805F9B34FB",e.PRODUCT_INITED=!0,e.BLECOMBO_ESP_PRODUCTID="BLECOMBO",e.deviceFilter=function(t){if(t.advertisServiceUUIDs&&t.advertisServiceUUIDs.find((function(t){return e.serviceId===t}))){var n=tslib_1.__assign(tslib_1.__assign({},t),{serviceId:e.serviceId,deviceName:"",productId:e.BLECOMBO_ESP_PRODUCTID});return n.name=n.localName,n}},e}(qcloud_iotexplorer_bluetooth_adapter_1.DeviceAdapter4Mp);exports.BleComboEspDeviceAdapter=BleComboEspDeviceAdapter;
//# sourceMappingURL=BleComboEspDeviceAdapter.js.map