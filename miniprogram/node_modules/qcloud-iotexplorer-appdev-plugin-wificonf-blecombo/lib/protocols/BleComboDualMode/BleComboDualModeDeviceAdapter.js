"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BleComboDualModeDeviceAdapter4H5=exports.BleComboDualModeDeviceAdapter=exports.BleComboDualModeDeviceAdapterBase=void 0;var tslib_1=require("tslib"),BleComboLLSync_1=require("../BleComboLLSync"),qcloud_iotexplorer_bluetooth_adapter_1=require("qcloud-iotexplorer-bluetooth-adapter"),qcloud_iotexplorer_bluetooth_adapter_llsync_1=require("qcloud-iotexplorer-bluetooth-adapter-llsync"),hex2str=qcloud_iotexplorer_bluetooth_adapter_llsync_1.utils.hex2str,REPORT_EVENT_TYPE=qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.REPORT_EVENT_TYPE,arrayBufferToHexStringArray=qcloud_iotexplorer_bluetooth_adapter_1.blueToothHelper.arrayBufferToHexStringArray,DUALMODE_SERVICEID="0000FFE8-65D0-4E20-B56A-E493541BA4E2",DUALMODE_SERVICEID16="0000FFE8-0000-1000-8000-00805F9B34FB",LLSyncDualModeDeviceAdapter=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return tslib_1.__extends(t,e),t.serviceId16=DUALMODE_SERVICEID16,t.serviceId=DUALMODE_SERVICEID,t}(qcloud_iotexplorer_bluetooth_adapter_llsync_1.LLSyncDeviceAdapter),BleComboDualModeDeviceAdapterBase=function(e){function t(t){var o=e.call(this,t)||this;return o._bleDeviceAdapter=new LLSyncDualModeDeviceAdapter(t),o._bleDeviceAdapter.write=o.write.bind(o._bleDeviceAdapter),["PROPERTY_REPORT","CONTROL_REPLY","GET_STATUS","EVENT_REPORT","ACTION_REPLY","BIND_AUTH","CONNECT_AUTH","UNBIND_AUTH","DEVICE_INFO","UPDATE_REPLY","UPDATE_DATA_REPLY","UPDATE_DATA_CHECK_REPLY","MTU_MODULE_CALLBACK","USER_CHECK_TIMEOUT_CALLBACK","REGISTER_DEVICE_INFO_REPLY"].forEach((function(e){o.on(e,(function(){for(var t,r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];console.info("[dualmodeDeviceAdapter] emit "+e+" from dualmode adapter",r),(t=o._bleDeviceAdapter).emit.apply(t,tslib_1.__spread([e],r))}))})),o.on("connect",(function(e){console.info("ble connected",e),o._bleDeviceAdapter._deviceConnected=!0,o._bleDeviceAdapter.emit("connect")})),o.on("disconnect",(function(e){console.info("ble disconnect",e),o._bleDeviceAdapter._deviceConnected=!1,o._bleDeviceAdapter.emit("disconnect")})),o}return tslib_1.__extends(t,e),t.injectOptions=function(e){exports.BleComboDualModeDeviceAdapter.options=e,qcloud_iotexplorer_bluetooth_adapter_llsync_1.LLSyncDeviceAdapter.injectOptions(e)},t.prototype.toString=function(){return"[BleComboDualModeDeviceAdapter]"},Object.defineProperty(t.prototype,"authorized",{get:function(){return this._bleDeviceAdapter.authorized},enumerable:!1,configurable:!0}),t.prototype.authenticateConnection=function(e){return this._bleDeviceAdapter.authenticateConnection(e)},t.prototype.bindDevice=function(e){return this._bleDeviceAdapter.bindDevice(e)},t.prototype.unbindDevice=function(e){return this._bleDeviceAdapter.unbindDevice.call(this._bleDeviceAdapter,e)},t.prototype.controlDevice=function(e){return this._bleDeviceAdapter.controlDevice.call(this._bleDeviceAdapter,e)},t.prototype.init=function(){return this._bleDeviceAdapter.init()},t.serviceId16=DUALMODE_SERVICEID16,t.serviceId=DUALMODE_SERVICEID,t.deviceFilter=function(e,t){var o,r,i;if(!e.advertisServiceUUIDs||!e.advertisServiceUUIDs.find((function(e){return e===exports.BleComboDualModeDeviceAdapter.serviceId16}))||!e.advertisData)return null;try{var l=Math.floor(10*Math.random())%10==1||!0,a=arrayBufferToHexStringArray(e.advertisData);l&&(null===(o=exports.BleComboDualModeDeviceAdapter.options.appDevSdk.reporter)||void 0===o||o.info(REPORT_EVENT_TYPE,{message:"收到广播",serviceId:exports.BleComboDualModeDeviceAdapter.serviceId,hexArr:a.join(",")}));var c=parseInt(a[2],16)-(parseInt(a[2],16)>>2<<2),n=parseInt(a[2],16)>>4,d=t.productId&&t.deviceName?t.productId+"/"+t.deviceName:"",_=d?qcloud_iotexplorer_bluetooth_adapter_llsync_1.utils.get8ByteFromStr(""+d.replace("/","")):"",p=!!d,s="",u="",D="",v=qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_STATE_MAP[c],E=[qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_HAS_BINDED,qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_HAS_CONNECTED].indexOf(v)>-1;if(E)D=a.slice(3,11).join("").toLocaleLowerCase(),u=a.slice(11).join("").toLocaleLowerCase(),s=t.productId;else{var A=a.slice(3,9);e.name&&-1===e.name.indexOf("_")&&(e.name=e.name+"_"+A.slice(0,2).join("")),s=hex2str(a.slice(9))}l&&(null===(r=exports.BleComboDualModeDeviceAdapter.options.appDevSdk.reporter)||void 0===r||r.info(REPORT_EVENT_TYPE,{message:"解析广播",serviceId:exports.BleComboDualModeDeviceAdapter.serviceId,data:{bindState:v||"x",targetDeviceId:d,targetDeviceIdentify:_,deviceUserIdentify:u||"x",deviceProductId:s||"x",deviceIdentify:D||"x"}}));var b=function(){var o=tslib_1.__assign(tslib_1.__assign({},e),{standard:!0,bindState:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_STATE_MAP[v],serviceId:exports.BleComboDualModeDeviceAdapter.serviceId,deviceName:t.deviceName||"",productId:s,extendInfo:{moduleVersion:n}});return console.log("---设备匹配成功---",o),o};return p&&E&&D===_?b():p||E?null:b()}catch(e){console.error("llsync device filter error",e),null===(i=exports.BleComboDualModeDeviceAdapter.options.appDevSdk.reporter)||void 0===i||i.error(REPORT_EVENT_TYPE,{message:"协议广播出错",error:e})}},t}(BleComboLLSync_1.BleComboLLSyncDeviceAdapterBase);exports.BleComboDualModeDeviceAdapterBase=BleComboDualModeDeviceAdapterBase,exports.BleComboDualModeDeviceAdapter=qcloud_iotexplorer_bluetooth_adapter_1.AdapterDeviceAdapter4Mp(BleComboDualModeDeviceAdapterBase),exports.BleComboDualModeDeviceAdapter4H5=qcloud_iotexplorer_bluetooth_adapter_1.AdapterDeviceAdapter4H5(BleComboDualModeDeviceAdapterBase);
//# sourceMappingURL=BleComboDualModeDeviceAdapter.js.map