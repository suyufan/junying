"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BleComboLLSyncDeviceAdapter4H5=exports.BleComboLLSyncDeviceAdapter=exports.BleComboLLSyncDeviceAdapterBase=exports.LLSyncComboConfig=void 0;var tslib_1=require("tslib"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),qcloud_iotexplorer_bluetooth_adapter_1=require("qcloud-iotexplorer-bluetooth-adapter"),qcloud_iotexplorer_bluetooth_adapter_llsync_1=require("qcloud-iotexplorer-bluetooth-adapter-llsync"),constants_1=require("./constants"),hex2str=qcloud_iotexplorer_bluetooth_adapter_llsync_1.utils.hex2str,U16ToHexString=qcloud_iotexplorer_bluetooth_adapter_llsync_1.utils.U16ToHexString,U8ToHexString=qcloud_iotexplorer_bluetooth_adapter_llsync_1.utils.U8ToHexString,arrayBufferToHexStringArray=qcloud_iotexplorer_bluetooth_adapter_1.blueToothHelper.arrayBufferToHexStringArray,byteUtil=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.byteUtil;exports.LLSyncComboConfig={waitGetDeviceInfoTime:1e4,waitSetWiFiModeTime:1e4,waitSetWiFiInfoTime:1e4,waitSetWiFiConnectTime:7e4,waitSetWiFiTokenTime:6e4,waitDevLogInfoTime:1e4};var BleComboLLSyncDeviceAdapterBase=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.reporter={info:function(e,o){var r;void 0===e&&(e=""),void 0===o&&(o={});var _=o.message,n=void 0===_?"":_,l=tslib_1.__rest(o,["message"]),i=t,s=i.explorerDeviceId,a=i.deviceId,c=i.isConnected;null===(r=exports.BleComboLLSyncDeviceAdapter.options)||void 0===r||r.appDevSdk.reporter.info(qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.REPORT_EVENT_TYPE,{serviceId:exports.BleComboLLSyncDeviceAdapter.serviceId,message:n||(e&&qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.ACTION_DESC[e]?e+"("+qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.ACTION_DESC[e]+")":e),timeCost:l.timeCost||0,action:e,data:tslib_1.__assign({deviceId:s,bleDeviceId:a,isConnected:c},l)})},error:function(e,o){var r;void 0===e&&(e=""),void 0===o&&(o={});var _=o.error,n=tslib_1.__rest(o,["error"]),l=t,i=l.explorerDeviceId,s=l.deviceId,a=l.isConnected;_.code&&qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.ERROR_MESSAGES[_.code]&&(_.msg=qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.ERROR_MESSAGES[_.code]),null===(r=exports.BleComboLLSyncDeviceAdapter.options)||void 0===r||r.appDevSdk.reporter.error(qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.REPORT_EVENT_TYPE,{message:e&&qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.ERROR_MESSAGES[e]&&e+"("+qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.ERROR_MESSAGES[e]+"："+(_&&(_.message||_.errMsg||_.msg||_.code))+")",timeCost:n.timeCost||0,action:e,error:_,data:tslib_1.__assign(tslib_1.__assign({deviceId:i,bleDeviceId:s,isConnected:a},n),_)})}},t}return tslib_1.__extends(t,e),t.injectOptions=function(e){exports.BleComboLLSyncDeviceAdapter.options=e},t.prototype.notifyMessage=function(e){var t=void 0===e?{}:e,o=t.type,r=t.data;if("unknown"!==o)return console.log("check this in notifyMessage",this,{type:o,data:r}),this.emit(o,{type:o,data:r})},t.prototype.connectDevice=function(t){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(o){switch(o.label){case 0:return[4,e.prototype.connectDevice.call(this,t)];case 1:return o.sent(),[4,this.afterConnectDevice()];case 2:return o.sent(),[2]}}))}))},t.prototype.afterConnectDevice=function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,t,o,r,_;return tslib_1.__generator(this,(function(n){switch(n.label){case 0:return[4,this.getDeviceInfo()];case 1:if(e=n.sent(),t=e.version,o=e.mtu,r=e.needSetMtu,_=e.deviceName,this.deviceName=_,this.bleVersion=t,this.mtu=Math.max(constants_1.MIN_ATT_MTU,o)-constants_1.ATT_MTU_TO_LLSYNC_MTU_DELTA,this.reporter.info("CONNECT_DEVICE",{data:{version:t,mtu:o,needSetMtu:r,deviceName:_}}),!r)return[3,5];n.label=2;case 2:return n.trys.push([2,4,,5]),[4,this.setMtu(o)];case 3:return n.sent(),this.writeMtuResult("success"),[3,5];case 4:return n.sent(),this.writeMtuResult("fail"),[3,5];case 5:return[2,_]}}))}))},t.prototype.getDeviceInfo=function(){return this.writeAndWait4Response(qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_INFO_WRITE_PREFIX[qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.GET_DEVICE_INFO],qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_INFO,(function(e){if(!e.length)throw{code:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_INFO_INVALID};var t=parseInt(e.slice(2,3).join(""),16),o=parseInt(e.slice(3,5).join(""),16),r=!!(o>>15),_=8191&o,n=parseInt(e[5],16),l=hex2str(e.slice(6).join(""));if(n!==l.length)throw{code:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_INFO_INVALID};return{version:t,mtu:_,needSetMtu:r,deviceName:l}}),{timeout:exports.LLSyncComboConfig.waitGetDeviceInfoTime,timeoutCode:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.WAIT_GET_DEVICE_INFO_TIMEOUT,writeId:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_INFO_WRITE_ID})},t.prototype.setWiFiMode=function(e){void 0===e&&(e=qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.STA_WIFI_MODE);var t=""+qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_INFO_WRITE_PREFIX[qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.SET_WIFI_MODE]+U8ToHexString(qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.WIFI_MODE_MAP[e]);return this.writeAndWait4Response(t,qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.SET_WIFI_MODE_RESULT,(function(e){if(!e.length)throw{code:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.SET_WIFI_MODE_RESULT_INVALID};return!parseInt(e.slice(2,3).join(""),16)}),{timeout:exports.LLSyncComboConfig.waitSetWiFiModeTime,timeoutCode:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.SET_WIFI_MODE_RESULT_TIMEOUT,writeId:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_INFO_WRITE_ID})},t.prototype.setWiFiInfo=function(e){var t=e.ssid,o=e.password,r=byteUtil.hexString2hexArray(byteUtil.byteArrayToHex(byteUtil.getBytesByString(t)))||[],_=byteUtil.hexString2hexArray(byteUtil.byteArrayToHex(byteUtil.getBytesByString(o)))||[];console.log("----data----",{ssid:t,password:o,ssidHexArray:r,passwordHexArray:_});var n=this.sliceData(tslib_1.__spread([qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_INFO_WRITE_PREFIX[qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.SET_WIFI_INFO],U16ToHexString(r.length+_.length),U8ToHexString(r.length)],r,[U8ToHexString(_.length)],_),[tslib_1.__spread([U8ToHexString(r.length)],r),tslib_1.__spread([U8ToHexString(_.length)],_)],qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.SET_WIFI_INFO);return this.writeAndWait4Response(n,qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.SET_WIFI_INFO_RESULT,(function(e){if(!e.length)throw{code:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.SET_WIFI_INFO_RESULT_INVALID};return!parseInt(e.slice(2,3).join(""),16)}),{timeout:exports.LLSyncComboConfig.waitSetWiFiInfoTime,timeoutCode:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.SET_WIFI_INFO_RESULT_TIMEOUT,writeId:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_INFO_WRITE_ID})},t.prototype.sendConnectWiFiAndGetWiFiConnectState=function(){var e=""+qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_INFO_WRITE_PREFIX[qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.SET_WIFI_CONNECT];return this.writeAndWait4Response(e,qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.SET_WIFI_CONNECT_RESULT,(function(e){if(!e.length)throw{code:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.SET_WIFI_CONNECT_RESULT_INVALID};var t=parseInt(e.slice(3,4).join(""),16),o=parseInt(e.slice(5,6).join(""),16),r="";return o&&(r=hex2str(e.slice(6,6+o))),{connected:!t,ssid:r}}),{timeout:exports.LLSyncComboConfig.waitSetWiFiConnectTime,timeoutCode:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.SET_WIFI_CONNECT_RESULT_TIMEOUT,writeId:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_INFO_WRITE_ID})},t.prototype.sendToken=function(e){var t=e.token,o=byteUtil.hexString2hexArray(byteUtil.byteArrayToHex(byteUtil.getBytesByString(t)));console.log("----data----",{token:t,tokenHexArray:o});var r=this.sliceData(tslib_1.__spread([qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_INFO_WRITE_PREFIX[qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.SET_WIFI_TOKEN],U16ToHexString(o.length)],o),[o],qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.SET_WIFI_TOKEN);return this.writeAndWait4Response(r,qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.SET_WIFI_TOKEN_RESULT,(function(e){if(!e.length)throw{code:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.SET_WIFI_TOKEN_RESULT_INVALID};return!parseInt(e.slice(2,3).join(""),16)}),{timeout:exports.LLSyncComboConfig.waitSetWiFiTokenTime,timeoutCode:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.SET_WIFI_TOKEN_RESULT_TIMEOUT,writeId:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_INFO_WRITE_ID})},t.prototype.getModuleLog=function(){var e=""+qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_INFO_WRITE_PREFIX[qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.GET_DEV_LOG];return this.writeAndWait4Response(e,qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.GET_DEV_LOG_INFO,(function(e){if(!e.length)throw{code:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.GET_DEV_LOG_INFO_INVALID};var t=parseInt(e.slice(1,3).join(""),16);return{logStr:hex2str(e.slice(4,4+t))}}),{timeout:exports.LLSyncComboConfig.waitDevLogInfoTime,timeoutCode:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.GET_DEV_LOG_INFO_TIMEOUT,writeId:qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.DEVICE_INFO_WRITE_ID})},t.options=null,t.serviceId16="0000FFF0-0000-1000-8000-00805F9B34FB",t.serviceId="0000FFF0-65D0-4E20-B56A-E493541BA4E2",t.deviceFilter=function(e){var t,o,r;if(!e.advertisServiceUUIDs||!e.advertisServiceUUIDs.find((function(e){return e===exports.BleComboLLSyncDeviceAdapter.serviceId16}))||!e.advertisData)return null;try{var _=Math.floor(10*Math.random())%10==1||!0,n=arrayBufferToHexStringArray(e.advertisData);_&&(null===(t=exports.BleComboLLSyncDeviceAdapter.options)||void 0===t||t.appDevSdk.reporter.info(qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.REPORT_EVENT_TYPE,{message:"收到广播",serviceId:exports.BleComboLLSyncDeviceAdapter.serviceId,hexArr:n.join(",")}));var l,i=parseInt(n[2],16)>>4,s=n.slice(3,9),a=e.localName||e.name;return a&&-1===a.indexOf("_")&&(a=a+"_"+s.slice(0,2).join("")),l=hex2str(n.slice(9)),_&&(null===(o=exports.BleComboLLSyncDeviceAdapter.options)||void 0===o||o.appDevSdk.reporter.info(qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.REPORT_EVENT_TYPE,{message:"解析广播",serviceId:exports.BleComboLLSyncDeviceAdapter.serviceId,data:{deviceProductId:l||"x"}})),tslib_1.__assign(tslib_1.__assign({},e),{standardBleCombo:!0,serviceId:exports.BleComboLLSyncDeviceAdapter.serviceId,deviceName:"",productId:l,extendInfo:{moduleVersion:i},name:a})}catch(e){null===(r=exports.BleComboLLSyncDeviceAdapter.options)||void 0===r||r.appDevSdk.reporter.error(qcloud_iotexplorer_bluetooth_adapter_llsync_1.constants.REPORT_EVENT_TYPE,{message:"协议广播出错",error:e})}},t}(qcloud_iotexplorer_bluetooth_adapter_llsync_1.LLSyncDeviceAdapterBase);exports.BleComboLLSyncDeviceAdapterBase=BleComboLLSyncDeviceAdapterBase,exports.BleComboLLSyncDeviceAdapter=qcloud_iotexplorer_bluetooth_adapter_1.AdapterDeviceAdapter4Mp(BleComboLLSyncDeviceAdapterBase),exports.BleComboLLSyncDeviceAdapter4H5=qcloud_iotexplorer_bluetooth_adapter_1.AdapterDeviceAdapter4H5(BleComboLLSyncDeviceAdapterBase);
//# sourceMappingURL=BleComboLLSyncDeviceAdapter.js.map