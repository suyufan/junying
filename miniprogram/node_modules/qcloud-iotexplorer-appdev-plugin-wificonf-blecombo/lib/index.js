"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),iotexplorer_ui_dev_config_1=require("iotexplorer-ui-dev-config"),qcloud_iotexplorer_appdev_plugin_wificonf_core_1=require("qcloud-iotexplorer-appdev-plugin-wificonf-core"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),protocols_1=require("./protocols"),delay=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.delay,WifiConfStepCode=qcloud_iotexplorer_appdev_plugin_wificonf_core_1.constants.WifiConfStepCode,WifiConfStepDesp=qcloud_iotexplorer_appdev_plugin_wificonf_core_1.constants.WifiConfStepDesp,WifiConfErrorMsg=qcloud_iotexplorer_appdev_plugin_wificonf_core_1.constants.WifiConfErrorMsg,protocols_2=require("./protocols");Object.defineProperty(exports,"BleComboDualModeDeviceAdapter",{enumerable:!0,get:function(){return protocols_2.BleComboDualModeDeviceAdapter}}),Object.defineProperty(exports,"BleComboDualModeDeviceAdapter4H5",{enumerable:!0,get:function(){return protocols_2.BleComboDualModeDeviceAdapter4H5}}),Object.defineProperty(exports,"BleComboEspDeviceAdapter",{enumerable:!0,get:function(){return protocols_2.BleComboEspDeviceAdapter}}),Object.defineProperty(exports,"BleComboLLSyncDeviceAdapter",{enumerable:!0,get:function(){return protocols_2.BleComboLLSyncDeviceAdapter}});var getBleComboProtoHandler=function(e){switch(e.wifiConfType){case iotexplorer_ui_dev_config_1.WifiConfType.BLEComboEsp:return new protocols_1.BleComboEspTask(e);case iotexplorer_ui_dev_config_1.WifiConfType.BLEComboLLSync:case iotexplorer_ui_dev_config_1.WifiConfType.DualMode:return new protocols_1.BleComboLLSyncTask(e);default:console.warn("没有找到 wifiConfType 对应的 bleComboHandler:",e.wifiConfType)}},BleComboPlugin=function(){function e(){}return e.install=function(e){e.plugins.wifiConfBleCombo={start:function(o){return tslib_1.__awaiter(this,void 0,void 0,(function(){var r,t,i,n,s,d,c,_,l,a,p,f,u,C,b,S,v,T,E=this;return tslib_1.__generator(this,(function(m){switch(m.label){case 0:r=o.onError,t=o.onProgress,i=o.onComplete,n=o.wifiConfToken,s=o.familyId,d=o.roomId,c=void 0===d?"":d,_=function(e){return void 0===e&&(e=1e3),tslib_1.__awaiter(E,void 0,void 0,(function(){return tslib_1.__generator(this,(function(o){switch(o.label){case 0:return[4,delay(e)];case 1:return o.sent(),[2]}}))}))},t({code:WifiConfStepCode.PROTOCOL_START,reportEvents:["配网","发送wifi"]}),m.label=1;case 1:m.trys.push([1,22,,23]),l=Date.now(),a=getBleComboProtoHandler(tslib_1.__assign(tslib_1.__assign({},o),{reporter:{info:function(e,o){void 0===o&&(o={}),t({code:WifiConfStepCode.PROTOCOL_DETAIL,detail:{message:WifiConfStepCode.PROTOCOL_DETAIL+"("+WifiConfStepDesp[WifiConfStepCode.PROTOCOL_DETAIL]+": "+e+")",data:o}})},error:function(e){r({code:"PROTOCOL_FAIL",detail:{error:e}})}}})),m.label=2;case 2:return m.trys.push([2,4,,5]),[4,a.start()];case 3:return m.sent(),[3,5];case 4:throw p=m.sent(),console.error(p),tslib_1.__assign({code:"PROTOCOL_FAIL"},p);case 5:return t({code:WifiConfStepCode.PROTOCOL_SUCCESS,detail:{timeCost:Date.now()-l},reportEvents:["发送wifi"]}),[4,_()];case 6:m.sent(),t({code:WifiConfStepCode.BUSINESS_START}),t({code:"BLE_SEND_TOKEN_START",detail:{data:{wifiConfToken:n}},reportEvents:["bleSendToken"]}),f=Date.now(),u=void 0,m.label=7;case 7:return m.trys.push([7,9,,10]),[4,a.sendToken()];case 8:return u=m.sent(),[3,10];case 9:throw C=m.sent(),tslib_1.__assign({code:"BLE_SEND_TOKEN_ERROR"},C);case 10:return[4,t({code:"BLE_SEND_TOKEN_SUCCESS",detail:{timeCost:Date.now()-f,response:u},reportEvents:["bleSendToken"]})];case 11:if(m.sent(),b=u.productId,S=u.deviceName,o.wifiConfType!==iotexplorer_ui_dev_config_1.WifiConfType.DualMode)return[3,17];m.label=12;case 12:return m.trys.push([12,15,,16]),[4,qcloud_iotexplorer_appdev_plugin_wificonf_core_1.queryTokenStateAndBind({token:o.wifiConfToken,productId:b,deviceName:S,familyId:s,roomId:c,onProgress:t,sdk:e,skipBind:!0,newTokenVersion:!1})];case 13:return m.sent(),[4,o.deviceAdapter.bindDevice({familyId:s,roomId:c})];case 14:return m.sent(),[3,16];case 15:throw v=m.sent(),tslib_1.__assign({code:"BLE_BIND_DEVICE_ERROR"},v);case 16:return[3,19];case 17:return[4,qcloud_iotexplorer_appdev_plugin_wificonf_core_1.queryTokenStateAndBind({token:o.wifiConfToken,productId:b,deviceName:S,familyId:s,roomId:c,onProgress:t,sdk:e,newTokenVersion:o.newTokenVersion})];case 18:m.sent(),m.label=19;case 19:return[4,t({code:WifiConfStepCode.BUSINESS_QUERY_TOKEN_STATE_SUCCESS,detail:{timeCost:Date.now()-f,response:u}})];case 20:return m.sent(),[4,_()];case 21:return m.sent(),i({productId:b,deviceName:S}),a.interrupt(),t({code:WifiConfStepCode.WIFI_CONF_SUCCESS,detail:{timeCost:Date.now()-l},reportEvents:["配网"]}),[3,23];case 22:return(T=m.sent())&&T.code in WifiConfErrorMsg&&(T.uiMsg=WifiConfErrorMsg[T.code]),t({code:WifiConfStepCode.WIFI_CONF_FAIL,detail:{error:T}}),r({code:WifiConfStepCode.WIFI_CONF_FAIL,detail:{error:T}}),[3,23];case 23:return[2]}}))}))}}},e}();exports.default=BleComboPlugin;
//# sourceMappingURL=index.js.map