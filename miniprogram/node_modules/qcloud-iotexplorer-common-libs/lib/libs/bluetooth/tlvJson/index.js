"use strict";var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.sliceData=exports.getTlvDataParser=exports.TlvDataTypeIndexMap=exports.convertActionOutputTlvToJsObject=exports.convertEventTlvToJsObject=exports.eventTlvData=exports.convertPropertiesChangeToTlv=exports.convertActionControlToTlv=exports.convertPropertiesTlvToJsObject=exports.tlvHex=exports.stringToTlv=exports.genHead=exports.getTypeHead=exports.getTypeIndexFromHead=exports.getTypeFromHead=exports.getStrLength=void 0;var tslib_1=require("tslib"),qcloud_iotexplorer_appdev_sdk_1=require("qcloud-iotexplorer-appdev-sdk"),constants=tslib_1.__importStar(require("./constants")),utils_1=require("../../../utils"),byteUtil=qcloud_iotexplorer_appdev_sdk_1.AppDevSdk.utils.byteUtil;exports.getStrLength=function(t){return parseInt(t.slice(0,2).join(""),16)},exports.getTypeFromHead=function(t){return parseInt(t,16)>>5},exports.getTypeIndexFromHead=function(t){return 31&parseInt(t,16)},exports.getTypeHead=function(t,e){return"string"==typeof t&&(t=parseInt(t,2)),"string"==typeof e&&(e=parseInt(e,2)),byteUtil.byteToHex(t<<5|31&e)},exports.genHead=function(t,e){var n=constants.TLV_TYPE_INDEX[t];return byteUtil.byteToHex(n<<5|31&e)},exports.stringToTlv=function(t){var e=""+utils_1.U16ToHexString(t.length)+byteUtil.byteArrayToHex(byteUtil.stringToByteArray(t));return byteUtil.hexString2hexArray(e)||[""]};var parseTlv=function(t){var e,n=t.type,o=t.tlvHex,a=t.hexIndex,r=t.needResolveType,s=void 0===r||r,T=constants.TLV_TYPE_LENGTH,l=constants.BLE_IOT_DATA_TYPE_BOOL,_=constants.BLE_IOT_DATA_TYPE_INT,c=constants.BLE_IOT_DATA_TYPE_ENUM,p=constants.BLE_IOT_DATA_TYPE_FLOAT,i=constants.BLE_IOT_DATA_TYPE_TIME,v=constants.BLE_IOT_DATA_TYPE_STRING,x=constants.BLE_IOT_DATA_TYPE_STRUCT,d=constants.BLE_IOT_DATA_TYPE_ARRAY;switch(s&&++a,n){case l:e=parseInt(o[a],16),a++;break;case i:case c:e=parseInt(o.slice(a,a+=T[n]).join(""),16);break;case p:e=parseFloat(""+byteUtil.hexArray2Float32(o.slice(a,a+=T[n]),3));break;case _:e=byteUtil.hex2Int32(o.slice(a,a+=T[n]));break;case v:var u=o.slice(a),I=exports.getStrLength(u);a+=2,u=o.slice(a,a+=I),e=utils_1.hex2str(u);break;case d:case x:u=o.slice(a),I=exports.getStrLength(u);a+=2,e=u=o.slice(a,a+=I)}return{hexIndex:a,value:e}},loopParseTlv=function(t,e,n,o){void 0===n&&(n=0),void 0===o&&(o=!1);for(var a={},r=n;r<e.length;){var s=exports.getTypeFromHead(e[r]),T=t[exports.getTypeIndexFromHead(e[r])];if(!T)throw{code:"ID_TEMPLATE_IS_NOT_EXIT"};var l=o?T.dataType.type:T.define.type;if(console.log("---type---",s,constants.TLV_TYPE_INDEX[l]),s!==constants.TLV_TYPE_INDEX[l])throw{code:"TYPE_IN_MODULE_IS_WRONG"};var _=parseTlv({type:l,tlvHex:e,hexIndex:r});if(r=_.hexIndex,l===constants.BLE_IOT_DATA_TYPE_ARRAY){for(var c=_.value||[],p=[],i=T.define.arrayInfo.type,v=0;v<c.length;){var x=parseTlv({type:i,tlvHex:c,hexIndex:v,needResolveType:!1}),d=x.hexIndex,u=x.value;v=d,i===constants.BLE_IOT_DATA_TYPE_STRUCT?p.push(loopParseTlv(T.define.arrayInfo.specs,u,0,!0)):p.push(u)}console.log("ARRAY",T,_,p),a[T.id]=p}else l===constants.BLE_IOT_DATA_TYPE_STRUCT?(console.log("STRUCT",T.define.specs,_.value),a[T.id]=loopParseTlv(T.define.specs,_.value,0,!0)):a[T.id]=_.value}return a},getIndexMap=function(t){var e={};return t.map((function(t,n){e[t.id]=n})),e},convertToTlv=function(t){var e=t.type,n=t.typeIndex,o=void 0===n?0:n,a=t.value,r=t.templateConfig,s=void 0===r?{}:r,T=t.needGenHead,l=void 0===T||T,_=constants.BLE_IOT_DATA_TYPE_BOOL,c=constants.BLE_IOT_DATA_TYPE_INT,p=constants.BLE_IOT_DATA_TYPE_ENUM,i=constants.BLE_IOT_DATA_TYPE_FLOAT,v=constants.BLE_IOT_DATA_TYPE_TIME,x=constants.BLE_IOT_DATA_TYPE_STRING,d=constants.BLE_IOT_DATA_TYPE_STRUCT,u=constants.BLE_IOT_DATA_TYPE_ARRAY,I=byteUtil.hexString2hexArray,E=byteUtil.int32ToHex,A=byteUtil.byteToHex,y=byteUtil.convertNumberToByte,g=[];switch(e){case _:g=[A(y(a))];break;case v:case c:g=I(E(a))||[""];break;case p:g=I(utils_1.U16ToHexString(a))||[""];break;case i:g=byteUtil.float32ToHexArray(parseFloat(a))||[""];break;case x:g=exports.stringToTlv(a);break;case d:var P=getIndexMap(s),D=loopConvertToTlv(a,P,s,!0).tlvData,O=D.length;g=tslib_1.__spread(byteUtil.hexString2hexArray(utils_1.U16ToHexString(O)),D);break;case u:var f=s[0],h=a;f&&Array.isArray(h)&&h.forEach((function(t){var e=convertToTlv({type:f.type,value:t,needGenHead:!1,templateConfig:f.type===d?f.specs:{}});g.push.apply(g,tslib_1.__spread(e))})),g=tslib_1.__spread(byteUtil.hexString2hexArray(utils_1.U16ToHexString(g.length)),g)}return l&&g.unshift(exports.genHead(e,o)),tslib_1.__spread(g)},loopConvertToTlv=function(t,e,n,o){void 0===o&&(o=!1);var a=[];Object.keys(t).forEach((function(r){var s=e[r],T=n[s]&&(o?n[s].dataType:n[s].define),l=null==T?void 0:T.type;if(!l)throw{code:"TEMPLATE_NOT_MATCH",detail:{jsObj:t,templateConfig:n}};var _=void 0;switch(l){case constants.BLE_IOT_DATA_TYPE_ARRAY:_=[n[s].define.arrayInfo];break;case constants.BLE_IOT_DATA_TYPE_STRUCT:_=n[s].define.specs;break;default:_={}}a[s]=convertToTlv({type:l,typeIndex:s,value:t[r],templateConfig:_})}));var r=[];return a.map((function(t){(null==t?void 0:t.length)&&r.push.apply(r,tslib_1.__spread(t))})),console.log("---tlvData---",r),{tlvData:r,tmpData:a}};exports.tlvHex=["00","00","81","00","00","22","00","00","00","00","43","00","0C","64","65","66","61","75","6C","74","20","6E","61","6D","65"],exports.convertPropertiesTlvToJsObject=function(t,e){var n=constants.TEMPLATE_PROPERTY;console.log("---tlvHex--",t);var o=e[n];if(!o)throw{code:"NO_SUCH_MODE_FOR_THIS_PRODUCT"};return loopParseTlv(o,t)},exports.convertActionControlToTlv=function(t,e){console.log("---convertActionControlToTlv--",t);var n=e[constants.TEMPLATE_ACTIONS],o=getIndexMap(n)[t.actionId],a=n[o],r=t.params,s=getIndexMap(a.input);console.log("---jsObj--",r,s);var T=loopConvertToTlv(r,s,a.input);return{actionIndex:o,tlvData:T.tlvData,tmpData:T.tmpData}},exports.convertPropertiesChangeToTlv=function(t,e){var n=constants.TEMPLATE_PROPERTY;console.log("---jsObj--",t,e);var o=e[n],a=getIndexMap(o),r=loopConvertToTlv(t,a,o),s=r.tlvData,T=r.tmpData;return console.warn("---tlvData---",s),console.warn("---tmpData---",T),{tlvData:s,tmpData:T}},exports.eventTlvData=["01","60","00","00","80","3F"],exports.convertEventTlvToJsObject=function(t,e){var n=constants.TEMPLATE_EVENTS,o=parseInt(t[0],16),a=e[n][o];if(!a)throw{code:"NO_SUCH_MODE_FOR_THIS_PRODUCT"};var r=loopParseTlv(a.params,t,1);return{eventId:a.id,eventIndex:o,params:r}},exports.convertActionOutputTlvToJsObject=function(t,e){var n=parseInt(t[0],16),o=e[constants.TEMPLATE_ACTIONS][n];if(!o)throw{code:"NO_SUCH_MODE_FOR_THIS_PRODUCT"};var a=loopParseTlv(o.output,t,1);return{actionId:o.id,actionIndex:n,outputParams:a}},exports.TlvDataTypeIndexMap=((_a={})[constants.PROPERTY_REPORT]=2,_a[constants.EVENT_REPORT]=3,_a[constants.ACTION_REPLY]=4,_a.default=2,_a),exports.getTlvDataParser=function(t){void 0===t&&(t="default");var e=[];return function(n){console.log("----data----",n);var o=exports.getStrLength(n),a=o>>14,r=o>>13&1,s=constants.SPLIT_MAP[a];switch(console.log(a,s,t),s){case constants.SPLIT_FIRST:return e=tslib_1.__spread(n.slice(2)),null;case constants.SPLIT_MIDDLE:return e=e.concat(n.slice(void 0!==exports.TlvDataTypeIndexMap[t]?exports.TlvDataTypeIndexMap[t]:2)),null;case constants.SPLIT_LAST:return(e=e.concat(n.slice(void 0!==exports.TlvDataTypeIndexMap[t]?exports.TlvDataTypeIndexMap[t]:2))).splice.apply(e,tslib_1.__spread([0,0],byteUtil.hexString2hexArray(utils_1.U16ToHexString(r<<15|e.length))||[])),console.log("----completeData---",e),e;case constants.NOT_SPLIT:return n}}},exports.sliceData=function(t,e){var n=e.head,o=e.mtu,a=(e.mode,[]),r=[],s=o-n.length-2;return t.forEach((function(t){if(t.length<s)r.push(t);else for(var e=0;e<t.length;e+=s)r.push(t.slice(e,e+s))})),r.forEach((function(t,e){var o,s=n.join("");o=0===e?constants.SPLIT_INDEX_MAP[constants.SPLIT_FIRST]:e===r.length-1?constants.SPLIT_INDEX_MAP[constants.SPLIT_LAST]:constants.SPLIT_INDEX_MAP[constants.SPLIT_MIDDLE],s+=utils_1.U16ToHexString(o<<14|t.length),s+=t.join(""),a.push(s)})),a};
//# sourceMappingURL=index.js.map